<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <title>ç”Ÿå†™çœŸç®¡ç†For=Love</title>

  <!-- PWA: ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="theme-color" content="#2196f3" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- SortableJS (ã‚¹ãƒãƒ›æœ€é©åŒ–ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <link rel="stylesheet" href="style.css" />
  
  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC183tcN__mG5zNx2FG__9g3zkZWpszJ_k",
    authDomain: "picturemanager-f139d.firebaseapp.com",
    projectId: "picturemanager-f139d",
    storageBucket: "picturemanager-f139d.firebasestorage.app",
    messagingSenderId: "893316957167",
    appId: "1:893316957167:web:1cddf45fd9fd0e9145ac1a"
  };
  const app = initializeApp(firebaseConfig);
  window.fb = {
    db: getFirestore(app),
    auth: getAuth(app),
    provider: new GoogleAuthProvider(),
    doc, setDoc, signInWithPopup, signOut, onAuthStateChanged, getDoc,
    collection, addDoc, query, where, getDocs, deleteDoc
  };
</script>

<!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ² (PWA) -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('ServiceWorker registered:', reg))
        .catch(err => console.error('ServiceWorker error:', err));
    });
  }
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useCallback, useMemo, useRef } = React;
const STORAGE_KEY = "photocard_inventory_v4_manage_drag";
const genId = () => 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
const genShareId = () => 'share_' + Math.random().toString(36).substr(2, 9);
const SOURCE_OPTIONS = ["å…¥æ‰‹å…ˆ", "ãƒ¡ãƒ«ã‚«ãƒª", "è‡ªå¼•ã", "åº—èˆ—", "è­²æ¸¡", "ãã®ä»–"];
const DEFAULT_GROUPS = [{ name: "=Love", members: ["å¤§è°·æ˜ ç¾é‡Œ"] }];
const AVAILABLE_TEMPLATES = ['template.csv','template1.csv','template2.csv','template3.csv','template4.csv','template5.csv'];

const formatWithComma = (val) => val ? val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "";

function parseCSV(text, delimiter = '\t') {
  if (!text) return [];
  const rows = []; let row = []; let field = ''; let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i+1];
    if (inQuotes) {
      if (c === '"' && next === '"') { field += '"'; i++; }
      else if (c === '"') inQuotes = false;
      else field += c;
    } else {
      if (c === '"') inQuotes = true;
      else if (c === delimiter) { row.push(field.trim()); field = ''; }
      else if (c === '\n' || c === '\r') {
        if (field || row.length) { row.push(field.trim()); rows.push(row); }
        row = []; field = '';
        if (c === '\r' && next === '\n') i++;
      } else field += c;
    }
  }
  if (field || row.length) { row.push(field.trim()); rows.push(row); }
  return rows;
}

const parseTabCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
  if (!row || row.length < 2) return null;
  const now = Date.now();
  const thumbnail = row[0] || "";
  const name = row[1] || "åç§°ãªã—";
  let otherImages = [];
  if (row.length > 2 && row[2]) {
    const imagesText = row[2].replace(/"/g, '').trim();
    if (imagesText) otherImages = imagesText.split(/\r?\n/).map(u => u.trim()).filter(Boolean);
  }
  return {
    id: genId(), group: selectedGroup, member: selectedMember, name, thumbnail, otherImages,
    yori:0, chuu:0, hiki:0, syori:0, schuu:0, shiki:0, memo:"", price:"", source:"å…¥æ‰‹å…ˆ", isWish:false,
    tags: [],
    createdAt: now - index, order: index
  };
};

const parseCommaCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
  if (!row || row.length < 2) return null;
  const now = Date.now();
  if (row.length < 10) {
    return {
      id: genId(), group: selectedGroup, member: selectedMember,
      name: row[1] || "åç§°ãªã—", thumbnail: row[0] || "",
      otherImages: row[2] ? row[2].split(/[\n ]+/) : [],
      yori:0, chuu:0, hiki:0, syori:0, schuu:0, shiki:0, memo:"", price:"", source:"å…¥æ‰‹å…ˆ", isWish:false,
      tags: [],
      createdAt: now - index, order: index
    };
  } else {
    return {
      id: genId(), group: row[0] || selectedGroup, member: row[1] || selectedMember,
      name: row[2] || "åç§°ãªã—", thumbnail: row[7] || "",
      otherImages: row[11] ? row[11].split("|") : [],
      yori: parseInt(row[3]) || 0, chuu: parseInt(row[4]) || 0, hiki: parseInt(row[5]) || 0,
      syori: parseInt(row[12]) || 0, schuu: parseInt(row[13]) || 0, shiki: parseInt(row[14]) || 0,
      memo: row[6] || "", price: (row[8] || "").slice(0,9), source: row[9] || "å…¥æ‰‹å…ˆ",
      isWish: row[10] === "1", tags: [],
      createdAt: now - index, order: index
    };
  }
};

const compressImage = (file, maxWidth = 500) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const scale = Math.min(maxWidth / img.width, 1);
        canvas.width = img.width * scale; canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.onerror = () => resolve("");
    };
  });
};

function App() {
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);
  const [availableTemplates, setAvailableTemplates] = useState([]);
  const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem("dark_mode") === "true");
  const [appWidth, setAppWidth] = useState(() => localStorage.getItem("app_width") || "600px");
  
  const [groups, setGroups] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { const p = JSON.parse(saved); return (Array.isArray(p.groups) && p.groups.length) ? p.groups : DEFAULT_GROUPS; }
    return DEFAULT_GROUPS;
  });
  const [items, setItems] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { const p = JSON.parse(saved); if (Array.isArray(p.items)) return p.items.map((item, index) => ({ ...item, order: item.order !== undefined ? item.order : index, tags: item.tags || [] })); }
    return [];
  });
  const [selectedGroup, setSelectedGroup] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { const p = JSON.parse(saved); if (Array.isArray(p.groups) && p.groups.length) return p.groups[0].name; }
    return "=Love";
  });
  const [selectedMember, setSelectedMember] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { const p = JSON.parse(saved); if (Array.isArray(p.groups) && p.groups.length && p.groups[0].members.length) return p.groups[0].members[0]; }
    return "å¤§è°·æ˜ ç¾é‡Œ";
  });
  const [showOnlyWish, setShowOnlyWish] = useState(false);
  const [search, setSearch] = useState("");
  const [sortBy, setSortBy] = useState("new");
  const [activeModal, setActiveModal] = useState(null);
  const [editItemId, setEditItemId] = useState(null);
  const [editingNameId, setEditingNameId] = useState(null);
  const [targetName, setTargetName] = useState("");
  const [targetId, setTargetId] = useState(null);
  const [errorMsg, setErrorMsg] = useState("");
  const [isManageMode, setIsManageMode] = useState(false);
  const [viewer, setViewer] = useState(null);
  const [tempImages, setTempImages] = useState([]);
  const [tempMainUrl, setTempMainUrl] = useState("");
  const [selectedItemIds, setSelectedItemIds] = useState([]);
  const [expandedSignItems, setExpandedSignItems] = useState([]);
  const [messageTimeout, setMessageTimeout] = useState(null);
  // â‘ ã‚¿ã‚°æ©Ÿèƒ½ç”¨ã®çŠ¶æ…‹ï¼ˆç·¨é›†ä¸­ã®ã‚¿ã‚°ï¼‰
  const [editingTagId, setEditingTagId] = useState(null);
  const [tempTagInput, setTempTagInput] = useState("");
  
  // â‘¨å…±æœ‰æ©Ÿèƒ½é–¢é€£
  const [shareLists, setShareLists] = useState([]); // è‡ªåˆ†ã®å…±æœ‰ãƒªã‚¹ãƒˆä¸€è¦§
  const [viewingShareId, setViewingShareId] = useState(null); // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
  const [sharedItems, setSharedItems] = useState([]); // å…±æœ‰ãƒ“ãƒ¥ãƒ¼ã§è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ 
  const [shareOwner, setShareOwner] = useState(null); // å…±æœ‰ãƒªã‚¹ãƒˆã®æ‰€æœ‰è€…
  const [shareListName, setShareListName] = useState("");
  const [requests, setRequests] = useState([]); // å—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§
  
  // Sortableç”¨ã®ref
  const listContainerRef = useRef(null);
  const sortableInstance = useRef(null);

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰shareIdã‚’èª­ã¿å–ã‚Š
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const shareId = params.get('share');
    if (shareId) {
      setViewingShareId(shareId);
      loadSharedList(shareId);
    }
  }, []);

  const showError = useCallback((msg) => {
    if (messageTimeout) clearTimeout(messageTimeout);
    setErrorMsg(msg);
    const duration = msg.includes("ã‚¯ãƒ©ã‚¦ãƒ‰") ? 2000 : 3000;
    setMessageTimeout(setTimeout(() => setErrorMsg(""), duration));
  }, [messageTimeout]);

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
  const checkTemplateFiles = useCallback(async () => {
    const existing = [];
    for (const name of AVAILABLE_TEMPLATES) {
      try { const res = await fetch(name, { method: 'HEAD' }); if (res.ok) existing.push(name); }
      catch { console.log(name + " ã¯å­˜åœ¨ã—ã¾ã›ã‚“"); }
    }
    setAvailableTemplates(existing);
  }, []);

  // Firebaseãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹
  useEffect(() => {
    if (!window.fb) { setIsAuthReady(true); return; }
    const unsubscribe = window.fb.onAuthStateChanged(window.fb.auth, async (currentUser) => {
      setUser(currentUser);
      setIsAuthReady(true);
      if (currentUser) {
        await loadFromFirestore(currentUser.uid);
        loadShareLists(currentUser.uid);
        loadRequests(currentUser.uid);
      }
      checkTemplateFiles();
    });
    return () => unsubscribe();
  }, [checkTemplateFiles]);

  // è‡ªåˆ†ã®å…±æœ‰ãƒªã‚¹ãƒˆä¸€è¦§ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿
  const loadShareLists = async (uid) => {
    try {
      const q = window.fb.query(window.fb.collection(window.fb.db, "shares"), window.fb.where("ownerId", "==", uid));
      const snapshot = await window.fb.getDocs(q);
      const lists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setShareLists(lists);
    } catch (e) {
      console.error("å…±æœ‰ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    }
  };

  // å—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
  const loadRequests = async (uid) => {
    try {
      const q = window.fb.query(window.fb.collection(window.fb.db, "requests"), window.fb.where("ownerId", "==", uid));
      const snapshot = await window.fb.getDocs(q);
      const reqs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setRequests(reqs);
    } catch (e) {
      console.error("ãƒªã‚¯ã‚¨ã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    }
  };

  // å…±æœ‰ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
  const createShareList = async (listName, itemIds) => {
    if (!user) return;
    const shareId = genShareId();
    const shareData = {
      ownerId: user.uid,
      listName: listName || "ç„¡é¡Œã®ãƒªã‚¹ãƒˆ",
      itemIds: itemIds,
      createdAt: new Date().toISOString(),
    };
    try {
      await window.fb.setDoc(window.fb.doc(window.fb.db, "shares", shareId), shareData);
      showError("å…±æœ‰ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ");
      loadShareLists(user.uid);
      return shareId;
    } catch (e) {
      showError("ä½œæˆå¤±æ•—: " + e.message);
    }
  };

  // å…±æœ‰ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆå…¬é–‹ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
  const loadSharedList = async (shareId) => {
    try {
      const docRef = window.fb.doc(window.fb.db, "shares", shareId);
      const snap = await window.fb.getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        setShareOwner(data.ownerId);
        setShareListName(data.listName || "å…±æœ‰ãƒªã‚¹ãƒˆ");
        // ã‚¢ã‚¤ãƒ†ãƒ ã¯å…¨ä»¶ã‹ã‚‰è©²å½“IDã®ã‚‚ã®ã‚’æŠ½å‡ºï¼ˆå…¬é–‹æ™‚ã¯å…¨ä»¶æ¸¡ã™ï¼Ÿã“ã“ã§ã¯å…¨ä»¶ã‚’æƒ³å®šï¼‰
        // å®Ÿéš›ã«ã¯ owner ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ç°¡æ˜“çš„ã« itemIds ã®ã¿ä¿æŒ
        // ã‚ˆã‚Šæ­£ç¢ºã«ã¯ owner ã® items ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç°¡ç•¥åŒ–
        // â†’ äº‹å‰ã« owner ãŒ items ã‚’ä¿å­˜ã—ã¦ã„ã‚‹æƒ³å®šã¯ã—ãªã„ã€‚ã“ã“ã§ã¯ items ã¯ owner ã®å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’åˆ¥é€”å–å¾—ï¼Ÿ
        // ç°¡æ˜“ç‰ˆï¼šitemIds ã ã‘æŒã£ã¦ã„ã¦ã€ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã¯åˆ¥é€”å–å¾—ã—ãªã„ï¼ˆè¡¨ç¤ºã§ããªã„ï¼‰
        // æœ¬æ ¼å®Ÿè£…ã«ã¯ owner ã® items ãŒå¿…è¦ã ãŒã€ä»Šå›ã¯ãƒ‡ãƒ¢ã¨ã—ã¦ itemIds ã®ã¿è¡¨ç¤ºã™ã‚‹ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ã«ç•™ã‚ã‚‹ã€‚
        // ã¾ãŸã¯ã€å…±æœ‰ãƒªã‚¹ãƒˆä½œæˆæ™‚ã«ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹æ–¹å¼ã‚‚ã€‚
        // ã“ã“ã§ã¯ã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°æƒ…å ±ã‚‚ä¸€ç·’ã«ä¿å­˜ã™ã‚‹ç°¡æ˜“æ–¹å¼ã‚’å–ã‚‹ï¼ˆã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ãŒãƒ‡ãƒ¢ç”¨ï¼‰
        // å®Ÿéš›ã¯ itemIds ã ã‘æŒã¡ã€è¡¨ç¤ºæ™‚ã« owner ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã™ã‚‹ã®ãŒç†æƒ³ã€‚
        // ã—ã‹ã— Firebase ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«å…¬é–‹å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚
        // ä»Šå›ã¯ã€Œå…¬é–‹ãƒªã‚¹ãƒˆã€ã¨ã—ã¦ç‹¬ç«‹ã—ãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã‚‚ä¿å­˜ã™ã‚‹ã€‚
        // â†’ ã¤ã¾ã‚Š shareList ã« items é…åˆ—ã‚’ä¿å­˜ã™ã‚‹æ–¹å¼ã«å¤‰æ›´ã€‚
        // ã—ã‹ã—ã“ã‚Œã ã¨ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°æ™‚ã«åæ˜ ã•ã‚Œãªã„ã€‚Amazonã®ã»ã—ã„ç‰©ãƒªã‚¹ãƒˆã®ã‚ˆã†ã«ã€Œå…±æœ‰æ™‚ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã¨ã„ã†å‰²ã‚Šåˆ‡ã‚Šã€‚
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã« itemIds ã ã‘æŒã¡ã€è¡¨ç¤ºã§ããªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã« items ã‚’åˆ¥é€”ä¿å­˜ã™ã‚‹æ–¹å¼ã«å¤‰æ›´ã™ã‚‹ã€‚
        // å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€createæ™‚ã« items ã‚’è¤‡è£½ã—ã¦ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ä»Šå›ã¯ãã®æ–¹é‡ã§å®Ÿè£…ã€‚
        // ä¸Šè¨˜ã® createShareList ã§ã¯ itemIds ã ã‘ã ã£ãŸã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã‚‚ä¿å­˜ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
        // ä¸€æ—¦ã“ã“ã§ã¯ã€å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ items ã‚’ä¿å­˜ã—ã¦ã„ã‚‹å‰æã§é€²ã‚ã‚‹ã€‚
        // æœ¬æ¥ã¯ create æ™‚ã«ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å¾Œè¿°ã® create é–¢æ•°ã‚’ä¿®æ­£ã™ã‚‹ã€‚
        // å…ˆã« create é–¢æ•°ã‚’ä¿®æ­£ï¼šé¸æŠã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°ã‚’ä¿å­˜ã™ã‚‹ã€‚
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã« items ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã¨ä»®å®šã€‚
        if (data.items) {
          setSharedItems(data.items);
        } else {
          setSharedItems([]);
        }
      } else {
        showError("å…±æœ‰ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    } catch (e) {
      showError("èª­ã¿è¾¼ã¿å¤±æ•—");
    }
  };

  // å…±æœ‰ãƒªã‚¹ãƒˆä½œæˆï¼ˆã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã‚‚ä¿å­˜ï¼‰
  const createShareListWithItems = async (listName, selectedItemIds) => {
    if (!user) return;
    const shareId = genShareId();
    const itemsToShare = items.filter(i => selectedItemIds.includes(i.id)).map(i => ({ ...i, id: undefined })); // IDã¯ã‚³ãƒ”ãƒ¼ã—ãªã„ï¼ˆæ–°è¦IDã¯æŒ¯ã‚‰ãªã„ï¼‰
    // ã‚‚ã—ãã¯å…ƒã®IDã‚’ä¿æŒã—ãŸã„ãŒã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ··ã–ã‚‰ãªã„ã‚ˆã†ã«æ³¨æ„
    const shareData = {
      ownerId: user.uid,
      listName: listName || "ç„¡é¡Œã®ãƒªã‚¹ãƒˆ",
      items: itemsToShare,
      createdAt: new Date().toISOString(),
    };
    try {
      await window.fb.setDoc(window.fb.doc(window.fb.db, "shares", shareId), shareData);
      showError("å…±æœ‰ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ");
      loadShareLists(user.uid);
      return shareId;
    } catch (e) {
      showError("ä½œæˆå¤±æ•—: " + e.message);
    }
  };

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
  const sendRequest = async (shareId, itemId) => {
    if (!user) {
      showError("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
      return;
    }
    try {
      const requestData = {
        ownerId: shareOwner,
        requesterId: user.uid,
        requesterName: user.displayName || "åç„¡ã—",
        shareId: shareId,
        itemId: itemId,
        status: "pending",
        createdAt: new Date().toISOString(),
      };
      await window.fb.addDoc(window.fb.collection(window.fb.db, "requests"), requestData);
      showError("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    } catch (e) {
      showError("ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å¤±æ•—");
    }
  };

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹æ›´æ–°ï¼ˆæ‰¿èª/æ‹’å¦ï¼‰
  const updateRequestStatus = async (requestId, status) => {
    try {
      await window.fb.setDoc(window.fb.doc(window.fb.db, "requests", requestId), { status }, { merge: true });
      loadRequests(user.uid);
    } catch (e) {
      showError("æ›´æ–°å¤±æ•—");
    }
  };

  const loadFromFirestore = async (userId) => {
    try {
      setIsLoading(true);
      const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
      const snap = await window.fb.getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        if (Array.isArray(data.groups) && data.groups.length) {
          setGroups(data.groups);
          setSelectedGroup(data.groups[0].name);
          if (data.groups[0].members.length) setSelectedMember(data.groups[0].members[0]);
        }
        if (Array.isArray(data.items)) setItems(data.items.map((it, idx) => ({ ...it, order: it.order ?? idx, tags: it.tags || [] })));
        showError("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        setLastSaved(new Date().toLocaleTimeString());
      } else await saveToFirestore(userId);
    } catch (e) { console.error(e); showError("ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—"); } finally { setIsLoading(false); }
  };

  const saveToFirestore = async (userId) => {
    try {
      const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
      await window.fb.setDoc(docRef, { groups, items, lastUpdated: new Date().toISOString() }, { merge: true });
      showError("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ âœ“");
      setLastSaved(new Date().toLocaleTimeString());
    } catch (e) { console.error(e); showError(`ä¿å­˜å¤±æ•—: ${e.message}`); localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items })); }
  };

  // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items }));
    localStorage.setItem("dark_mode", isDarkMode);
    localStorage.setItem("app_width", appWidth);
  }, [groups, items, isDarkMode, appWidth]);

  // è‡ªå‹•Firestoreä¿å­˜
  useEffect(() => {
    if (!user) return;
    const timer = setTimeout(() => saveToFirestore(user.uid), 20000);
    return () => clearTimeout(timer);
  }, [groups, items, user]);

  const handleGoogleLogin = async () => {
    try { await window.fb.signInWithPopup(window.fb.auth, window.fb.provider); } catch { showError("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
  };
  const handleLogout = async () => {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items })); await window.fb.signOut(window.fb.auth); } catch { showError("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—"); }
  };
  const handleManualSave = async () => { if (!user) { showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; } await saveToFirestore(user.uid); };
  const handleManualLoad = async () => { if (!user) { showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; } await loadFromFirestore(user.uid); };

  const updateItem = (id, key, val) => setItems(p => p.map(i => i.id === id ? { ...i, [key]: val } : i));
  const toggleSelectItem = (id) => { if (!isManageMode) return; setSelectedItemIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]); };
  const toggleSignCounters = (id) => setExpandedSignItems(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);

  // â‘ ã‚¿ã‚°æ“ä½œ
  const addTag = (id, tag) => {
    if (!tag.trim()) return;
    setItems(p => p.map(i => {
      if (i.id !== id) return i;
      const newTags = i.tags ? [...i.tags, tag.trim()] : [tag.trim()];
      return { ...i, tags: newTags };
    }));
  };
  const removeTag = (id, tag) => {
    setItems(p => p.map(i => {
      if (i.id !== id) return i;
      return { ...i, tags: (i.tags || []).filter(t => t !== tag) };
    }));
  };

  // SortableJSã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  useEffect(() => {
    if (!isManageMode || sortBy !== "manual" || !listContainerRef.current || viewingShareId) {
      if (sortableInstance.current) {
        sortableInstance.current.destroy();
        sortableInstance.current = null;
      }
      return;
    }

    if (sortableInstance.current) sortableInstance.current.destroy();

    sortableInstance.current = new Sortable(listContainerRef.current, {
      animation: 200,
      handle: '.drag-handle',
      draggable: '.photo-card',
      onEnd: (evt) => {
        const { oldIndex, newIndex } = evt;
        if (oldIndex === newIndex) return;

        const filtered = items.filter(i => 
          (selectedGroup === "ALL" || i.group === selectedGroup) &&
          (selectedMember === "ALL" || i.member === selectedMember) &&
          i.name.toLowerCase().includes(search.toLowerCase()) &&
          (!showOnlyWish || i.isWish)
        );
        const sorted = [...filtered].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
        
        const [moved] = sorted.splice(oldIndex, 1);
        sorted.splice(newIndex, 0, moved);
        
        const orderMap = new Map();
        sorted.forEach((item, idx) => orderMap.set(item.id, idx));
        
        setItems(prev => prev.map(item => {
          if (orderMap.has(item.id)) return { ...item, order: orderMap.get(item.id) };
          return item;
        }).sort((a, b) => (a.order ?? 0) - (b.order ?? 0)));
      },
      forceFallback: true,
      fallbackClass: 'sortable-fallback',
      fallbackOnBody: true,
      touchStartThreshold: 2,
    });

    return () => {
      if (sortableInstance.current) {
        sortableInstance.current.destroy();
        sortableInstance.current = null;
      }
    };
  }, [isManageMode, sortBy, items, selectedGroup, selectedMember, search, showOnlyWish, viewingShareId]);

  const quickBtnStyle = (isDark) => ({
    flex:1, padding:'8px 0', fontSize:'11px', borderRadius:'6px',
    border:'1px solid '+(isDark?'#444':'#ccc'),
    background: isDark?'#333':'#fff', color: isDark?'#fff':'#333', cursor:'pointer'
  });

  // ãƒ•ã‚£ãƒ«ã‚¿ï¼†ã‚½ãƒ¼ãƒˆï¼ˆã‚¿ã‚°ã‚‚æ¤œç´¢å¯¾è±¡ã«å«ã‚ã‚‹ï¼‰
  const sortedItems = useMemo(() => {
    if (viewingShareId) return sharedItems; // å…±æœ‰ãƒ“ãƒ¥ãƒ¼æ™‚ã¯å…±æœ‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
    let filtered = items.filter(i => 
      (selectedGroup === "ALL" || i.group === selectedGroup) &&
      (selectedMember === "ALL" || i.member === selectedMember) &&
      (i.name && i.name.toLowerCase().includes(search.toLowerCase()) ||
       (i.tags && i.tags.some(tag => tag.toLowerCase().includes(search.toLowerCase())))) &&
      (!showOnlyWish || i.isWish)
    );
    if (sortBy === "manual") {
      return filtered.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
    }
    return filtered.sort((a, b) => {
      const aCnt = (a.yori||0)+(a.chuu||0)+(a.hiki||0)+(a.syori||0)+(a.schuu||0)+(a.shiki||0);
      const bCnt = (b.yori||0)+(b.chuu||0)+(b.hiki||0)+(b.syori||0)+(b.schuu||0)+(b.shiki||0);
      switch (sortBy) {
        case "name": return (a.name||"").localeCompare(b.name||"", 'ja');
        case "new": return (b.createdAt||0) - (a.createdAt||0);
        case "old": return (a.createdAt||0) - (b.createdAt||0);
        case "price_high": return (parseInt(b.price)||0) - (parseInt(a.price)||0);
        case "stock_high": return bCnt - aCnt;
        case "comp_first":
          const aComp = (a.yori>0||a.syori>0) && (a.chuu>0||a.schuu>0) && (a.hiki>0||a.shiki>0);
          const bComp = (b.yori>0||b.syori>0) && (b.chuu>0||b.schuu>0) && (b.hiki>0||b.shiki>0);
          return (bComp?1:0) - (aComp?1:0);
        default: return (b.createdAt||0) - (a.createdAt||0);
      }
    });
  }, [items, selectedGroup, selectedMember, search, showOnlyWish, sortBy, viewingShareId, sharedItems]);

  const stats = useMemo(() => {
    if (viewingShareId) return { totalKinds: sharedItems.length, totalSlots: sharedItems.length*3, collectedSlots:0, completedKinds:0 }; // å…±æœ‰ãƒ“ãƒ¥ãƒ¼ã§ã¯çµ±è¨ˆã¯ç°¡ç•¥
    const filtered = items.filter(i => (selectedGroup==="ALL"||i.group===selectedGroup) && (selectedMember==="ALL"||i.member===selectedMember));
    const totalKinds = filtered.length;
    const totalSlots = totalKinds * 3;
    let collected = 0, completed = 0;
    filtered.forEach(i => {
      const hasY = i.yori>0||i.syori>0;
      const hasC = i.chuu>0||i.schuu>0;
      const hasH = i.hiki>0||i.shiki>0;
      if (hasY) collected++;
      if (hasC) collected++;
      if (hasH) collected++;
      if (hasY && hasC && hasH) completed++;
    });
    return { totalKinds, totalSlots, collectedSlots: collected, completedKinds: completed };
  }, [items, selectedGroup, selectedMember, viewingShareId, sharedItems]);

  const batchAction = (type) => {
    if (selectedItemIds.length === 0 || !isManageMode) return;
    if (type === 'delete') { setTargetName(`${selectedItemIds.length}ä»¶ã®é¸æŠé …ç›®`); setActiveModal('delete_batch'); }
    else if (type === 'wish') { setItems(p => p.map(i => selectedItemIds.includes(i.id) ? {...i, isWish: true} : i)); showError(`${selectedItemIds.length}ä»¶ã‚’â­ã«è¨­å®š`); }
    else if (type === 'stock') { setItems(p => p.map(i => selectedItemIds.includes(i.id) ? {...i, yori: (i.yori||0)+1, chuu: (i.chuu||0)+1, hiki: (i.hiki||0)+1} : i)); showError(`${selectedItemIds.length}ä»¶ã®åœ¨åº«+1`); }
  };

  const resetOrder = () => {
    if (confirm("ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é †ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
      const current = items.filter(i => (selectedGroup==="ALL"||i.group===selectedGroup) && (selectedMember==="ALL"||i.member===selectedMember));
      const sortedByDate = [...current].sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      const orderMap = new Map();
      sortedByDate.forEach((it, idx) => orderMap.set(it.id, idx));
      setItems(prev => prev.map(it => orderMap.has(it.id) ? {...it, order: orderMap.get(it.id)} : it).sort((a,b) => (a.order??0)-(b.order??0)));
      showError("ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }
  };

  const resetAllOrder = () => {
    if (confirm("ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸¦ã³é †ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
      const allSorted = [...items].sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
      const updated = allSorted.map((it, idx) => ({...it, order: idx}));
      setItems(updated);
      showError("ã™ã¹ã¦ã®ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }
  };

  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (selectedGroup === "ALL" || selectedMember === "ALL") { showError("ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); e.target.value=""; return; }
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const text = ev.target.result;
        const hasTabs = text.includes('\t');
        const rows = parseCSV(text, hasTabs ? '\t' : ',');
        const newItems = rows.map((row, idx) => {
          if (hasTabs) return parseTabCSVRowToItem(row, selectedGroup, selectedMember, items.length + idx);
          else return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, items.length + idx);
        }).filter(Boolean);
        setItems(p => [...p, ...newItems]);
        showError(`${newItems.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
      } catch(err) { showError("CSVã‚¨ãƒ©ãƒ¼: "+err.message); }
    };
    reader.readAsText(file, 'UTF-8');
    e.target.value = "";
  };

  const loadExternalTemplate = async (fileName) => {
    try {
      setIsLoading(true);
      const res = await fetch(fileName);
      if (!res.ok) throw new Error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      const text = await res.text();
      const hasTabs = text.includes('\t');
      const rows = parseCSV(text, hasTabs ? '\t' : ',');
      const newItems = rows.map((row, idx) => {
        if (hasTabs) return parseTabCSVRowToItem(row, selectedGroup, selectedMember, items.length + idx);
        else return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, items.length + idx);
      }).filter(Boolean);
      setItems(p => [...p, ...newItems]);
      showError(`${newItems.length}ä»¶ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­è¾¼`);
      setActiveModal(null);
    } catch (err) { showError("èª­è¾¼å¤±æ•—: "+err.message); checkTemplateFiles(); } finally { setIsLoading(false); }
  };

  const handleCSVExport = () => {
    const csv = items.map(i => [
      i.group, i.member, i.name, i.yori, i.chuu, i.hiki, i.memo||"", i.thumbnail||"", i.price||"", i.source||"å…¥æ‰‹å…ˆ", i.isWish?"1":"0", (i.otherImages||[]).join("|"), i.syori||0, i.schuu||0, i.shiki||0, i.order||0, (i.tags||[]).join(",")
    ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="photo_data.csv"; a.click();
  };
  const handleTSVExport = () => {
    const tsv = items.map(i => `${i.thumbnail||""}\t${i.name||""}\t"${(i.otherImages||[]).join("\n")}"`).join("\n");
    const blob = new Blob([tsv], {type:"text/tab-separated-values"});
    const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="photo_data.tsv"; a.click();
  };

  const openEditImgModal = (item) => { setEditItemId(item.id); setTempMainUrl(item.thumbnail||""); setTempImages(item.otherImages||[]); setActiveModal('edit_img'); };
  const saveImages = () => { setItems(p => p.map(it => it.id===editItemId ? {...it, thumbnail: tempMainUrl, otherImages: tempImages} : it)); setActiveModal(null); };
  const handleCacheClear = () => { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };

  // ãƒ­ã‚°ã‚¤ãƒ³å‰
  if (!isAuthReady) return <div style={{display:'flex',justifyContent:'center',alignItems:'center',height:'100vh',background:'#1a1a1a',color:'#fff'}}>èª­ã¿è¾¼ã¿ä¸­...</div>;
  
  // å…±æœ‰ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰
  if (viewingShareId) {
    return (
      <div className={isDarkMode?"dark-mode":""} style={{maxWidth:appWidth,margin:'0 auto',minHeight:'100vh'}}>
        <div className="top-bar">
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <h3 style={{margin:0,fontSize:'16px'}}>å…±æœ‰ãƒªã‚¹ãƒˆ: {shareListName}</h3>
          </div>
          <div>
            <button onClick={()=> window.location.href = '/'} style={{padding:'6px 12px'}}>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
          </div>
        </div>
        <div className="main-layout">
          <p>ã“ã®ãƒªã‚¹ãƒˆã¯å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚æ¬²ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã¾ã™ã€‚</p>
          <div className="stats-card">
            <div className="stats-summary">
              <div className="stat-item"><span className="stat-value">{sharedItems.length}</span><span className="stat-label">æ²è¼‰ç‚¹æ•°</span></div>
            </div>
          </div>
          {sharedItems.map(i => (
            <div key={i.id} className={`photo-card ${i.isWish?'is-wish':''}`}>
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:10}}>
                <div className="img-container">
                  <div style={{width:65}}>
                    {i.thumbnail ? <img src={i.thumbnail} style={{width:'100%',borderRadius:4}} /> : <div style={{background:'#eee',height:60,borderRadius:4,fontSize:8,display:'flex',alignItems:'center',justifyContent:'center',color:'#888'}}>ç”»åƒãªã—</div>}
                  </div>
                </div>
              </div>
              <div className="card-content">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{flex:1,minWidth:0,display:'flex',alignItems:'center',gap:8}}>
                    <span className={`wish-toggle ${i.isWish?'active':''}`}>â­</span>
                    <span className="name-display">{i.name}</span>
                  </div>
                </div>
                <div className="tags-container" style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '8px' }}>
                  {(i.tags || []).map(tag => <span key={tag} className="tag-badge" style={{ background: isDarkMode?'#444':'#e0e0e0', padding:'2px 8px', borderRadius:'12px', fontSize:'11px' }}>#{tag}</span>)}
                </div>
                <div style={{display:'flex',gap:4,flexWrap:'wrap',marginBottom:8}}>
                  {[{k:'yori',l:'å¯„'},{k:'chuu',l:'ä¸­'},{k:'hiki',l:'å¼•'}].map(o=>(
                    <div key={o.k} className={`counter-group ${i[o.k]>0?'has-stock':''}`}>
                      <span style={{fontSize:9,padding:'0 4px',fontWeight:'bold'}}>{o.l}</span>
                      <span className="qty-val">{i[o.k]||0}</span>
                    </div>
                  ))}
                </div>
                <div style={{marginTop:'8px'}}>
                  <button onClick={()=> sendRequest(viewingShareId, i.id)} style={{padding:'8px 16px',background:'#4caf50',color:'white',border:'none',borderRadius:'4px',cursor:'pointer'}}>ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // é€šå¸¸ã®ç®¡ç†ç”»é¢
  return (
    <div className={isDarkMode?"dark-mode":""} style={{maxWidth:appWidth,margin:'0 auto',minHeight:'100vh'}}>
      {errorMsg && <div className="error-toast">âš ï¸ {errorMsg}</div>}
      {isLoading && <div className="loading-overlay"><div className="loading-spinner"></div><div className="loading-text">åŒæœŸä¸­...</div></div>}

      <div className="top-bar">
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <h3 style={{margin:0,fontSize:'16px'}}>ç”Ÿå†™çœŸç®¡ç†For=Love</h3>
          {lastSaved && <span style={{fontSize:10,color:'#4caf50',background:'rgba(76,175,80,0.1)',padding:'2px 6px',borderRadius:4}}>âœ“ {lastSaved}</span>}
        </div>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          {user && (
            <div style={{display:'flex',alignItems:'center',gap:6,fontSize:12,padding:'4px 8px',background:isDarkMode?'#2a2a2a':'#f5f5f5',borderRadius:'20px'}}>
              <img src={user.photoURL} alt="avatar" style={{width:24,height:24,borderRadius:'50%',border:isDarkMode?'1px solid #444':'1px solid #ddd'}} />
              <span style={{fontWeight:'bold',color:isDarkMode?'#fff':'#333',maxWidth:'100px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{user.displayName}</span>
            </div>
          )}
          <button onClick={()=>setActiveModal('app_settings')} style={{padding:'6px 12px',background:isDarkMode?'#2a2a2a':'#f5f5f5',border:isDarkMode?'1px solid #444':'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'14px',fontWeight:'bold'}}>âš™ï¸</button>
          <button onClick={()=>setIsDarkMode(!isDarkMode)} style={{padding:'6px 8px',background:isDarkMode?'#2a2a2a':'#f5f5f5',border:isDarkMode?'1px solid #444':'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'16px'}}>{isDarkMode?"â˜€ï¸":"ğŸŒ™"}</button>
        </div>
      </div>

      <div className="main-layout">
        {isManageMode && sortBy === "manual" && (
          <div className="sort-helper">
            <span className="sort-hint">âœ¨ ãƒãƒ³ãƒ‰ãƒ«ï¼ˆâ‹®â‹®ï¼‰ã‚’é•·æŠ¼ã—ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°<br /><small>ã‚¢ã‚¤ãƒ†ãƒ ã®é–“ã«å…¥ã‚Œã‚‰ã‚Œã¾ã™</small></span>
            <button className="reset-order-btn" onClick={resetOrder}>ğŸ”„ ç¾åœ¨ã®ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        )}
        
        <div className="stats-card">
          <div className="stats-charts-grid">
            <div className="stats-box">
              <div className="stats-label">åé›†ç‡</div>
              <div className="progress-circle-container">
                <div className="progress-circle-bg"></div>
                <div className="progress-circle" style={{background:`conic-gradient(${isDarkMode?'var(--color-primary)':'var(--light-primary)'} 0% ${stats.totalSlots?Math.round(stats.collectedSlots/stats.totalSlots*100):0}%, transparent ${stats.totalSlots?Math.round(stats.collectedSlots/stats.totalSlots*100):0}% 100%)`}}></div>
                <div className="progress-circle-mask"><span className="progress-percentage">{stats.totalSlots?Math.round(stats.collectedSlots/stats.totalSlots*100):0}%</span></div>
              </div>
              <div className="stats-fraction">{stats.collectedSlots} / {stats.totalSlots}</div>
            </div>
            <div className="stats-box">
              <div className="stats-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</div>
              <div className="progress-circle-container">
                <div className="progress-circle-bg"></div>
                <div className="progress-circle" style={{background:`conic-gradient(${isDarkMode?'var(--color-success)':'var(--light-success)'} 0% ${stats.totalKinds?Math.round(stats.completedKinds/stats.totalKinds*100):0}%, transparent ${stats.totalKinds?Math.round(stats.completedKinds/stats.totalKinds*100):0}% 100%)`}}></div>
                <div className="progress-circle-mask"><span className="progress-percentage">{stats.totalKinds?Math.round(stats.completedKinds/stats.totalKinds*100):0}%</span></div>
              </div>
              <div className="stats-fraction">{stats.completedKinds} / {stats.totalKinds}</div>
            </div>
          </div>
          <div className="stats-summary">
            <div className="stat-item"><span className="stat-value">{stats.totalKinds}</span><span className="stat-label">ç·å†™çœŸæ•°</span></div>
            <div className="stat-item"><span className="stat-value">{stats.collectedSlots}</span><span className="stat-label">åé›†æ¸ˆã¿</span></div>
            <div className="stat-item"><span className="stat-value">{stats.completedKinds}</span><span className="stat-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ</span></div>
          </div>
        </div>

        <div className="control-panel">
          <div className="control-header">
            <div><strong>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</strong>{isManageMode && <span className="manage-mode-badge">ON</span>}</div>
            <button className="manage-toggle" onClick={()=>setIsManageMode(!isManageMode)} style={{color:isManageMode?'#ff5252':''}}>âœï¸</button>
          </div>
          <div className="filter-row">
            <input className="search-input" placeholder="åå‰ã¾ãŸã¯ã‚¿ã‚°ã§æ¤œç´¢..." value={search} onChange={e=>setSearch(e.target.value)} />
            <button className={`wish-toggle-btn ${showOnlyWish?'active':''}`} onClick={()=>setShowOnlyWish(!showOnlyWish)}>â­ ã®ã¿</button>
            <select className="sort-select" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
              <option value="manual">æ‰‹å‹•ä¸¦ã³æ›¿ãˆ</option>
              <option value="new">æ–°ã—ã„é †</option>
              <option value="old">å¤ã„é †</option>
              <option value="name">åå‰é †</option>
              <option value="price_high">ä¾¡æ ¼ãŒé«˜ã„é †</option>
              <option value="stock_high">åœ¨åº«ãŒå¤šã„é †</option>
              <option value="comp_first">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå„ªå…ˆ</option>
            </select>
          </div>

          <div className="group-section">
            <div className="section-title"><strong>ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ</strong><button className="add-btn" onClick={()=>setActiveModal('add_group')}>+</button></div>
            <ul className="button-list">
              <li><button className={`btn-item ${selectedGroup==='ALL'?'active':''}`} onClick={()=>{setSelectedGroup('ALL');setSelectedMember('ALL');}}>ALL</button></li>
              {groups.map(g=>(
                <li key={g.name}>
                  <button className={`btn-item ${selectedGroup===g.name?'active':''}`} onClick={()=>{setSelectedGroup(g.name);setSelectedMember(g.members.length?g.members[0]:'ALL');}}>
                    {g.name}{isManageMode && <button className="btn-delete-small" onClick={(e)=>{e.stopPropagation();setTargetName(g.name);setActiveModal('delete_group');}}>Ã—</button>}
                  </button>
                </li>
              ))}
            </ul>
          </div>

          <div className="member-section">
            <div className="section-title"><strong>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</strong>{selectedGroup!=='ALL'&&selectedGroup&&<button className="add-btn" onClick={()=>setActiveModal('add_member')}>+</button>}</div>
            <ul className="button-list">
              <li><button className={`btn-item ${selectedMember==='ALL'?'active':''}`} onClick={()=>setSelectedMember('ALL')}>ALL</button></li>
              {selectedGroup!=='ALL' && groups.find(g=>g.name===selectedGroup)?.members.map(m=>(
                <li key={m}>
                  <button className={`btn-item ${selectedMember===m?'active':''}`} onClick={()=>setSelectedMember(m)}>
                    {m}{isManageMode && <button className="btn-delete-small" onClick={(e)=>{e.stopPropagation();setTargetName(m);setActiveModal('delete_member');}}>Ã—</button>}
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </div>

        {selectedGroup !== "ALL" && selectedMember !== "ALL" && (
          <button className="add-trigger-btn" onClick={()=>setActiveModal('add_photo')}>ï¼‹ ç”Ÿå†™çœŸã‚’è¿½åŠ </button>
        )}

        {/* ã‚½ãƒ¼ãƒˆå¯èƒ½ãªãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */}
        <div ref={listContainerRef} style={isManageMode && sortBy==="manual" ? { minHeight: '50px' } : {}}>
          {sortedItems.map(i => {
            const comp = (i.yori>0||i.syori>0) && (i.chuu>0||i.schuu>0) && (i.hiki>0||i.shiki>0);
            const isSelected = selectedItemIds.includes(i.id);
            const isSignExpanded = expandedSignItems.includes(i.id);
            return (
              <div key={i.id} data-item-id={i.id} className={`photo-card ${comp?'is-complete':''} ${i.isWish?'is-wish':''}`} style={{background: isManageMode && isSelected ? 'rgba(255,82,82,0.1)' : ''}}>
                {isManageMode && sortBy === "manual" && (
                  <div className="drag-handle" title="é•·æŠ¼ã—ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°">â‹®â‹®</div>
                )}
                <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:10}}>
                  {isManageMode && <input type="checkbox" className="selection-checkbox" checked={isSelected} onChange={()=>toggleSelectItem(i.id)} />}
                  <div className="img-container">
                    <div className="btn-img-add" onClick={()=>openEditImgModal(i)}>ï¼‹</div>
                    <div style={{width:65,cursor:'pointer'}} onClick={()=>{
                      const imgs = [i.thumbnail, ...(i.otherImages||[])].filter(Boolean);
                      if(imgs.length) setViewer({images:imgs,index:0,name:i.name}); else openEditImgModal(i);
                    }}>
                      {i.thumbnail ? <img src={i.thumbnail} style={{width:'100%',borderRadius:4}} /> : <div style={{background:'#eee',height:60,borderRadius:4,fontSize:8,display:'flex',alignItems:'center',justifyContent:'center',color:'#888'}}>ç”»åƒãªã—</div>}
                    </div>
                  </div>
                </div>
                <div className="card-content">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div style={{flex:1,minWidth:0,display:'flex',alignItems:'center',gap:8}}>
                      <button className={`wish-toggle ${i.isWish?'active':''}`} onClick={()=>updateItem(i.id,'isWish',!i.isWish)}>â­</button>
                      {editingNameId===i.id ? (
                        <input className="edit-name-input" autoFocus value={i.name} onChange={e=>updateItem(i.id,'name',e.target.value)} onBlur={()=>setEditingNameId(null)} onKeyDown={e=>e.key==='Enter'&&setEditingNameId(null)} />
                      ) : (
                        <span className="name-display" onClick={()=>setEditingNameId(i.id)}>{i.name} {comp && "ğŸ‘ï¸"}</span>
                      )}
                    </div>
                    <button onClick={()=>{setTargetName(i.name);setTargetId(i.id);setActiveModal('delete_photo');}} style={{color:'#999',border:'none',background:'none',cursor:'pointer'}}>âœ•</button>
                  </div>
                  
                  {/* â‘ ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
                  <div className="tags-container" style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '8px' }}>
                    {(i.tags || []).map(tag => (
                      <span key={tag} className="tag-badge" style={{ background: isDarkMode?'#444':'#e0e0e0', padding:'2px 8px', borderRadius:'12px', fontSize:'11px', display:'inline-flex', alignItems:'center' }}>
                        #{tag}
                        {isManageMode && <button onClick={()=>removeTag(i.id, tag)} style={{ marginLeft:'4px', background:'none', border:'none', color:'#999', cursor:'pointer' }}>Ã—</button>}
                      </span>
                    ))}
                    {isManageMode && (
                      <form onSubmit={(e)=>{ e.preventDefault(); const input = e.target.elements.tag; if(input.value){ addTag(i.id, input.value); input.value=''; } }} style={{ display:'inline-flex' }}>
                        <input type="text" name="tag" placeholder="ã‚¿ã‚°è¿½åŠ " style={{ width:'80px', fontSize:'11px', padding:'2px 4px', borderRadius:'12px', border:'1px solid #ccc' }} />
                      </form>
                    )}
                  </div>

                  <div style={{display:'flex',gap:4,flexWrap:'wrap',marginBottom:8}}>
                    {[{k:'yori',l:'å¯„'},{k:'chuu',l:'ä¸­'},{k:'hiki',l:'å¼•'}].map(o=>(
                      <div key={o.k} className={`counter-group ${i[o.k]>0?'has-stock':''}`}>
                        <span style={{fontSize:9,padding:'0 4px',fontWeight:'bold'}}>{o.l}</span>
                        <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,Math.max(0,(i[o.k]||0)-1))}>-</button>
                        <span className="qty-val">{i[o.k]||0}</span>
                        <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,(i[o.k]||0)+1)}>+</button>
                      </div>
                    ))}
                  </div>
                  <div className="sign-counters-container">
                    <button className={`sign-counters-toggle ${isSignExpanded?'active':''}`} onClick={()=>toggleSignCounters(i.id)}>ã‚µã‚¤ãƒ³ä»˜ãã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</button>
                    <div className={`sign-counters-content ${isSignExpanded?'expanded':''}`}>
                      {[{k:'syori',l:'ã‚µã‚¤ãƒ³å¯„'},{k:'schuu',l:'ã‚µã‚¤ãƒ³ä¸­'},{k:'shiki',l:'ã‚µã‚¤ãƒ³å¼•'}].map(o=>(
                        <div key={o.k} className={`counter-group ${i[o.k]>0?'has-sign':''}`}>
                          <span style={{fontSize:9,padding:'0 4px',fontWeight:'bold'}}>{o.l}</span>
                          <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,Math.max(0,(i[o.k]||0)-1))}>-</button>
                          <span className="qty-val">{i[o.k]||0}</span>
                          <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,(i[o.k]||0)+1)}>+</button>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="row-inputs" style={{flexWrap:'wrap',gap:'8px',marginTop:'8px'}}>
                    <select className="source-select" value={i.source||"å…¥æ‰‹å…ˆ"} onChange={e=>updateItem(i.id,'source',e.target.value)} style={{height:'36px'}}>
                      {SOURCE_OPTIONS.map(opt=><option key={opt} value={opt}>{opt}</option>)}
                    </select>
                    <input className="details-input" style={{flex:'1 1 150px',height:'36px'}} placeholder="ãƒ¡ãƒ¢" value={i.memo||""} onChange={e=>updateItem(i.id,'memo',e.target.value)} />
                    <div className="price-wrapper">
                      <input className="details-input" style={{width:'100%'}} placeholder="ä¾¡æ ¼" value={formatWithComma(i.price)} onChange={e=>updateItem(i.id,'price',e.target.value.replace(/\D/g,'').slice(0,7))} />
                      <span className="currency-unit">å††</span>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {isManageMode && sortedItems.length > 0 && (
        <div className="selection-bar">
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <input type="checkbox" className="selection-checkbox" checked={selectedItemIds.length>0 && selectedItemIds.length===sortedItems.length} onChange={e=>{if(e.target.checked) setSelectedItemIds(sortedItems.map(it=>it.id)); else setSelectedItemIds([]);}} />
            <span style={{fontSize:12,fontWeight:'bold'}}>{selectedItemIds.length}ä»¶é¸æŠä¸­</span>
          </div>
          <div style={{display:'flex',gap:8}}>
            <button className="batch-btn" onClick={()=>batchAction('wish')}>ä¸€æ‹¬ãŠæ°—ã«å…¥ã‚Š</button>
            <button className="batch-btn" onClick={()=>batchAction('stock')}>ã™ã¹ã¦+1</button>
            <button className="batch-btn" style={{background:'#000'}} onClick={()=>batchAction('delete')}>å‰Šé™¤</button>
          </div>
        </div>
      )}

      {viewer && (
        <div className="lightbox" onClick={()=>setViewer(null)}>
          <div className="lightbox-close">Ã—</div>
          <img src={viewer.images[viewer.index]} onClick={e=>{e.stopPropagation(); setViewer({...viewer, index:(viewer.index+1)%viewer.images.length});}} />
          <div className="lightbox-info"><strong>{viewer.name}</strong><br/>{viewer.index+1} / {viewer.images.length}</div>
        </div>
      )}

      {activeModal && (
        <div className="modal-overlay" onClick={()=>setActiveModal(null)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            {activeModal === 'app_settings' && (
              <div>
                <h3>è¨­å®š</h3>
                {user && (
                  <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'10px'}}>
                      <img src={user.photoURL} alt="avatar" style={{width:40,height:40,borderRadius:'50%'}} />
                      <div><div style={{fontWeight:'bold'}}>{user.displayName}</div><div style={{fontSize:'11px',color:'#666'}}>{user.email}</div></div>
                    </div>
                    {lastSaved && <div style={{fontSize:'12px',color:'#4caf50',textAlign:'center'}}>âœ“ æœ€çµ‚ä¿å­˜: {lastSaved}</div>}
                  </div>
                )}
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                  <h4>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h4>
                  <div style={{display:'flex',gap:'8px',marginBottom:'10px'}}>
                    <button onClick={handleManualSave} style={{flex:1,padding:'10px',background:'#4caf50',color:'white',border:'none',borderRadius:'8px'}}>ğŸ’¾ æ‰‹å‹•ä¿å­˜</button>
                    <button onClick={handleManualLoad} style={{flex:1,padding:'10px',background:'#2196f3',color:'white',border:'none',borderRadius:'8px'}}>ğŸ”„ æ‰‹å‹•èª­è¾¼</button>
                  </div>
                </div>
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                  <h4>ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h4>
                  <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                    <button onClick={handleCSVExport} style={{padding:'10px',background:'#ff9800',color:'white',border:'none',borderRadius:'8px'}}>ğŸ“¤ CSVå‡ºåŠ›</button>
                    <button onClick={handleTSVExport} style={{padding:'10px',background:'#9c27b0',color:'white',border:'none',borderRadius:'8px'}}>ğŸ“¤ TSVå‡ºåŠ›</button>
                    <label style={{padding:'10px',background:'#2196f3',color:'white',border:'none',borderRadius:'8px',textAlign:'center',cursor:'pointer'}}>
                      ğŸ“¥ CSV/TSVå–è¾¼<input type="file" accept=".csv,.tsv,.txt" style={{display:'none'}} onChange={handleImportCSV} />
                    </label>
                    {availableTemplates.length>0 && (
                      <div style={{marginTop:'10px'}}>
                        <div style={{fontSize:'11px'}}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</div>
                        <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'5px'}}>
                          {availableTemplates.map(f=>(
                            <button key={f} onClick={()=>loadExternalTemplate(f)} style={{padding:'8px',background:'#9c27b0',color:'white',border:'none',borderRadius:'6px'}}>{f.replace('.csv','')}</button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                
                {/* â‘¨å…±æœ‰æ©Ÿèƒ½ãƒ‘ãƒãƒ« */}
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                  <h4>å…±æœ‰ãƒªã‚¹ãƒˆ</h4>
                  <div style={{marginBottom:'10px'}}>
                    <button onClick={()=> {
                      if (selectedItemIds.length === 0) { showError("ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
                      const name = prompt("ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ï¼ˆçœç•¥å¯ï¼‰");
                      createShareListWithItems(name || "å…±æœ‰ãƒªã‚¹ãƒˆ", selectedItemIds);
                    }} style={{padding:'8px 16px',background:'#3f51b5',color:'white',border:'none',borderRadius:'8px',width:'100%'}}>
                      ğŸ”— é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã§å…±æœ‰ãƒªã‚¹ãƒˆä½œæˆ
                    </button>
                  </div>
                  <div>
                    <h5>ä½œæˆæ¸ˆã¿ãƒªã‚¹ãƒˆ</h5>
                    {shareLists.length === 0 && <p style={{fontSize:'12px',color:'#888'}}>ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>}
                    {shareLists.map(list => (
                      <div key={list.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px',padding:'8px',background:isDarkMode?'#333':'#eee',borderRadius:'6px'}}>
                        <span style={{fontSize:'12px'}}>{list.listName || 'ç„¡é¡Œ'}</span>
                        <button onClick={() => {
                          const url = window.location.origin + window.location.pathname + '?share=' + list.id;
                          navigator.clipboard.writeText(url);
                          showError("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                        }} style={{padding:'4px 8px',background:'#2196f3',color:'white',border:'none',borderRadius:'4px',fontSize:'11px'}}>URLã‚³ãƒ”ãƒ¼</button>
                      </div>
                    ))}
                  </div>
                </div>

                {/* ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ */}
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                  <h4>ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ç®±</h4>
                  {requests.length === 0 && <p style={{fontSize:'12px',color:'#888'}}>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>}
                  {requests.map(req => (
                    <div key={req.id} style={{marginBottom:'8px',padding:'8px',background:isDarkMode?'#333':'#eee',borderRadius:'6px'}}>
                      <div style={{fontSize:'12px'}}><strong>{req.requesterName}</strong> ã•ã‚“ãŒã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
                      <div style={{fontSize:'11px',color:'#666'}}>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {req.status}</div>
                      {req.status === 'pending' && (
                        <div style={{display:'flex',gap:'4px',marginTop:'4px'}}>
                          <button onClick={()=> updateRequestStatus(req.id, 'approved')} style={{padding:'4px 8px',background:'#4caf50',color:'white',border:'none',borderRadius:'4px'}}>æ‰¿èª</button>
                          <button onClick={()=> updateRequestStatus(req.id, 'rejected')} style={{padding:'4px 8px',background:'#f44336',color:'white',border:'none',borderRadius:'4px'}}>æ‹’å¦</button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px'}}>
                  <h4>è¡¨ç¤ºè¨­å®š</h4>
                  <label style={{display:'flex',justifyContent:'space-between',fontSize:'12px'}}><span>ã‚µã‚¤ãƒˆã®å¹…</span><b>{appWidth==='100%'?'ãƒ•ãƒ«ç”»é¢':appWidth}</b></label>
                  <input type="range" min="350" max="1200" step="10" value={appWidth==='100%'?1200:parseInt(appWidth)} onChange={e=>setAppWidth(`${e.target.value}px`)} style={{width:'100%',accentColor:'#2196f3'}} />
                  <div style={{display:'flex',gap:'8px',marginTop:'12px'}}>
                    {['400px','600px','900px','100%'].map(w=><button key={w} onClick={()=>setAppWidth(w)} style={quickBtnStyle(isDarkMode)}>{w==='100%'?'ãƒ•ãƒ«':w}</button>)}
                  </div>
                </div>
                <ul className="settings-list">
                  <li onClick={resetAllOrder} style={{color:'#ff9800'}}>ğŸ”„ ã™ã¹ã¦ã®ä¸¦ã³é †ãƒªã‚»ãƒƒãƒˆ</li>
                  <li onClick={handleCacheClear}>ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤</li>
                  <li onClick={()=>alert("è¦ç´„ï¼šå€‹äººåˆ©ç”¨ã®ãŸã‚ã€è²¬ä»»ã¯è² ã„ã‹ã­ã¾ã™ã€‚")}>ğŸ“œ è¦ç´„</li>
                  <li onClick={()=>window.open("https://github.com/Meowx7")}>ğŸ± GitHub</li>
                  <li onClick={handleLogout} style={{color:'#ff5252'}}>ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
                  <li style={{color:'#888',cursor:'default',fontSize:'11px',justifyContent:'center'}}>Version 2.0.0 (å…±æœ‰æ©Ÿèƒ½è¿½åŠ )</li>
                </ul>
                <button onClick={()=>setActiveModal(null)} style={{width:'100%',padding:12,background:'#eee',border:'none',borderRadius:8,fontWeight:'bold'}}>é–‰ã˜ã‚‹</button>
              </div>
            )}
            {activeModal === 'add_photo' && (
              <div><h3>æ–°è¦è¿½åŠ </h3><input type="text" id="modal_name" autoFocus /><button onClick={()=>{const v=document.getElementById('modal_name').value; if(v){ const newItem={id:genId(),group:selectedGroup,member:selectedMember,name:v,yori:0,chuu:0,hiki:0,syori:0,schuu:0,shiki:0,isWish:false,createdAt:Date.now(),memo:'',price:'',source:'å…¥æ‰‹å…ˆ',thumbnail:'',otherImages:[],tags:[],order:items.length}; setItems(p=>[...p,newItem]); setActiveModal(null); }}} style={{width:'100%',padding:12,background:'#2196f3',color:'#fff',border:'none',borderRadius:8,marginTop:10}}>è¿½åŠ </button></div>
            )}
            {activeModal === 'add_group' && (
              <div><h3>ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{if(e.key==='Enter'){const val=e.target.value.trim(); if(!val) return showError("å…¥åŠ›ã—ã¦ãã ã•ã„"); setGroups(p=>[...p,{name:val,members:[]}]); setActiveModal(null); }}}/></div>
            )}
            {activeModal === 'add_member' && (
              <div><h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{if(e.key==='Enter'){const val=e.target.value.trim(); if(!val) return showError("å…¥åŠ›ã—ã¦ãã ã•ã„"); setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:[...g.members,val]}:g)); setActiveModal(null); }}}/></div>
            )}
            {activeModal === 'edit_img' && (
              <div>
                <h3>ç”»åƒç®¡ç†</h3>
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginBottom:10}}>
                  {tempMainUrl && <div style={{position:'relative'}}><img src={tempMainUrl} style={{width:'100%',height:60,objectFit:'cover',borderRadius:4}}/><button onClick={()=>setTempMainUrl("")} style={{position:'absolute',top:0,right:0,background:'red',color:'white',border:'none'}}>Ã—</button></div>}
                  {tempImages.map((u,idx)=><div key={idx} style={{position:'relative'}}><img src={u} style={{width:'100%',height:60,objectFit:'cover',borderRadius:4}}/><button onClick={()=>setTempImages(p=>p.filter((_,i)=>i!==idx))} style={{position:'absolute',top:0,right:0,background:'red',color:'white',border:'none'}}>Ã—</button></div>)}
                </div>
                <label style={{display:'block',padding:10,background:'#2196f3',color:'white',textAlign:'center',borderRadius:8,cursor:'pointer',marginBottom:10}}>
                  ç«¯æœ«ã‹ã‚‰é¸æŠ<input type="file" multiple style={{display:'none'}} onChange={async(e)=>{const files=Array.from(e.target.files); for(const f of files){ const c=await compressImage(f); if(!tempMainUrl) setTempMainUrl(c); else setTempImages(p=>[...p,c]); }}}/>
                </label>
                <input type="text" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘" onKeyDown={e=>{if(e.key==='Enter' && e.target.value){ const urls=e.target.value.split(/[, \n]+/).filter(Boolean); urls.forEach(u=>{if(!tempMainUrl) setTempMainUrl(u); else setTempImages(p=>[...p,u]);}); e.target.value=""; }}}/>
                <button onClick={saveImages} style={{width:'100%',padding:12,background:'#4caf50',color:'#fff',border:'none',borderRadius:8,marginTop:10}}>ä¿å­˜</button>
              </div>
            )}
            {activeModal === 'delete_group' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.group!==targetName)); setGroups(p=>p.filter(g=>g.name!==targetName)); if(selectedGroup===targetName){setSelectedGroup("ALL");setSelectedMember("ALL");} setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_member' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.member!==targetName)); setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:g.members.filter(m=>m!==targetName)}:g)); if(selectedMember===targetName) setSelectedMember("ALL"); setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_photo' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.id!==targetId)); setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_batch' && (
              <div><h3>{targetName}ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>!selectedItemIds.includes(i.id))); setSelectedItemIds([]); setActiveModal(null);}} style={{width:'100%',padding:12,background:'#000',color:'#fff',border:'none',borderRadius:8}}>ä¸€æ‹¬å‰Šé™¤</button></div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
