<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç”Ÿå†™çœŸç®¡ç†For=Love</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
   <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;
    const STORAGE_KEY = "photocard_inventory_v3_manage_plus";
    const genId = () => 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const SOURCE_OPTIONS = ["å…¥æ‰‹å…ˆ", "ãƒ¡ãƒ«ã‚«ãƒª", "è‡ªå¼•ã", "åº—èˆ—", "è­²æ¸¡", "ãã®ä»–"];

    const DEFAULT_GROUPS = [{ name: "=Love", members: ["å¤§è°·æ˜ ç¾é‡Œ"] }];

    const formatWithComma = (val) => {
      if (!val) return "";
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };

    function parseCSV(text) {
      if (!text) return [];
      const rows = []; let row = []; let field = ''; let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], next = text[i+1];
        if (inQuotes) {
          if (c === '"' && next === '"') { field += '"'; i++; }
          else if (c === '"') inQuotes = false;
          else field += c;
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(field); field = ''; }
          else if (c === '\n' || c === '\r') {
            if (field || row.length) { row.push(field); rows.push(row); }
            row = []; field = ''; if (c === '\r' && next === '\n') i++;
          } else field += c;
        }
      }
      if (field || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function MiniChart({ percent, color, isDarkMode }) {
      const r = 18; const c = 2 * Math.PI * r;
      const p = isNaN(percent) ? 0 : percent;
      return (
        <svg width="40" height="40" viewBox="0 0 40 40">
          <circle cx="20" cy="20" r={r} stroke={isDarkMode ? "#333" : "#eee"} strokeWidth="4" fill="none" />
          <circle cx="20" cy="20" r={r} stroke={color} strokeWidth="4" fill="none"
            strokeDasharray={`${(p / 100) * c} ${c}`} transform="rotate(-90 20 20)" strokeLinecap="round" />
        </svg>
      );
    }

    const compressImage = (file, maxWidth = 500) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale; canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => resolve("");
        };
      });
    };

    function App() {
      const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem("dark_mode") === "true");
// è¡¨ç¤ºå¹…ã®çŠ¶æ…‹ã‚’è¿½åŠ ï¼ˆåˆæœŸå€¤ã¯æ¨™æº–çš„ãª600pxï¼‰
const [appWidth, setAppWidth] = useState(() => localStorage.getItem("app_width") || "600px");
      const [groups, setGroups] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          return (Array.isArray(p.groups) && p.groups.length > 0) ? p.groups : DEFAULT_GROUPS;
        }
        return DEFAULT_GROUPS;
      });

      const [items, setItems] = useState([]);
      const [selectedGroup, setSelectedGroup] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          if (Array.isArray(p.groups) && p.groups.length > 0) return p.groups[0].name;
        }
        return "=Love";
      });
      
      const [selectedMember, setSelectedMember] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          if (Array.isArray(p.groups) && p.groups.length > 0 && p.groups[0].members.length > 0) return p.groups[0].members[0];
        }
        return "å¤§è°·æ˜ ç¾é‡Œ";
      });

      const [showOnlyWish, setShowOnlyWish] = useState(false);
      const [search, setSearch] = useState("");
      const [sortBy, setSortBy] = useState("new");
      const [activeModal, setActiveModal] = useState(null);
      
      const [editItemId, setEditItemId] = useState(null);
      const [editingNameId, setEditingNameId] = useState(null);
      const [targetName, setTargetName] = useState("");
      const [targetId, setTargetId] = useState(null); 
      const [errorMsg, setErrorMsg] = useState("");
      const [isManageMode, setIsManageMode] = useState(false);
      const [viewer, setViewer] = useState(null);
      const [tempImages, setTempImages] = useState([]);
      const [tempMainUrl, setTempMainUrl] = useState("");
      const [selectedItemIds, setSelectedItemIds] = useState([]);

      const showError = (msg) => { setErrorMsg(msg); setTimeout(() => setErrorMsg(""), 3000); };

      useEffect(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) { 
            const p = JSON.parse(raw); 
            if (Array.isArray(p.items)) setItems(p.items); 
          }
        } catch(e) { console.error(e); }
      }, []);

useEffect(() => { 
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items })); 
  localStorage.setItem("dark_mode", isDarkMode);
  localStorage.setItem("app_width", appWidth); // ã“ã®è¡Œã‚’è¿½åŠ 
}, [groups, items, isDarkMode, appWidth]); // appWidthã‚’ç›£è¦–å¯¾è±¡ã«è¿½åŠ 

      useEffect(() => {
        if (!isManageMode) setSelectedItemIds([]);
      }, [isManageMode]);

      const updateItem = useCallback((id, key, val) => {
        setItems(p => p.map(i => i.id === id ? { ...i, [key]: val } : i));
      }, []);

      const toggleSelectItem = (id) => {
        if (!isManageMode) return;
        setSelectedItemIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (selectedGroup === "ALL" || selectedMember === "ALL") { showError("ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„"); e.target.value = ""; return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const rows = parseCSV(ev.target.result);
            const now = Date.now();
            const newItems = rows.map((l, index) => {
              if (!l || l.length < 2) return null;
              const isShortFormat = l.length < 10;
              return {
                id: genId(),
                group: isShortFormat ? selectedGroup : (l[0] || selectedGroup),
                member: isShortFormat ? selectedMember : (l[1] || selectedMember),
                name: isShortFormat ? l[1] : (l[2] || "åç§°ãªã—"),
                thumbnail: isShortFormat ? l[0] : (l[7] || ""),
                otherImages: isShortFormat ? (l[2] ? l[2].split(/[\n ]+/) : []) : (l[11] ? l[11].split("|") : []),
                yori: isShortFormat ? 0 : (parseInt(l[3])||0), 
                chuu: isShortFormat ? 0 : (parseInt(l[4])||0), 
                hiki: isShortFormat ? 0 : (parseInt(l[5])||0),
                syori: isShortFormat ? 0 : (parseInt(l[12])||0),
                schuu: isShortFormat ? 0 : (parseInt(l[13])||0),
                shiki: isShortFormat ? 0 : (parseInt(l[14])||0),
                memo: isShortFormat ? "" : (l[6]||""),
                price: isShortFormat ? "" : (l[8]||"").slice(0, 6),
                source: isShortFormat ? "å…¥æ‰‹å…ˆ" : (l[9]||"å…¥æ‰‹å…ˆ"),
                isWish: isShortFormat ? false : (l[10]==="1"),
                createdAt: now - index
              };
            }).filter(Boolean);
            setItems(p => [...newItems, ...p]);
            showError(`${newItems.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
          } catch(err) { showError("CSVå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
        };
        reader.readAsText(file);
        e.target.value = "";
      };
// ã“ã“ã‹ã‚‰è¿½åŠ 
    const loadExternalTemplate = async () => {
      try {
        // åŒã˜éšå±¤ã«ã‚ã‚‹ template.csv ã‚’å–å¾—
        const response = await fetch('template.csv');
        if (!response.ok) throw new Error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        const now = Date.now();
        
        const newItems = rows.map((l, index) => {
          if (!l || l.length < 2) return null;
          // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã€Œã‚¬ãƒ.csvã€ã®ã‚ˆã†ãª3åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œ
          const isShortFormat = l.length < 10;
          return {
            id: genId(),
            group: isShortFormat ? selectedGroup : (l[0] || selectedGroup),
            member: isShortFormat ? selectedMember : (l[1] || selectedMember),
            name: isShortFormat ? l[1] : (l[2] || "åç§°ãªã—"),
            thumbnail: isShortFormat ? l[0] : (l[7] || ""),
            otherImages: isShortFormat ? (l[2] ? l[2].split(/[\n ]+/) : []) : (l[11] ? l[11].split("|") : []),
            yori: isShortFormat ? 0 : (parseInt(l[3])||0), 
            chuu: isShortFormat ? 0 : (parseInt(l[4])||0), 
            hiki: isShortFormat ? 0 : (parseInt(l[5])||0),
            syori: isShortFormat ? 0 : (parseInt(l[12])||0),
            schuu: isShortFormat ? 0 : (parseInt(l[13])||0),
            shiki: isShortFormat ? 0 : (parseInt(l[14])||0),
            memo: isShortFormat ? "" : (l[6]||""),
            price: isShortFormat ? "" : (l[8]||"").slice(0, 9),
            source: isShortFormat ? "å…¥æ‰‹å…ˆ" : (l[9]||"å…¥æ‰‹å…ˆ"),
            isWish: isShortFormat ? false : (l[10]==="1"),
            createdAt: now - index
          };
        }).filter(Boolean);

        setItems(p => [...newItems, ...p]);
        showError(`${newItems.length}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } catch (err) {
        showError("èª­ã¿è¾¼ã¿å¤±æ•—: " + err.message);
      }
    };
    // ã“ã“ã¾ã§è¿½åŠ 
      const sortedItems = useMemo(() => {
        let filtered = items.filter(i => 
          (selectedGroup === "ALL" || i.group === selectedGroup) && 
          (selectedMember === "ALL" || i.member === selectedMember) && 
          (i.name && i.name.toLowerCase().includes(search.toLowerCase())) && 
          (!showOnlyWish || i.isWish)
        );
        return filtered.sort((a, b) => {
          const aCount = (a.yori||0)+(a.chuu||0)+(a.hiki||0)+(a.syori||0)+(a.schuu||0)+(a.shiki||0);
          const bCount = (b.yori||0)+(b.chuu||0)+(b.hiki||0)+(b.syori||0)+(b.schuu||0)+(b.shiki||0);
          switch (sortBy) {
            case "name": return (a.name||"").localeCompare(b.name||"", 'ja');
            case "new": return (b.createdAt || 0) - (a.createdAt || 0);
            case "old": return (a.createdAt || 0) - (b.createdAt || 0);
            case "price_high": return (parseInt(b.price)||0) - (parseInt(a.price)||0);
            case "stock_high": return bCount - aCount;
            case "comp_first":
              const aComp = (a.yori>0||a.syori>0) && (a.chuu>0||a.schuu>0) && (a.hiki>0||a.shiki>0);
              const bComp = (b.yori>0||b.syori>0) && (b.chuu>0||b.schuu>0) && (b.hiki>0||b.shiki>0);
              return (bComp?1:0) - (aComp?1:0);
            default: return 0;
          }
        });
      }, [items, selectedGroup, selectedMember, search, showOnlyWish, sortBy]);

      const batchAction = (type) => {
        if (selectedItemIds.length === 0 || !isManageMode) return;
        if (type === 'delete') {
          setTargetName(`${selectedItemIds.length}ä»¶ã®é¸æŠé …ç›®`);
          setActiveModal('delete_batch');
        } else if (type === 'wish') {
          setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, isWish: true } : i));
          showError(`${selectedItemIds.length}ä»¶ã‚’â­ã«è¨­å®šã—ã¾ã—ãŸ`);
        } else if (type === 'stock') {
          setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, yori: (i.yori||0)+1, chuu: (i.chuu||0)+1, hiki: (i.hiki||0)+1 } : i));
          showError(`${selectedItemIds.length}ä»¶ã®åœ¨åº«ã‚’+1ã—ã¾ã—ãŸ`);
        }
      };

      const stats = useMemo(() => {
        const filtered = items.filter(i => (selectedGroup === "ALL" || i.group === selectedGroup) && (selectedMember === "ALL" || i.member === selectedMember));
        const totalKinds = filtered.length;
        const totalCount = filtered.reduce((s,i) => s + (parseInt(i.yori)||0) + (parseInt(i.chuu)||0) + (parseInt(i.hiki)||0) + (parseInt(i.syori)||0) + (parseInt(i.schuu)||0) + (parseInt(i.shiki)||0), 0);
        const totalSlots = totalKinds * 3;
        let collectedSlots = 0;
        let completedKinds = 0;
        filtered.forEach(i => {
          const hasYori = (i.yori > 0 || i.syori > 0);
          const hasChuu = (i.chuu > 0 || i.schuu > 0);
          const hasHiki = (i.hiki > 0 || i.shiki > 0);
          if (hasYori) collectedSlots++;
          if (hasChuu) collectedSlots++;
          if (hasHiki) collectedSlots++;
          if (hasYori && hasChuu && hasHiki) completedKinds++;
        });
        return { totalKinds, totalCount, totalSlots, collectedSlots, completedKinds };
      }, [items, selectedGroup, selectedMember]);

      const openEditImgModal = (item) => {
        setEditItemId(item.id);
        setTempMainUrl(item.thumbnail || "");
        setTempImages(item.otherImages || []);
        setActiveModal('edit_img');
      };

      const saveImages = () => {
        setItems(p => p.map(it => it.id === editItemId ? { ...it, thumbnail: tempMainUrl, otherImages: tempImages } : it));
        setActiveModal(null);
      };

      const handleCacheClear = () => {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n(ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“)")){
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      };

      return (
<div className={isDarkMode ? "dark-mode" : ""} style={{ 
  maxWidth: appWidth,   // è¨­å®šã•ã‚ŒãŸå¹…ã‚’é©ç”¨
  margin: '0 auto',     // ç”»é¢ä¸­å¤®ã«é…ç½®
  minHeight: '100vh',
  transition: 'max-width 0.3s' // åˆ‡ã‚Šæ›¿ãˆã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹
}}>
          {errorMsg && <div className="error-toast">âš ï¸ {errorMsg}</div>}
          <div className="top-bar">
            <h3>ç”Ÿå†™çœŸç®¡ç† made by @kken_owo for =Love</h3>
            <div style={{display:'flex', gap:8}}>
              <button className="csv-btn" onClick={() => {
                const csvData = items.map(i => [
                  i.group, i.member, i.name, i.yori, i.chuu, i.hiki, i.memo||"", i.thumbnail||"", i.price||"", i.source||"å…¥æ‰‹å…ˆ", i.isWish?"1":"0", (i.otherImages||[]).join("|"), i.syori||0, i.schuu||0, i.shiki||0
                ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
                const blob = new Blob([csvData], {type:"text/csv"});
                const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="photo_data.csv"; a.click();
              }}>å‡ºåŠ›</button>
             <label className="import-label">å–è¾¼
  <input type="file" accept=".csv" style={{display:'none'}} onChange={handleImportCSV} />
</label>
<button className="template-btn" onClick={loadExternalTemplate} style={{marginLeft: '4px'}}>ãƒ†ãƒ³ãƒ—ãƒ¬èª­è¾¼</button>
              <button className="settings-btn" onClick={() => setActiveModal('app_settings')}>âš™ï¸</button>
              <button onClick={()=>setIsDarkMode(!isDarkMode)} style={{padding:'6px 8px'}}>{isDarkMode?"â˜€ï¸":"ğŸŒ™"}</button>
            </div>
          </div>

          <div className="main-layout">
            <div className="stats-card">
              <div className="stats-summary">
                <div style={{textAlign:'center'}}><span style={{fontSize:10, color:'#888'}}>ç¨®é¡</span><br/><b>{stats.totalKinds}</b></div>
                <div style={{textAlign:'center'}}><span style={{fontSize:10, color:'#888'}}>åˆè¨ˆæšæ•°</span><br/><b>{stats.totalCount}</b></div>
              </div>
              <div className="stats-charts-grid">
                <div className="stats-box" style={{background:'rgba(76,175,80,0.08)'}}>
                  <span className="stats-label" style={{color:'#2e7d32'}}>åé›†ç‡</span>
                  <MiniChart percent={stats.totalSlots?Math.round((stats.collectedSlots/stats.totalSlots)*100):0} color="#4caf50" isDarkMode={isDarkMode} />
                  <div className="stats-fraction">{stats.collectedSlots} / {stats.totalSlots}</div>
                </div>
                <div className="stats-box" style={{background:'rgba(251,192,45,0.08)'}}>
                  <span className="stats-label" style={{color:'#f57f17'}}>ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</span>
                  <MiniChart percent={stats.totalKinds?Math.round((stats.completedKinds/stats.totalKinds)*100):0} color="#fbc02d" isDarkMode={isDarkMode} />
                  <div className="stats-fraction">{stats.completedKinds} / {stats.totalKinds}</div>
                </div>
              </div>
            </div>

            <div className="control-panel">
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10}}>
                <span style={{fontSize:11, fontW:'bold', color: isManageMode ? '#ff5252' : '#888'}}>{isManageMode ? 'ã€ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼šä¸€æ‹¬æ“ä½œæœ‰åŠ¹ã€‘' : 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼'}</span>
                <button style={{background:'none', border:'none', cursor:'pointer', fontSize:20}} onClick={() => setIsManageMode(!isManageMode)}>{isManageMode ? 'âœ“' : 'ğŸ› ï¸'}</button>
              </div>
              <div className="filter-row">
                <input type="text" placeholder=" åå‰æ¤œç´¢" value={search} onChange={e=>setSearch(e.target.value)} style={{flex:2, margin:0}} />
                <button className={`btn-item ${showOnlyWish ? 'active' : ''}`} onClick={() => setShowOnlyWish(!showOnlyWish)}>ãŠæ°—ã«å…¥ã‚Š</button>
                <select className="sort-select" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
                  <option value="new">æ–°ã—ã„é †</option>
                  <option value="old">å¤ã„é †</option>
                  <option value="name">åå‰é †</option>
                  <option value="price_high">ä¾¡æ ¼é«˜é †</option>
                  <option value="stock_high">æšæ•°å¤šé †</option>
                  <option value="comp_first">ã‚³ãƒ³ãƒ—é †</option>
                </select>
              </div>
              <strong>Group:</strong> {groups.map(g => (
                <button key={g.name} className={`btn-item ${selectedGroup === g.name ? "active" : ""}`} onClick={() => { if(!isManageMode){setSelectedGroup(g.name); setSelectedMember("ALL"); setSelectedItemIds([]);} }}>
                  {g.name}{isManageMode && <span className="btn-delete-small" onClick={(e)=>{ e.stopPropagation(); setTargetName(g.name); setActiveModal('delete_group'); }}>âœ•</span>}
                </button>
              ))}
              <button className="btn-item" onClick={()=>setActiveModal('add_group')}>ï¼‹</button>
              <br/><div style={{marginTop:8}}><strong>Member:</strong> 
              {(selectedGroup !== "ALL" ? (groups.find(g=>g.name===selectedGroup)?.members || []) : []).map(m => (
                <button key={m} className={`btn-item ${selectedMember === m ? "active" : ""}`} onClick={() => { if(!isManageMode) {setSelectedMember(m); setSelectedItemIds([]);} }}>
                  {m}{isManageMode && <span className="btn-delete-small" onClick={(e)=>{ e.stopPropagation(); setTargetName(m); setActiveModal('delete_member'); }}>âœ•</span>}
                </button>
              ))}
              <button className="btn-item" onClick={()=>{ if(selectedGroup === "ALL") return showError("å…ˆã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ"); setActiveModal('add_member'); }}>ï¼‹</button>
              </div>
            </div>

            {selectedGroup !== "ALL" && selectedMember !== "ALL" && (
              <button className="add-trigger-btn" onClick={() => setActiveModal('add_photo')}>ï¼‹ ç”Ÿå†™çœŸã‚’è¿½åŠ </button>
            )}

            {sortedItems.map(i => {
              const comp = (i.yori>0||i.syori>0) && (i.chuu>0||i.schuu>0) && (i.hiki>0||i.shiki>0);
              const isSelected = selectedItemIds.includes(i.id);
              return (
                <div key={i.id} className={`photo-card ${comp ? 'is-complete' : ''} ${i.isWish ? 'is-wish' : ''}`} style={{background: (isManageMode && isSelected) ? 'rgba(255, 82, 82, 0.1)' : ''}}>
                  <div style={{display:'flex', flexDirection:'column', alignItems:'center', gap:10}}>
                    {isManageMode && <input type="checkbox" className="selection-checkbox" checked={isSelected} onChange={() => toggleSelectItem(i.id)} />}
                    <div className="img-container">
                      <div className="btn-img-add" onClick={() => openEditImgModal(i)}>ï¼‹</div>
                      <div style={{width:65, cursor:'pointer'}} onClick={() => {
                        const imgs = [i.thumbnail, ...(i.otherImages||[])].filter(Boolean);
                        if(imgs.length) setViewer({ images: imgs, index: 0, name: i.name });
                        else openEditImgModal(i);
                      }}>
                        {i.thumbnail ? <img src={i.thumbnail} style={{width:'100%', borderRadius:4}} /> : <div style={{background:'#eee', height:60, borderRadius:4, fontSize:8, textAlign:'center', display:'flex', alignItems:'center', justifyContent:'center', color:'#888'}}>ç”»åƒãªã—</div>}
                      </div>
                    </div>
                  </div>
                  <div className="card-content">
                    <div style={{display:'flex', justifyBetween:'space-between', alignItems:'center'}}>
                      <div style={{flex: 1, minWidth: 0, display:'flex', alignItems:'center', gap:8}}>
                        <button className={`wish-toggle ${i.isWish ? 'active' : ''}`} onClick={() => updateItem(i.id, 'isWish', !i.isWish)}>â­</button>
                        {editingNameId === i.id ? (
  <input 
    className="edit-name-input"
    autoFocus 
    value={i.name} 
    onChange={e => updateItem(i.id, 'name', e.target.value)} 
    onBlur={() => setEditingNameId(null)}
    onKeyDown={e => { if(e.key === 'Enter') setEditingNameId(null); }}
  />
) : (
  <span className="name-display" onClick={() => setEditingNameId(i.id)}>
    {i.name} {comp && "ğŸ‘ï¸"}
  </span>
)}

                      </div>
                      <button onClick={()=>{ setTargetName(i.name); setTargetId(i.id); setActiveModal('delete_photo'); }} style={{color:'#999', border:'none', background:'none', cursor:'pointer'}}>âœ•</button>
                    </div>
                    <div style={{display:'flex', gap:4, flexWrap:'wrap'}}>
                      {[ {k:'yori', l:'å¯„'}, {k:'chuu', l:'ä¸­'}, {k:'hiki', l:'å¼•'} ].map(o => (
                        <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-stock' : ''}`}>
                          <span style={{fontSize: 9, padding:'0 4px', fontW:'bold'}}>{o.l}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                          <span className="qty-val">{i[o.k]||0}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, (parseInt(i[o.k])||0)+1)}>+</button>
                        </div>
                      ))}
                    </div>
                    <div style={{display:'flex', gap:4, flexWrap:'wrap'}}>
                      {[ {k:'syori', l:'ã‚µã‚¤ãƒ³å¯„'}, {k:'schuu', l:'ã‚µã‚¤ãƒ³ä¸­'}, {k:'shiki', l:'ã‚µã‚¤ãƒ³å¼•'} ].map(o => (
                        <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-sign' : ''}`}>
                          <span style={{fontSize: 9, padding:'0 4px', fontW:'bold'}}>{o.l}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                          <span className="qty-val">{i[o.k]||0}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, (parseInt(i[o.k])||0)+1)}>+</button>
                        </div>
                      ))}
                    </div>
                    <div className="row-inputs">
                      <select className="source-select" value={i.source || "å…¥æ‰‹å…ˆ"} onChange={e=>updateItem(i.id, 'source', e.target.value)}>
                        {SOURCE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                      <input className="details-input" style={{flex: 1}} placeholder="ãƒ¡ãƒ¢" value={i.memo||""} onChange={e=>updateItem(i.id,'memo',e.target.value)} />
                      <div className="price-wrapper">
                        <input className="details-input" style={{width:'100%'}} placeholder="ä¾¡æ ¼" 
                          value={formatWithComma(i.price)} 
                          onChange={e => updateItem(i.id, 'price', e.target.value.replace(/\D/g,'').slice(0, 9))} />
                        <span className="currency-unit">å††</span>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {isManageMode && sortedItems.length > 0 && (
            <div className="selection-bar">
              <div style={{display:'flex', alignItems:'center', gap:10}}>
                <input type="checkbox" className="selection-checkbox" checked={selectedItemIds.length > 0 && selectedItemIds.length === sortedItems.length} onChange={(e) => {
                  if(e.target.checked) setSelectedItemIds(sortedItems.map(it => it.id));
                  else setSelectedItemIds([]);
                }} />
                <span style={{fontSize:12, fontW:'bold'}}>{selectedItemIds.length}ä»¶é¸æŠä¸­</span>
              </div>
              <div style={{display:'flex', gap:8}}>
                <button className="batch-btn" onClick={() => batchAction('wish')}>ä¸€æ‹¬</button>
                <button className="batch-btn" onClick={() => batchAction('stock')}>ã™ã¹ã¦+1</button>
                <button className="batch-btn" style={{background:'#000'}} onClick={() => batchAction('delete')}>å‰Šé™¤</button>
              </div>
            </div>
          )}

          {viewer && (
            <div className="lightbox" onClick={() => setViewer(null)}>
              <div className="lightbox-close">Ã—</div>
              <img src={viewer.images[viewer.index]} onClick={(e) => { e.stopPropagation(); setViewer({ ...viewer, index: (viewer.index + 1) % viewer.images.length }); }} />
              <div className="lightbox-info"><strong>{viewer.name}</strong><br/>{viewer.index + 1} / {viewer.images.length}</div>
            </div>
          )}

          {activeModal && (
            <div className="modal-overlay" onClick={()=>setActiveModal(null)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
{activeModal === 'app_settings' && (
  <div>
    <h3 style={{margin:'0 0 15px 0'}}>ã‚¢ãƒ—ãƒªè¨­å®š</h3>
    
    {/* --- å¹…é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ  --- */}
    <div style={{marginBottom: '15px', padding: '0 10px'}}>
      <label style={{fontSize: '12px', display: 'block', marginBottom: '5px', color: '#888'}}>è¡¨ç¤ºå¹…ã®å¤‰æ›´:</label>
      <select 
        value={appWidth} 
        onChange={(e) => setAppWidth(e.target.value)} 
        style={{width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #ccc'}}
      >
        <option value="450px">ã‚¹ãƒªãƒ  (ã‚¹ãƒãƒ›å‘ã)</option>
        <option value="600px">æ¨™æº–</option>
        <option value="850px">ãƒ¯ã‚¤ãƒ‰ (PCå‘ã)</option>
        <option value="100%">ãƒ•ãƒ«ç”»é¢</option>
      </select>
    </div>
    {/* ------------------------- */}

    <ul className="settings-list">
                      <li onClick={handleCacheClear}>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰å‰Šé™¤</li>
                      <li onClick={() => alert("è¦ç´„ï¼›ã“ã®ã‚µã‚¤ãƒˆã¯å€‹äººã®è‡ªå·±æº€è¶³ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã«ã¤ãã¾ã—ã¦ã¯ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚ã¾ãŸä»£ã€…æœ¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ§˜ã€ã¾ãŸ=Loveæ§˜ã®è¦æœ›ãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã®ã™ã¹ã¦ã®æ¨©åˆ©ãªã©ã‚’è­²æ¸¡ã—ã¾ã™ã€‚ã¾ãŸã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã«ç½®ãã¾ã—ã¦åˆ©ç›Šã‚’å¾—ã‚‹ã“ã¨ã¯ã„ãŸã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚")}>è¦ç´„</li>
                      <li onClick={() => window.open("https://github.com/Meowx7", "_blank")}>GitHub</li>
                      <li style={{color:'#888', cursor:'default'}}>Version 1.4.1</li>
                    </ul>
                    <button onClick={()=>setActiveModal(null)} style={{width:'100%', padding:12, background:'#eee', border:'none', borderRadius:8}}>é–‰ã˜ã‚‹</button>
                  </div>
                )}
                {activeModal === 'add_photo' && (
                  <div>
                    <h3>æ–°è¦è¿½åŠ </h3>
                    <input type="text" placeholder="ç”Ÿå†™çœŸã‚»ãƒƒãƒˆå" id="modal_name" autoFocus />
                    <button onClick={() => {
                      const v = document.getElementById("modal_name").value;
                      if(v) { setItems(p => [{ id: genId(), group: selectedGroup, member: selectedMember, name: v, yori: 0, chuu: 0, hiki: 0, syori: 0, schuu: 0, shiki: 0, isWish: false, createdAt: Date.now(), memo: "", price: "", source: "å…¥æ‰‹å…ˆ", thumbnail: "", otherImages: [] }, ...p]); setActiveModal(null); }
                    }} style={{width:'100%', padding:12, background:'#2196f3', color:'#fff', border:'none', borderRadius:8, marginTop:10}}>è¿½åŠ </button>
                  </div>
                )}
                {activeModal === 'add_group' && (
                  <div>
                    <h3>ã‚°ãƒ«ãƒ¼ãƒ—</h3><input type="text" autoFocus onKeyDown={e=>{
                      if(e.key==='Enter'){
                        const val = e.target.value.trim();
                        if(!val) return showError("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                        setGroups(p=>[...p,{name:val,members:[]}]); setActiveModal(null); 
                      }
                    }} />
                  </div>
                )}
                {activeModal === 'add_member' && (
                  <div>
                    <h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{
                      if(e.key==='Enter'){
                        const val = e.target.value.trim();
                        if(!val) return showError("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                        setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:[...g.members,val]}:g)); setActiveModal(null);
                      }
                    }} />
                  </div>
                )}
                {activeModal === 'edit_img' && (
                  <div>
                    <h3>ç”»åƒç®¡ç†</h3>
                    <div style={{display:'grid', gridTemplateColumns:'repeat(3,1fr)', gap:8, marginBottom:10}}>
                      {tempMainUrl && <div style={{position:'relative'}}><img src={tempMainUrl} style={{width:'100%', height:60, objectFit:'cover', borderRadius:4}}/><button onClick={()=>setTempMainUrl("")} style={{position:'absolute', top:0, right:0, background:'red', color:'white', border:'none'}}>Ã—</button></div>}
                      {tempImages.map((u,idx)=><div key={idx} style={{position:'relative'}}><img src={u} style={{width:'100%', height:60, objectFit:'cover', borderRadius:4}}/><button onClick={()=>setTempImages(p=>p.filter((_,i)=>i!==idx))} style={{position:'absolute', top:0, right:0, background:'red', color:'white', border:'none'}}>Ã—</button></div>)}
                    </div>
                    <label style={{display:'block', padding:10, background:'#2196f3', color:'white', textAlign:'center', borderRadius:8, cursor:'pointer', marginBottom:10}}>
                      ç«¯æœ«ã‹ã‚‰é¸æŠ<input type="file" multiple style={{display:'none'}} onChange={async(e)=>{
                        const files = Array.from(e.target.files);
                        for(const f of files){ const c = await compressImage(f); if(!tempMainUrl) setTempMainUrl(c); else setTempImages(p=>[...p,c]); }
                      }}/>
                    </label>
                    <input type="text" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘ã¦Enter" onKeyDown={e=>{ if(e.key==='Enter' && e.target.value){ const urls = e.target.value.split(/[, \n]+/).filter(Boolean); urls.forEach(u => { if(!tempMainUrl) setTempMainUrl(u); else setTempImages(p=>[...p,u]); }); e.target.value=""; } }}/>
                    <button onClick={saveImages} style={{width:'100%', padding:12, background:'#4caf50', color:'#fff', border:'none', borderRadius:8, marginTop:10}}>ä¿å­˜</button>
                  </div>
                )}
                {activeModal === 'delete_group' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.group!==targetName)); setGroups(p=>p.filter(g=>g.name!==targetName));
                      if(selectedGroup===targetName) {setSelectedGroup("ALL"); setSelectedMember("ALL");} setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_member' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.member!==targetName)); setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:g.members.filter(m=>m!==targetName)}:g));
                      if(selectedMember===targetName) setSelectedMember("ALL"); setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_photo' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.id!==targetId));
                      setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_batch' && (
                  <div><h3>{targetName}ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p => p.filter(i => !selectedItemIds.includes(i.id)));
                      setSelectedItemIds([]);
                      setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#000', color:'#fff', border:'none', borderRadius:8}}>ä¸€æ‹¬å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
