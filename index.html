<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç”Ÿå†™çœŸç®¡ç†For=Love</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <link rel="stylesheet" href="style.css" />
  
  <!-- Firebaseã¨Googleãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ  -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC183tcN__mG5zNx2FG__9g3zkZWpszJ_k",
    authDomain: "picturemanager-f139d.firebaseapp.com",
    projectId: "picturemanager-f139d",
    storageBucket: "picturemanager-f139d.firebasestorage.app",
    messagingSenderId: "893316957167",
    appId: "1:893316957167:web:1cddf45fd9fd0e9145ac1a"
  };
  const app = initializeApp(firebaseConfig);
  window.fb = {
    db: getFirestore(app),
    auth: getAuth(app),
    provider: new GoogleAuthProvider(),
    doc, setDoc, onSnapshot, signInWithPopup, signOut, onAuthStateChanged, getDoc
  };
</script>

<style>
  /* ã‚¹ãƒãƒ›ç”¨ã®æŠ˜ã‚ŠãŸãŸã¿ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
  @media (max-width: 768px) {
    .sign-counters-container {
      position: relative;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .sign-counters-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: #f9f9f9;
      border: none;
      width: 100%;
      text-align: left;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }
    
    .sign-counters-toggle:after {
      content: 'â–¼';
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .sign-counters-toggle.active:after {
      transform: rotate(180deg);
    }
    
    .sign-counters-content {
      display: none;
      padding: 8px;
      background: #fff;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .sign-counters-content.expanded {
      display: flex;
    }
  }
</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;
    const STORAGE_KEY = "photocard_inventory_v3_manage_plus";
    const genId = () => 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const SOURCE_OPTIONS = ["å…¥æ‰‹å…ˆ", "ãƒ¡ãƒ«ã‚«ãƒª", "è‡ªå¼•ã", "åº—èˆ—", "è­²æ¸¡", "ãã®ä»–"];

    const DEFAULT_GROUPS = [{ name: "=Love", members: ["å¤§è°·æ˜ ç¾é‡Œ"] }];

    // åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
    const AVAILABLE_TEMPLATES = [
      'template.csv',
      'template1.csv',
      'template2.csv', 
      'template3.csv',
      'template4.csv',
      'template5.csv'
    ];

    const formatWithComma = (val) => {
      if (!val) return "";
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };

    // ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼ˆTSVï¼‰ã¨ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆCSVï¼‰ä¸¡æ–¹ã«å¯¾å¿œã—ãŸãƒ‘ãƒ¼ã‚µãƒ¼
    function parseCSV(text, delimiter = '\t') {
      if (!text) return [];
      const rows = []; 
      let row = []; 
      let field = ''; 
      let inQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const c = text[i], next = text[i+1];
        
        if (inQuotes) {
          if (c === '"' && next === '"') { 
            field += '"'; 
            i++; 
          } else if (c === '"') {
            inQuotes = false;
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === delimiter) { 
            row.push(field.trim()); 
            field = ''; 
          } else if (c === '\n' || c === '\r') {
            if (field || row.length) { 
              row.push(field.trim()); 
              rows.push(row); 
            }
            row = []; 
            field = ''; 
            if (c === '\r' && next === '\n') i++;
          } else {
            field += c;
          }
        }
      }
      
      if (field || row.length) { 
        row.push(field.trim()); 
        rows.push(row); 
      }
      
      return rows;
    }

    // ã‚¿ãƒ–åŒºåˆ‡ã‚ŠCSVï¼ˆã‚µãƒ³ãƒ—ãƒ«å½¢å¼ï¼‰ã‚’ã‚¢ã‚¤ãƒ†ãƒ ã«å¤‰æ›
    const parseTabCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
      if (!row || row.length < 2) return null;
      
      const now = Date.now();
      const createdAt = now - index;
      
      // ã‚¿ãƒ–åŒºåˆ‡ã‚ŠCSVå½¢å¼: [thumbnail, name, otherImages]
      // ã‚µãƒ³ãƒ—ãƒ«ã§ã¯3åˆ—ç›®ã«æ”¹è¡ŒåŒºåˆ‡ã‚Šã®è¤‡æ•°URLãŒã‚ã‚‹
      const thumbnail = row[0] || "";
      const name = row[1] || "åç§°ãªã—";
      let otherImages = [];
      
      if (row.length > 2 && row[2]) {
        // 3åˆ—ç›®ã¯è¤‡æ•°è¡Œã®URLï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰
        // ã‚¯ã‚©ãƒ¼ãƒˆã‚„ä½™åˆ†ãªç©ºç™½ã‚’å‡¦ç†
        const imagesText = row[2].replace(/"/g, '').trim();
        if (imagesText) {
          otherImages = imagesText.split(/\r?\n/).map(url => url.trim()).filter(url => url);
        }
      }
      
      return {
        id: genId(),
        group: selectedGroup,
        member: selectedMember,
        name: name,
        thumbnail: thumbnail,
        otherImages: otherImages,
        yori: 0, 
        chuu: 0, 
        hiki: 0,
        syori: 0,
        schuu: 0,
        shiki: 0,
        memo: "",
        price: "",
        source: "å…¥æ‰‹å…ˆ",
        isWish: false,
        createdAt
      };
    };

    // æ—¢å­˜ã®ã‚«ãƒ³ãƒåŒºåˆ‡ã‚ŠCSVç”¨ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
    const parseCommaCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
      if (!row || row.length < 2) return null;
      
      const now = Date.now();
      const createdAt = now - index;
      const isShortFormat = row.length < 10;
      
      if (isShortFormat) {
        return {
          id: genId(),
          group: selectedGroup,
          member: selectedMember,
          name: row[1] || "åç§°ãªã—",
          thumbnail: row[0] || "",
          otherImages: row[2] ? row[2].split(/[\n ]+/) : [],
          yori: 0, 
          chuu: 0, 
          hiki: 0,
          syori: 0,
          schuu: 0,
          shiki: 0,
          memo: "",
          price: "",
          source: "å…¥æ‰‹å…ˆ",
          isWish: false,
          createdAt
        };
      } else {
        return {
          id: genId(),
          group: row[0] || selectedGroup,
          member: row[1] || selectedMember,
          name: row[2] || "åç§°ãªã—",
          thumbnail: row[7] || "",
          otherImages: row[11] ? row[11].split("|") : [],
          yori: parseInt(row[3]) || 0, 
          chuu: parseInt(row[4]) || 0, 
          hiki: parseInt(row[5]) || 0,
          syori: parseInt(row[12]) || 0,
          schuu: parseInt(row[13]) || 0,
          shiki: parseInt(row[14]) || 0,
          memo: row[6] || "",
          price: (row[8] || "").slice(0, 9),
          source: row[9] || "å…¥æ‰‹å…ˆ",
          isWish: row[10] === "1",
          createdAt
        };
      }
    };

    function MiniChart({ percent, color, isDarkMode }) {
      const r = 18; const c = 2 * Math.PI * r;
      const p = isNaN(percent) ? 0 : percent;
      return (
        <svg width="40" height="40" viewBox="0 0 40 40">
          <circle cx="20" cy="20" r={r} stroke={isDarkMode ? "#333" : "#eee"} strokeWidth="4" fill="none" />
          <circle cx="20" cy="20" r={r} stroke={color} strokeWidth="4" fill="none"
            strokeDasharray={`${(p / 100) * c} ${c}`} transform="rotate(-90 20 20)" strokeLinecap="round" />
        </svg>
      );
    }

    const compressImage = (file, maxWidth = 500) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale; canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => resolve("");
        };
      });
    };

    function App() {
      const [user, setUser] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [lastSaved, setLastSaved] = useState(null);
      const [availableTemplates, setAvailableTemplates] = useState([]);
      
      const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem("dark_mode") === "true");
      const quickBtnStyle = (isDark) => ({
        flex: 1,
        padding: '8px 0',
        fontSize: '11px',
        borderRadius: '6px',
        border: '1px solid ' + (isDark ? '#444' : '#ccc'),
        background: isDark ? '#333' : '#fff',
        color: isDark ? '#fff' : '#333',
        cursor: 'pointer'
      });
      const [appWidth, setAppWidth] = useState(() => localStorage.getItem("app_width") || "600px");
      
      const [groups, setGroups] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          return (Array.isArray(p.groups) && p.groups.length > 0) ? p.groups : DEFAULT_GROUPS;
        }
        return DEFAULT_GROUPS;
      });

      const [items, setItems] = useState([]);
      const [selectedGroup, setSelectedGroup] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          if (Array.isArray(p.groups) && p.groups.length > 0) return p.groups[0].name;
        }
        return "=Love";
      });
      
      const [selectedMember, setSelectedMember] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          if (Array.isArray(p.groups) && p.groups.length > 0 && p.groups[0].members.length > 0) return p.groups[0].members[0];
        }
        return "å¤§è°·æ˜ ç¾é‡Œ";
      });

      const [showOnlyWish, setShowOnlyWish] = useState(false);
      const [search, setSearch] = useState("");
      const [sortBy, setSortBy] = useState("new");
      const [activeModal, setActiveModal] = useState(null);
      
      const [editItemId, setEditItemId] = useState(null);
      const [editingNameId, setEditingNameId] = useState(null);
      const [targetName, setTargetName] = useState("");
      const [targetId, setTargetId] = useState(null); 
      const [errorMsg, setErrorMsg] = useState("");
      const [isManageMode, setIsManageMode] = useState(false);
      const [viewer, setViewer] = useState(null);
      const [tempImages, setTempImages] = useState([]);
      const [tempMainUrl, setTempMainUrl] = useState("");
      const [selectedItemIds, setSelectedItemIds] = useState([]);
      const [expandedSignItems, setExpandedSignItems] = useState([]); // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ç®¡ç†

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¡Œã†é–¢æ•°
      const checkTemplateFiles = useCallback(async () => {
        const existingTemplates = [];
        
        for (const fileName of AVAILABLE_TEMPLATES) {
          try {
            const response = await fetch(fileName, { method: 'HEAD' });
            if (response.ok) {
              existingTemplates.push(fileName);
            }
          } catch (error) {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã¨åˆ¤æ–­
            console.log(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã¯å­˜åœ¨ã—ã¾ã›ã‚“`);
          }
        }
        
        setAvailableTemplates(existingTemplates);
        console.log(`åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ${existingTemplates.length}ä»¶`, existingTemplates);
      }, []);

      // Firebaseã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹useEffect
      useEffect(() => {
        if (!window.fb) {
          setIsAuthReady(true);
          return;
        }
        const unsubscribe = window.fb.onAuthStateChanged(window.fb.auth, async (currentUser) => {
          setUser(currentUser);
          setIsAuthReady(true);
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
          if (currentUser) {
            await loadFromFirestore(currentUser.uid);
          }
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¡Œã†
          checkTemplateFiles();
        });
        return () => unsubscribe();
      }, [checkTemplateFiles]);

      // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      const loadFromFirestore = async (userId) => {
        try {
          setIsLoading(true);
          const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
          const docSnap = await window.fb.getDoc(docRef);
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            console.log("Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:", data);
            
            if (Array.isArray(data.groups) && data.groups.length > 0) {
              setGroups(data.groups);
              setSelectedGroup(data.groups[0].name);
              if (data.groups[0].members.length > 0) {
                setSelectedMember(data.groups[0].members[0]);
              }
            }
            
            if (Array.isArray(data.items)) {
              setItems(data.items);
            }
            
            showError("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            setLastSaved(new Date().toLocaleTimeString());
          } else {
            console.log("Firestoreã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚");
            // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜
            await saveToFirestore(userId);
          }
        } catch (error) {
          console.error("Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
          showError("ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        } finally {
          setIsLoading(false);
        }
      };

      // ä¿®æ­£ã—ãŸä¿å­˜é–¢æ•°ã®ä¾‹
      const saveToFirestore = async (userId) => {
        try {
          console.log("ä¿å­˜é–‹å§‹:", userId);
          
          const dataToSave = {
            groups,
            items,
            lastUpdated: new Date().toISOString()
          };
          
          const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
          
          // Firestoreã«ä¿å­˜
          await window.fb.setDoc(docRef, dataToSave, { merge: true });
          
          console.log("ä¿å­˜æˆåŠŸ");
          setErrorMsg("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ âœ“");
          setLastSaved(new Date().toLocaleTimeString());
          
        } catch (error) {
          console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
          
          // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if (error.code === 'permission-denied') {
            setErrorMsg("âŒ ä¿å­˜æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
          } else if (error.code === 'unavailable') {
            setErrorMsg("ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
          } else {
            setErrorMsg(`ä¿å­˜å¤±æ•—: ${error.message}`);
          }
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items }));
        }
      };

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
      useEffect(() => { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items })); 
        localStorage.setItem("dark_mode", isDarkMode);
        localStorage.setItem("app_width", appWidth);
      }, [groups, items, isDarkMode, appWidth]);

      // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•ã§Firestoreã«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ä»˜ãï¼‰
      useEffect(() => {
        if (!user) return;
        
        const timer = setTimeout(() => {
          saveToFirestore(user.uid);
        }, 2000); // 2ç§’é–“éš”ã§è‡ªå‹•ä¿å­˜
        
        return () => clearTimeout(timer);
      }, [groups, items, user]);

      // Googleãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
      const handleGoogleLogin = async () => {
        try {
          const result = await window.fb.signInWithPopup(window.fb.auth, window.fb.provider);
          console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", result.user);
        } catch (error) {
          console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
          showError("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      };

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      const handleLogout = async () => {
        try {
          // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‰ã«ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items }));
          await window.fb.signOut(window.fb.auth);
        } catch (error) {
          console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          showError("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      };

      // æ‰‹å‹•ã§Firestoreã«ä¿å­˜
      const handleManualSave = async () => {
        if (!user) {
          showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
          return;
        }
        await saveToFirestore(user.uid);
      };

      // æ‰‹å‹•ã§Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿
      const handleManualLoad = async () => {
        if (!user) {
          showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
          return;
        }
        await loadFromFirestore(user.uid);
      };

      const showError = (msg) => { setErrorMsg(msg); setTimeout(() => setErrorMsg(""), 3000); };

      const updateItem = useCallback((id, key, val) => {
        setItems(p => p.map(i => i.id === id ? { ...i, [key]: val } : i));
      }, []);

      const toggleSelectItem = (id) => {
        if (!isManageMode) return;
        setSelectedItemIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      };

      const toggleSignCounters = (id) => {
        setExpandedSignItems(prev => 
          prev.includes(id) ? prev.filter(itemId => itemId !== id) : [...prev, id]
        );
      };

      const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (selectedGroup === "ALL" || selectedMember === "ALL") { 
          showError("ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„"); 
          e.target.value = ""; 
          return; 
        }
        
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = ev.target.result;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’è‡ªå‹•åˆ¤å®šï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šã‹ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã‹ï¼‰
            const hasTabs = text.includes('\t');
            const delimiter = hasTabs ? '\t' : ',';
            
            console.log(`CSVå½¢å¼ã‚’æ¤œå‡º: ${hasTabs ? 'ã‚¿ãƒ–åŒºåˆ‡ã‚Š' : 'ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š'}`);
            
            const rows = parseCSV(text, delimiter);
            console.log(`èª­ã¿è¾¼ã‚“ã è¡Œæ•°: ${rows.length}`);
            
            // å…ˆé ­è¡Œã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
            if (rows.length > 0) {
              console.log("æœ€åˆã®è¡Œ:", rows[0]);
              console.log("åˆ—æ•°:", rows[0].length);
            }
            
            const newItems = rows.map((row, index) => {
              if (hasTabs) {
                // ã‚¿ãƒ–åŒºåˆ‡ã‚Šå½¢å¼ã®å ´åˆ
                return parseTabCSVRowToItem(row, selectedGroup, selectedMember, index);
              } else {
                // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå½¢å¼ã®å ´åˆ
                return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, index);
              }
            }).filter(Boolean);
            
            console.log(`å¤‰æ›ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ æ•°: ${newItems.length}`);
            if (newItems.length > 0) {
              console.log("æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ :", newItems[0]);
            }
            
            setItems(p => [...newItems, ...p]);
            showError(`${newItems.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ (${hasTabs ? 'ã‚¿ãƒ–åŒºåˆ‡ã‚Š' : 'ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š'})`);
          } catch(err) { 
            console.error("CSVè§£æã‚¨ãƒ©ãƒ¼:", err);
            showError("CSVå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: " + err.message); 
          }
        };
        reader.readAsText(file, 'UTF-8');
        e.target.value = "";
      };

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
      const loadExternalTemplate = async (fileName) => {
        try {
          setIsLoading(true);
          const response = await fetch(fileName);
          if (!response.ok) {
            throw new Error(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(${fileName})ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`);
          }
          
          const csvText = await response.text();
          
          // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’è‡ªå‹•åˆ¤å®š
          const hasTabs = csvText.includes('\t');
          const delimiter = hasTabs ? '\t' : ',';
          
          const rows = parseCSV(csvText, delimiter);
          
          const newItems = rows.map((row, index) => {
            if (hasTabs) {
              return parseTabCSVRowToItem(row, selectedGroup, selectedMember, index);
            } else {
              return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, index);
            }
          }).filter(Boolean);

          setItems(p => [...newItems, ...p]);
          showError(`${newItems.length}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${fileName})`);
          setActiveModal(null);
        } catch (err) {
          console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
          showError(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`);
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ãƒã‚§ãƒƒã‚¯
          checkTemplateFiles();
        } finally {
          setIsLoading(false);
        }
      };

      // CSVå‡ºåŠ›é–¢æ•°
      const handleCSVExport = () => {
        const csvData = items.map(i => [
          i.group, i.member, i.name, i.yori, i.chuu, i.hiki, i.memo||"", i.thumbnail||"", i.price||"", i.source||"å…¥æ‰‹å…ˆ", i.isWish?"1":"0", (i.otherImages||[]).join("|"), i.syori||0, i.schuu||0, i.shiki||0
        ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csvData], {type:"text/csv;charset=utf-8;"});
        const a = document.createElement("a"); 
        a.href = URL.createObjectURL(blob); 
        a.download="photo_data.csv"; 
        a.click();
      };

      // TSVå‡ºåŠ›é–¢æ•°ï¼ˆã‚µãƒ³ãƒ—ãƒ«å½¢å¼ã¨åŒã˜å½¢å¼ã§å‡ºåŠ›ï¼‰
      const handleTSVExport = () => {
        const tsvData = items.map(i => {
          const thumbnail = i.thumbnail || "";
          const name = i.name || "";
          const otherImages = (i.otherImages || []).join("\n");
          return `${thumbnail}\t${name}\t"${otherImages}"`;
        }).join("\n");
        
        const blob = new Blob([tsvData], {type:"text/tab-separated-values;charset=utf-8;"});
        const a = document.createElement("a"); 
        a.href = URL.createObjectURL(blob); 
        a.download="photo_data.tsv"; 
        a.click();
      };

      const sortedItems = useMemo(() => {
        let filtered = items.filter(i => 
          (selectedGroup === "ALL" || i.group === selectedGroup) && 
          (selectedMember === "ALL" || i.member === selectedMember) && 
          (i.name && i.name.toLowerCase().includes(search.toLowerCase())) && 
          (!showOnlyWish || i.isWish)
        );
        return filtered.sort((a, b) => {
          const aCount = (a.yori||0)+(a.chuu||0)+(a.hiki||0)+(a.syori||0)+(a.schuu||0)+(a.shiki||0);
          const bCount = (b.yori||0)+(b.chuu||0)+(b.hiki||0)+(b.syori||0)+(b.schuu||0)+(b.shiki||0);
          switch (sortBy) {
            case "name": return (a.name||"").localeCompare(b.name||"", 'ja');
            case "new": return (b.createdAt || 0) - (a.createdAt || 0);
            case "old": return (a.createdAt || 0) - (b.createdAt || 0);
            case "price_high": return (parseInt(b.price)||0) - (parseInt(a.price)||0);
            case "stock_high": return bCount - aCount;
            case "comp_first":
              const aComp = (a.yori>0||a.syori>0) && (a.chuu>0||a.schuu>0) && (a.hiki>0||a.shiki>0);
              const bComp = (b.yori>0||b.syori>0) && (b.chuu>0||b.schuu>0) && (b.hiki>0||b.shiki>0);
              return (bComp?1:0) - (aComp?1:0);
            default: return 0;
          }
        });
      }, [items, selectedGroup, selectedMember, search, showOnlyWish, sortBy]);

      const batchAction = (type) => {
        if (selectedItemIds.length === 0 || !isManageMode) return;
        if (type === 'delete') {
          setTargetName(`${selectedItemIds.length}ä»¶ã®é¸æŠé …ç›®`);
          setActiveModal('delete_batch');
        } else if (type === 'wish') {
          setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, isWish: true } : i));
          showError(`${selectedItemIds.length}ä»¶ã‚’â­ã«è¨­å®šã—ã¾ã—ãŸ`);
        } else if (type === 'stock') {
          setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, yori: (i.yori||0)+1, chuu: (i.chuu||0)+1, hiki: (i.hiki||0)+1 } : i));
          showError(`${selectedItemIds.length}ä»¶ã®åœ¨åº«ã‚’+1ã—ã¾ã—ãŸ`);
        }
      };

      const stats = useMemo(() => {
        const filtered = items.filter(i => (selectedGroup === "ALL" || i.group === selectedGroup) && (selectedMember === "ALL" || i.member === selectedMember));
        const totalKinds = filtered.length;
        const totalCount = filtered.reduce((s,i) => s + (parseInt(i.yori)||0) + (parseInt(i.chuu)||0) + (parseInt(i.hiki)||0) + (parseInt(i.syori)||0) + (parseInt(i.schuu)||0) + (parseInt(i.shiki)||0), 0);
        const totalSlots = totalKinds * 3;
        let collectedSlots = 0;
        let completedKinds = 0;
        filtered.forEach(i => {
          const hasYori = (i.yori > 0 || i.syori > 0);
          const hasChuu = (i.chuu > 0 || i.schuu > 0);
          const hasHiki = (i.hiki > 0 || i.shiki > 0);
          if (hasYori) collectedSlots++;
          if (hasChuu) collectedSlots++;
          if (hasHiki) collectedSlots++;
          if (hasYori && hasChuu && hasHiki) completedKinds++;
        });
        return { totalKinds, totalCount, totalSlots, collectedSlots, completedKinds };
      }, [items, selectedGroup, selectedMember]);

      const openEditImgModal = (item) => {
        setEditItemId(item.id);
        setTempMainUrl(item.thumbnail || "");
        setTempImages(item.otherImages || []);
        setActiveModal('edit_img');
      };

      const saveImages = () => {
        setItems(p => p.map(it => it.id === editItemId ? { ...it, thumbnail: tempMainUrl, otherImages: tempImages } : it));
        setActiveModal(null);
      };

      const handleCacheClear = () => {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\n(ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“)")){
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      };

      // ãƒ­ã‚°ã‚¤ãƒ³å‰ã®ç”»é¢
      if (!isAuthReady) {
        return (
          <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', background: '#1a1a1a' }}>
            <div style={{ color: '#fff' }}>èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      if (!user) {
        return (
          <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', height: '100vh', background: '#1a1a1a', gap: 20 }}>
            <h1 style={{ color: '#fff', fontSize: 24, margin: 0 }}>ç”Ÿå†™çœŸç®¡ç†For=Love</h1>
            <p style={{ color: '#aaa', margin: 0 }}>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
            <button 
              onClick={handleGoogleLogin}
              style={{
                padding: '12px 32px',
                fontSize: 16,
                background: '#4285f4',
                color: '#fff',
                border: 'none',
                borderRadius: 8,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 10
              }}
            >
              <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#fff" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                <path fill="#fff" d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z"/>
                <path fill="#fff" d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z"/>
                <path fill="#fff" d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.002 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z"/>
              </svg>
              Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p style={{ color: '#777', fontSize: 12, marginTop: 20, textAlign: 'center', maxWidth: 300 }}>
              â€»ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã«è‡ªå‹•ä¿å­˜ã•ã‚Œ<br />
              åˆ¥ã®ç«¯æœ«ã§ã‚‚åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã§ãã¾ã™
            </p>
          </div>
        );
      }

      // ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰
      return (
        <div className={isDarkMode ? "dark-mode" : ""} style={{ 
          maxWidth: appWidth,
          margin: '0 auto',
          minHeight: '100vh',
          transition: 'max-width 0.3s'
        }}>
          {errorMsg && <div className="error-toast">âš ï¸ {errorMsg}</div>}
          {isLoading && (
            <div className="loading-overlay">
              <div className="loading-spinner"></div>
              <div className="loading-text">åŒæœŸä¸­...</div>
            </div>
          )}
          
          <div className="top-bar">
            <div style={{display:'flex', alignItems:'center', gap:10}}>
              <h3 style={{margin: 0, fontSize: '16px'}}>ç”Ÿå†™çœŸç®¡ç†For=Love</h3>
              {lastSaved && (
                <span style={{
                  fontSize:10, 
                  color:'#4caf50', 
                  background:'rgba(76,175,80,0.1)', 
                  padding:'2px 6px', 
                  borderRadius:4,
                  fontWeight: 'bold'
                }}>
                  âœ“ {lastSaved}
                </span>
              )}
            </div>
            <div style={{display:'flex', gap:8, alignItems:'center'}}>
              {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆã‚¢ãƒã‚¿ãƒ¼ã¨åå‰ã®ã¿ï¼‰ */}
              {user && (
                <div style={{
                  display:'flex', 
                  alignItems:'center', 
                  gap:6, 
                  fontSize:12,
                  padding: '4px 8px',
                  background: isDarkMode ? '#2a2a2a' : '#f5f5f5',
                  borderRadius: '20px'
                }}>
                  <img src={user.photoURL} alt="avatar" style={{
                    width:24, 
                    height:24, 
                    borderRadius:'50%',
                    border: isDarkMode ? '1px solid #444' : '1px solid #ddd'
                  }} />
                  <span style={{
                    fontWeight: 'bold',
                    color: isDarkMode ? '#fff' : '#333',
                    maxWidth: '100px',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    whiteSpace: 'nowrap'
                  }}>
                    {user.displayName}
                  </span>
                </div>
              )}
              <button 
                onClick={() => setActiveModal('app_settings')}
                style={{
                  padding:'6px 12px',
                  background: isDarkMode ? '#2a2a2a' : '#f5f5f5',
                  border: isDarkMode ? '1px solid #444' : '1px solid #ddd',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px',
                  color: isDarkMode ? '#fff' : '#333'
                }}
              >
                âš™ï¸ è¨­å®š
              </button>
              <button 
                onClick={()=>setIsDarkMode(!isDarkMode)}
                style={{
                  padding:'6px 8px',
                  background: isDarkMode ? '#2a2a2a' : '#f5f5f5',
                  border: isDarkMode ? '1px solid #444' : '1px solid #ddd',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '16px'
                }}
              >
                {isDarkMode?"â˜€ï¸":"ğŸŒ™"}
              </button>
            </div>
          </div>

          <div className="main-layout">
            <div className="stats-card">
              <div className="stats-charts-grid">
                {/* åé›†ç‡ */}
                <div className="stats-box">
                  <div className="stats-label">åé›†ç‡</div>
                  <div className="progress-circle-container">
                    <div className="progress-circle-bg"></div>
                    <div 
                      className="progress-circle" 
                      style={{
                        background: `conic-gradient(${isDarkMode ? 'var(--color-primary)' : 'var(--light-primary)'} 0% ${stats.totalSlots ? Math.round((stats.collectedSlots/stats.totalSlots)*100) : 0}%, transparent ${stats.totalSlots ? Math.round((stats.collectedSlots/stats.totalSlots)*100) : 0}% 100%)`
                      }}
                    ></div>
                    <div className="progress-circle-mask">
                      <span className="progress-percentage">{stats.totalSlots ? Math.round((stats.collectedSlots/stats.totalSlots)*100) : 0}%</span>
                    </div>
                  </div>
                  <div className="stats-fraction">{stats.collectedSlots} / {stats.totalSlots}</div>
                </div>
                
                {/* ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡ */}
                <div className="stats-box">
                  <div className="stats-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</div>
                  <div className="progress-circle-container">
                    <div className="progress-circle-bg"></div>
                    <div 
                      className="progress-circle" 
                      style={{
                        background: `conic-gradient(${isDarkMode ? 'var(--color-success)' : 'var(--light-success)'} 0% ${stats.totalKinds ? Math.round((stats.completedKinds/stats.totalKinds)*100) : 0}%, transparent ${stats.totalKinds ? Math.round((stats.completedKinds/stats.totalKinds)*100) : 0}% 100%)`
                      }}
                    ></div>
                    <div className="progress-circle-mask">
                      <span className="progress-percentage">{stats.totalKinds ? Math.round((stats.completedKinds/stats.totalKinds)*100) : 0}%</span>
                    </div>
                  </div>
                  <div className="stats-fraction">{stats.completedKinds} / {stats.totalKinds}</div>
                </div>
              </div>
              
              {/* çµ±è¨ˆã‚µãƒãƒªãƒ¼ï¼ˆç·æ•°è¡¨ç¤ºï¼‰ */}
              <div className="stats-summary">
                <div className="stat-item">
                  <span className="stat-value">{stats.totalKinds}</span>
                  <span className="stat-label">ç·å†™çœŸæ•°</span>
                </div>
                <div className="stat-item">
                  <span className="stat-value">{stats.collectedSlots}</span>
                  <span className="stat-label">åé›†æ¸ˆã¿</span>
                </div>
                <div className="stat-item">
                  <span className="stat-value">{stats.completedKinds}</span>
                  <span className="stat-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ</span>
                </div>
              </div>
            </div>

            {/* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« ===== */}
            <div className="control-panel">
              {/* ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« */}
              <div className="control-header">
                <div>
                  <strong>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</strong>
                  {isManageMode && <span className="manage-mode-badge">ON</span>}
                </div>
                <button 
                  className="manage-toggle" 
                  onClick={() => setIsManageMode(!isManageMode)}
                  style={{ color: isManageMode ? '#ff5252' : '' }}
                >
                  âœï¸
                </button>
              </div>

              {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡Œ */}
              <div className="filter-row">
                <input 
                  className="search-input" 
                  placeholder="æ¤œç´¢..." 
                  value={search} 
                  onChange={e => setSearch(e.target.value)} 
                />
                <button 
                  className={`wish-toggle-btn ${showOnlyWish ? 'active' : ''}`} 
                  onClick={() => setShowOnlyWish(!showOnlyWish)}
                >
                  â­ ã®ã¿
                </button>
                <select 
                  className="sort-select" 
                  value={sortBy} 
                  onChange={e => setSortBy(e.target.value)}
                >
                  <option value="new">æ–°ã—ã„é †</option>
                  <option value="old">å¤ã„é †</option>
                  <option value="name">åå‰é †</option>
                  <option value="price_high">ä¾¡æ ¼ãŒé«˜ã„é †</option>
                  <option value="stock_high">åœ¨åº«ãŒå¤šã„é †</option>
                  <option value="comp_first">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå„ªå…ˆ</option>
                </select>
              </div>

              {/* ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ */}
              <div className="group-section">
                <div className="section-title">
                  <strong>ã‚°ãƒ«ãƒ¼ãƒ—</strong>
                  <button 
                    className="add-btn" 
                    onClick={() => setActiveModal('add_group')}
                  >
                    +
                  </button>
                </div>
                <ul className="button-list">
                  <li>
                    <button 
                      className={`btn-item ${selectedGroup === 'ALL' ? 'active' : ''}`} 
                      onClick={() => {
                        setSelectedGroup('ALL');
                        setSelectedMember('ALL');
                      }}
                    >
                      ALL
                    </button>
                  </li>
                  {groups.map(g => (
                    <li key={g.name}>
                      <button 
                        className={`btn-item ${selectedGroup === g.name ? 'active' : ''}`} 
                        onClick={() => {
                          setSelectedGroup(g.name);
                          setSelectedMember(g.members.length > 0 ? g.members[0] : 'ALL');
                        }}
                      >
                        {g.name}
                        {isManageMode && (
                          <button 
                            className="btn-delete-small" 
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              setTargetName(g.name); 
                              setActiveModal('delete_group'); 
                            }}
                          >
                            Ã—
                          </button>
                        )}
                      </button>
                    </li>
                  ))}
                </ul>
              </div>

              {/* ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ */}
              <div className="member-section">
                <div className="section-title">
                  <strong>ãƒ¡ãƒ³ãƒãƒ¼</strong>
                  {selectedGroup !== 'ALL' && selectedGroup && (
                    <button 
                      className="add-btn" 
                      onClick={() => setActiveModal('add_member')}
                    >
                      +
                    </button>
                  )}
                </div>
                <ul className="button-list">
                  <li>
                    <button 
                      className={`btn-item ${selectedMember === 'ALL' ? 'active' : ''}`} 
                      onClick={() => setSelectedMember('ALL')}
                    >
                      ALL
                    </button>
                  </li>
                  {selectedGroup !== 'ALL' && groups.find(g => g.name === selectedGroup)?.members.map(m => (
                    <li key={m}>
                      <button 
                        className={`btn-item ${selectedMember === m ? 'active' : ''}`} 
                        onClick={() => setSelectedMember(m)}
                      >
                        {m}
                        {isManageMode && (
                          <button 
                            className="btn-delete-small" 
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              setTargetName(m); 
                              setActiveModal('delete_member'); 
                            }}
                          >
                            Ã—
                          </button>
                        )}
                      </button>
                    </li>
                  ))}
                </ul>
              </div>
            </div>

            {selectedGroup !== "ALL" && selectedMember !== "ALL" && (
              <button className="add-trigger-btn" onClick={() => setActiveModal('add_photo')}>ï¼‹ ç”Ÿå†™çœŸã‚’è¿½åŠ </button>
            )}

            {sortedItems.map(i => {
              const comp = (i.yori>0||i.syori>0) && (i.chuu>0||i.schuu>0) && (i.hiki>0||i.shiki>0);
              const isSelected = selectedItemIds.includes(i.id);
              const isSignExpanded = expandedSignItems.includes(i.id);
              
              return (
                <div key={i.id} className={`photo-card ${comp ? 'is-complete' : ''} ${i.isWish ? 'is-wish' : ''}`} style={{background: (isManageMode && isSelected) ? 'rgba(255, 82, 82, 0.1)' : ''}}>
                  <div style={{display:'flex', flexDirection:'column', alignItems:'center', gap:10}}>
                    {isManageMode && <input type="checkbox" className="selection-checkbox" checked={isSelected} onChange={() => toggleSelectItem(i.id)} />}
                    <div className="img-container">
                      <div className="btn-img-add" onClick={() => openEditImgModal(i)}>ï¼‹</div>
                      <div style={{width:65, cursor:'pointer'}} onClick={() => {
                        const imgs = [i.thumbnail, ...(i.otherImages||[])].filter(Boolean);
                        if(imgs.length) setViewer({ images: imgs, index: 0, name: i.name });
                        else openEditImgModal(i);
                      }}>
                        {i.thumbnail ? <img src={i.thumbnail} style={{width:'100%', borderRadius:4}} /> : <div style={{background:'#eee', height:60, borderRadius:4, fontSize:8, textAlign:'center', display:'flex', alignItems:'center', justifyContent:'center', color:'#888'}}>ç”»åƒãªã—</div>}
                      </div>
                    </div>
                  </div>
                  <div className="card-content">
                    <div style={{display:'flex', justifyBetween:'space-between', alignItems:'center'}}>
                      <div style={{flex: 1, minWidth: 0, display:'flex', alignItems:'center', gap:8}}>
                        <button className={`wish-toggle ${i.isWish ? 'active' : ''}`} onClick={() => updateItem(i.id, 'isWish', !i.isWish)}>â­</button>
                        {editingNameId === i.id ? (
                          <input 
                            className="edit-name-input"
                            autoFocus 
                            value={i.name} 
                            onChange={e => updateItem(i.id, 'name', e.target.value)} 
                            onBlur={() => setEditingNameId(null)}
                            onKeyDown={e => { if(e.key === 'Enter') setEditingNameId(null); }}
                          />
                        ) : (
                          <span className="name-display" onClick={() => setEditingNameId(i.id)}>
                            {i.name} {comp && "ğŸ‘ï¸"}
                          </span>
                        )}
                      </div>
                      <button onClick={()=>{ setTargetName(i.name); setTargetId(i.id); setActiveModal('delete_photo'); }} style={{color:'#999', border:'none', background:'none', cursor:'pointer'}}>âœ•</button>
                    </div>
                    {/* é€šå¸¸ã®å¯„ã‚Šãƒ»ä¸­ãƒ»å¼•ãï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ */}
                    <div style={{display:'flex', gap:4, flexWrap:'wrap', marginBottom: 8}}>
                      {[ {k:'yori', l:'å¯„'}, {k:'chuu', l:'ä¸­'}, {k:'hiki', l:'å¼•'} ].map(o => (
                        <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-stock' : ''}`}>
                          <span style={{fontSize: 9, padding:'0 4px', fontW:'bold'}}>{o.l}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                          <span className="qty-val">{i[o.k]||0}</span>
                          <button className="btn-qty" onClick={() => updateItem(i.id, o.k, (parseInt(i[o.k])||0)+1)}>+</button>
                        </div>
                      ))}
                    </div>
                    
                    {/* ã‚µã‚¤ãƒ³ä»˜ãã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆã‚¹ãƒãƒ›ã§æŠ˜ã‚ŠãŸãŸã¿ï¼‰ */}
                    <div className="sign-counters-container">
                      <button 
                        className={`sign-counters-toggle ${isSignExpanded ? 'active' : ''}`}
                        onClick={() => toggleSignCounters(i.id)}
                      >
                        ã‚µã‚¤ãƒ³ä»˜ãã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
                      </button>
                      <div className={`sign-counters-content ${isSignExpanded ? 'expanded' : ''}`}>
                        {[ {k:'syori', l:'ã‚µã‚¤ãƒ³å¯„'}, {k:'schuu', l:'ã‚µã‚¤ãƒ³ä¸­'}, {k:'shiki', l:'ã‚µã‚¤ãƒ³å¼•'} ].map(o => (
                          <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-sign' : ''}`}>
                            <span style={{fontSize: 9, padding:'0 4px', fontW:'bold'}}>{o.l}</span>
                            <button className="btn-qty" onClick={() => updateItem(i.id, o.k, Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                            <span className="qty-val">{i[o.k]||0}</span>
                            <button className="btn-qty" onClick={() => updateItem(i.id, o.k, (parseInt(i[o.k])||0)+1)}>+</button>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    <div className="row-inputs" style={{ flexWrap: 'wrap', gap: '8px', marginTop: '8px' }}>
                      <select 
                        className="source-select" 
                        value={i.source || "å…¥æ‰‹å…ˆ"} 
                        onChange={e => updateItem(i.id, 'source', e.target.value)}
                        style={{ height: '36px' }} 
                      >
                        {SOURCE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                      <input 
                        className="details-input" 
                        style={{ flex: '1 1 150px', height: '36px' }} 
                        placeholder="ãƒ¡ãƒ¢" 
                        value={i.memo || ""} 
                        onChange={e => updateItem(i.id, 'memo', e.target.value)} 
                      />
                      <div className="price-wrapper">
                        <input className="details-input" style={{width:'100%'}} placeholder="ä¾¡æ ¼" 
                          value={formatWithComma(i.price)} 
                          onChange={e => updateItem(i.id, 'price', e.target.value.replace(/\D/g,'').slice(0, 7))} />
                        <span className="currency-unit">å††</span>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {isManageMode && sortedItems.length > 0 && (
            <div className="selection-bar">
              <div style={{display:'flex', alignItems:'center', gap:10}}>
                <input type="checkbox" className="selection-checkbox" checked={selectedItemIds.length > 0 && selectedItemIds.length === sortedItems.length} onChange={(e) => {
                  if(e.target.checked) setSelectedItemIds(sortedItems.map(it => it.id));
                  else setSelectedItemIds([]);
                }} />
                <span style={{fontSize:12, fontW:'bold'}}>{selectedItemIds.length}ä»¶é¸æŠä¸­</span>
              </div>
              <div style={{display:'flex', gap:8}}>
                <button className="batch-btn" onClick={() => batchAction('wish')}>ä¸€æ‹¬ãŠæ°—ã«å…¥ã‚Š</button>
                <button className="batch-btn" onClick={() => batchAction('stock')}>ã™ã¹ã¦+1</button>
                <button className="batch-btn" style={{background:'#000'}} onClick={() => batchAction('delete')}>å‰Šé™¤</button>
              </div>
            </div>
          )}

          {viewer && (
            <div className="lightbox" onClick={() => setViewer(null)}>
              <div className="lightbox-close">Ã—</div>
              <img src={viewer.images[viewer.index]} onClick={(e) => { e.stopPropagation(); setViewer({ ...viewer, index: (viewer.index + 1) % viewer.images.length }); }} />
              <div className="lightbox-info"><strong>{viewer.name}</strong><br/>{viewer.index + 1} / {viewer.images.length}</div>
            </div>
          )}

          {activeModal && (
            <div className="modal-overlay" onClick={()=>setActiveModal(null)}>
              <div className="modal-content" onClick={e=>e.stopPropagation()}>
                {activeModal === 'app_settings' && (
                  <div>
                    <h3 style={{margin:'0 0 15px 0'}}>è¨­å®š</h3>
                    
                    {/* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    {user && (
                      <div style={{
                        marginBottom: '15px', 
                        padding: '15px', 
                        background: isDarkMode ? '#2a2a2a' : '#f9f9f9', 
                        borderRadius: '12px',
                        border: '1px solid ' + (isDarkMode ? '#444' : '#eee')
                      }}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px'}}>
                          <img src={user.photoURL} alt="avatar" style={{width:40, height:40, borderRadius:'50%'}} />
                          <div>
                            <div style={{fontWeight: 'bold', fontSize: '14px'}}>{user.displayName}</div>
                            <div style={{fontSize: '11px', color: '#666'}}>{user.email}</div>
                          </div>
                        </div>
                        {lastSaved && (
                          <div style={{fontSize: '12px', color: '#4caf50', textAlign: 'center'}}>
                            âœ“ æœ€çµ‚ä¿å­˜: {lastSaved}
                          </div>
                        )}
                      </div>
                    )}

                    {/* ã‚¯ãƒ©ã‚¦ãƒ‰æ“ä½œã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    <div style={{
                      marginBottom: '15px', 
                      padding: '15px', 
                      background: isDarkMode ? '#2a2a2a' : '#f9f9f9', 
                      borderRadius: '12px',
                      border: '1px solid ' + (isDarkMode ? '#444' : '#eee')
                    }}>
                      <h4 style={{marginTop:0, marginBottom: '10px'}}>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h4>
                      <div style={{display: 'flex', gap: '8px', marginBottom: '10px'}}>
                        <button onClick={handleManualSave} style={{
                          flex: 1,
                          padding: '10px',
                          background: '#4caf50',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: 'bold'
                        }}>
                          ğŸ’¾ æ‰‹å‹•ä¿å­˜
                        </button>
                        <button onClick={handleManualLoad} style={{
                          flex: 1,
                          padding: '10px',
                          background: '#2196f3',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: 'bold'
                        }}>
                          ğŸ”„ æ‰‹å‹•èª­è¾¼
                        </button>
                      </div>
                      <p style={{fontSize:'11px', color:'#666', margin:0}}>
                        ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br/>
                        åˆ¥ã®ç«¯æœ«ã§åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨åŒæœŸã•ã‚Œã¾ã™ã€‚
                      </p>
                    </div>

                    {/* ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    <div style={{
                      marginBottom: '15px', 
                      padding: '15px', 
                      background: isDarkMode ? '#2a2a2a' : '#f9f9f9', 
                      borderRadius: '12px',
                      border: '1px solid ' + (isDarkMode ? '#444' : '#eee')
                    }}>
                      <h4 style={{marginTop:0, marginBottom: '10px'}}>ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h4>
                      <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                        <button onClick={handleCSVExport} style={{
                          padding: '10px',
                          background: '#ff9800',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: 'bold'
                        }}>
                          ğŸ“¤ CSVå‡ºåŠ›ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                        </button>
                        <button onClick={handleTSVExport} style={{
                          padding: '10px',
                          background: '#9c27b0',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: 'bold'
                        }}>
                          ğŸ“¤ TSVå‡ºåŠ›ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰
                        </button>
                        <label style={{
                          padding: '10px',
                          background: '#2196f3',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: 'bold',
                          textAlign: 'center'
                        }}>
                          ğŸ“¥ CSV/TSVå–è¾¼
                          <input type="file" accept=".csv,.tsv,.txt" style={{display:'none'}} onChange={handleImportCSV} />
                        </label>
                        
                        {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ - åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º */}
                        {availableTemplates.length > 0 && (
                          <div style={{marginTop: '10px'}}>
                            <div style={{fontSize: '11px', color: '#666', marginBottom: '5px'}}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ ({availableTemplates.length}ä»¶):</div>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '5px'}}>
                              {availableTemplates.map(fileName => (
                                <button 
                                  key={fileName}
                                  onClick={() => loadExternalTemplate(fileName)}
                                  style={{
                                    padding: '8px',
                                    background: '#9c27b0',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '11px',
                                    fontWeight: 'bold',
                                    textAlign: 'center'
                                  }}
                                >
                                  {fileName.replace('.csv', '')}
                                </button>
                              ))}
                            </div>
                            <p style={{fontSize: '10px', color: '#666', marginTop: '5px', textAlign: 'center'}}>
                              â€»ã‚¿ãƒ–åŒºåˆ‡ã‚Šã¨ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ä¸¡æ–¹ã«å¯¾å¿œ
                            </p>
                          </div>
                        )}
                        
                        {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
                        {availableTemplates.length === 0 && (
                          <div style={{
                            marginTop: '10px',
                            padding: '10px',
                            background: isDarkMode ? '#333' : '#f5f5f5',
                            borderRadius: '8px',
                            textAlign: 'center'
                          }}>
                            <p style={{fontSize: '11px', color: '#666', margin: 0}}>
                              ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br/>
                              ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                            </p>
                            <p style={{fontSize: '10px', color: '#888', margin: '5px 0 0 0'}}>
                              åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«å: template.csv, template1.csv, template2.csv, ...
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* è¡¨ç¤ºè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    <div style={{
                      marginBottom: '15px', 
                      padding: '15px', 
                      background: isDarkMode ? '#2a2a2a' : '#f9f9f9', 
                      borderRadius: '12px',
                      border: '1px solid ' + (isDarkMode ? '#444' : '#eee')
                    }}>
                      <h4 style={{marginTop:0, marginBottom: '10px'}}>è¡¨ç¤ºè¨­å®š</h4>
                      <label style={{fontSize: '12px', color: '#888', display: 'flex', justifyContent: 'space-between'}}>
                        <span>ã‚µã‚¤ãƒˆã®å¹…</span>
                        <b>{appWidth === '100%' ? 'ãƒ•ãƒ«ç”»é¢' : appWidth}</b>
                      </label>
                      
                      <input 
                        type="range" 
                        min="350" 
                        max="1200" 
                        step="10"
                        value={appWidth === '100%' ? 1200 : parseInt(appWidth)} 
                        onChange={(e) => setAppWidth(`${e.target.value}px`)}
                        style={{
                          width: '100%', 
                          height: '30px', 
                          cursor: 'pointer',
                          accentColor: '#2196f3'
                        }}
                      />

                      <div style={{display: 'flex', gap: '8px', marginTop: '12px'}}>
                        <button onClick={() => setAppWidth('400px')} style={quickBtnStyle(isDarkMode)}>ã‚¹ãƒãƒ›</button>
                        <button onClick={() => setAppWidth('600px')} style={quickBtnStyle(isDarkMode)}>æ¨™æº–</button>
                        <button onClick={() => setAppWidth('900px')} style={quickBtnStyle(isDarkMode)}>ãƒ¯ã‚¤ãƒ‰</button>
                        <button onClick={() => setAppWidth('100%')} style={quickBtnStyle(isDarkMode)}>ãƒ•ãƒ«</button>
                      </div>
                    </div>
                    
                    {/* è¨­å®šãƒªã‚¹ãƒˆ */}
                    <ul className="settings-list">
                      <li onClick={handleCacheClear}>ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰å‰Šé™¤</li>
                      <li onClick={() => alert("è¦ç´„ï¼›ã“ã®ã‚µã‚¤ãƒˆã¯å€‹äººã®è‡ªå·±æº€è¶³ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã«ã¤ãã¾ã—ã¦ã¯ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚ã¾ãŸä»£ã€…æœ¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ§˜ã€ã¾ãŸ=Loveæ§˜ã®è¦æœ›ãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã®ã™ã¹ã¦ã®æ¨©åˆ©ãªã©ã‚’è­²æ¸¡ã—ã¾ã™ã€‚ã¾ãŸã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã«ç½®ãã¾ã—ã¦åˆ©ç›Šã‚’å¾—ã‚‹ã“ã¨ã¯ã„ãŸã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚")}>ğŸ“œ è¦ç´„</li>
                      <li onClick={() => window.open("https://github.com/Meowx7", "_blank")}>ğŸ± GitHub</li>
                      <li onClick={handleLogout} style={{color: '#ff5252', fontWeight: 'bold'}}>ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
                      <li style={{color:'#888', cursor:'default', fontSize: '11px', justifyContent: 'center'}}>Version 1.4.5</li>
                    </ul>
                    <button onClick={()=>setActiveModal(null)} style={{
                      width:'100%', 
                      padding:12, 
                      background:'#eee', 
                      border:'none', 
                      borderRadius:8,
                      fontWeight: 'bold',
                      cursor: 'pointer'
                    }}>
                      é–‰ã˜ã‚‹
                    </button>
                  </div>
                )}
                {activeModal === 'add_photo' && (
                  <div>
                    <h3>æ–°è¦è¿½åŠ </h3>
                    <input type="text" placeholder="ç”Ÿå†™çœŸã‚»ãƒƒãƒˆå" id="modal_name" autoFocus />
                    <button onClick={() => {
                      const v = document.getElementById("modal_name").value;
                      if(v) { setItems(p => [{ id: genId(), group: selectedGroup, member: selectedMember, name: v, yori: 0, chuu: 0, hiki: 0, syori: 0, schuu: 0, shiki: 0, isWish: false, createdAt: Date.now(), memo: "", price: "", source: "å…¥æ‰‹å…ˆ", thumbnail: "", otherImages: [] }, ...p]); setActiveModal(null); }
                    }} style={{width:'100%', padding:12, background:'#2196f3', color:'#fff', border:'none', borderRadius:8, marginTop:10}}>è¿½åŠ </button>
                  </div>
                )}
                {activeModal === 'add_group' && (
                  <div>
                    <h3>ã‚°ãƒ«ãƒ¼ãƒ—</h3><input type="text" autoFocus onKeyDown={e=>{
                      if(e.key==='Enter'){
                        const val = e.target.value.trim();
                        if(!val) return showError("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                        setGroups(p=>[...p,{name:val,members:[]}]); setActiveModal(null); 
                      }
                    }} />
                  </div>
                )}
                {activeModal === 'add_member' && (
                  <div>
                    <h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{
                      if(e.key==='Enter'){
                        const val = e.target.value.trim();
                        if(!val) return showError("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                        setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:[...g.members,val]}:g)); setActiveModal(null);
                      }
                    }} />
                  </div>
                )}
                {activeModal === 'edit_img' && (
                  <div>
                    <h3>ç”»åƒç®¡ç†</h3>
                    <div style={{display:'grid', gridTemplateColumns:'repeat(3,1fr)', gap:8, marginBottom:10}}>
                      {tempMainUrl && <div style={{position:'relative'}}><img src={tempMainUrl} style={{width:'100%', height:60, objectFit:'cover', borderRadius:4}}/><button onClick={()=>setTempMainUrl("")} style={{position:'absolute', top:0, right:0, background:'red', color:'white', border:'none'}}>Ã—</button></div>}
                      {tempImages.map((u,idx)=><div key={idx} style={{position:'relative'}}><img src={u} style={{width:'100%', height:60, objectFit:'cover', borderRadius:4}}/><button onClick={()=>setTempImages(p=>p.filter((_,i)=>i!==idx))} style={{position:'absolute', top:0, right:0, background:'red', color:'white', border:'none'}}>Ã—</button></div>)}
                    </div>
                    <label style={{display:'block', padding:10, background:'#2196f3', color:'white', textAlign:'center', borderRadius:8, cursor:'pointer', marginBottom:10}}>
                      ç«¯æœ«ã‹ã‚‰é¸æŠ<input type="file" multiple style={{display:'none'}} onChange={async(e)=>{
                        const files = Array.from(e.target.files);
                        for(const f of files){ const c = await compressImage(f); if(!tempMainUrl) setTempMainUrl(c); else setTempImages(p=>[...p,c]); }
                      }}/>
                    </label>
                    <input type="text" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘ã¦Enter" onKeyDown={e=>{ if(e.key==='Enter' && e.target.value){ const urls = e.target.value.split(/[, \n]+/).filter(Boolean); urls.forEach(u => { if(!tempMainUrl) setTempMainUrl(u); else setTempImages(p=>[...p,u]); }); e.target.value=""; } }}/>
                    <button onClick={saveImages} style={{width:'100%', padding:12, background:'#4caf50', color:'#fff', border:'none', borderRadius:8, marginTop:10}}>ä¿å­˜</button>
                  </div>
                )}
                {activeModal === 'delete_group' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.group!==targetName)); setGroups(p=>p.filter(g=>g.name!==targetName));
                      if(selectedGroup===targetName) {setSelectedGroup("ALL"); setSelectedMember("ALL");} setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_member' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.member!==targetName)); setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:g.members.filter(m=>m!==targetName)}:g));
                      if(selectedMember===targetName) setSelectedMember("ALL"); setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_photo' && (
                  <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p=>p.filter(i=>i.id!==targetId));
                      setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#ff5252', color:'#fff', border:'none', borderRadius:8}}>å‰Šé™¤</button>
                  </div>
                )}
                {activeModal === 'delete_batch' && (
                  <div><h3>{targetName}ã‚’å‰Šé™¤ï¼Ÿ</h3>
                    <button onClick={()=>{
                      setItems(p => p.filter(i => !selectedItemIds.includes(i.id)));
                      setSelectedItemIds([]);
                      setActiveModal(null);
                    }} style={{width:'100%', padding:12, background:'#000', color:'#fff', border:'none', borderRadius:8}}>ä¸€æ‹¬å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
