<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <title>ç”Ÿå†™çœŸç®¡ç†For=Love</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆï¼ˆå¾Œè¿°ã®è¿½åŠ CSSã‚’style.cssã«å¿…ãšè¿½è¨˜ã—ã¦ãã ã•ã„ï¼‰ -->
  <link rel="stylesheet" href="style.css" />
  
  <!-- Firebaseã¨Googleãƒ­ã‚°ã‚¤ãƒ³ -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC183tcN__mG5zNx2FG__9g3zkZWpszJ_k",
    authDomain: "picturemanager-f139d.firebaseapp.com",
    projectId: "picturemanager-f139d",
    storageBucket: "picturemanager-f139d.firebasestorage.app",
    messagingSenderId: "893316957167",
    appId: "1:893316957167:web:1cddf45fd9fd0e9145ac1a"
  };
  const app = initializeApp(firebaseConfig);
  window.fb = {
    db: getFirestore(app),
    auth: getAuth(app),
    provider: new GoogleAuthProvider(),
    doc, setDoc, onSnapshot, signInWithPopup, signOut, onAuthStateChanged, getDoc
  };
</script>

</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useCallback, useMemo, useRef } = React;
const STORAGE_KEY = "photocard_inventory_v4_manage_drag";
const genId = () => 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
const SOURCE_OPTIONS = ["å…¥æ‰‹å…ˆ", "ãƒ¡ãƒ«ã‚«ãƒª", "è‡ªå¼•ã", "åº—èˆ—", "è­²æ¸¡", "ãã®ä»–"];

const DEFAULT_GROUPS = [{ name: "=Love", members: ["å¤§è°·æ˜ ç¾é‡Œ"] }];

// åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
const AVAILABLE_TEMPLATES = [
  'template.csv',
  'template1.csv',
  'template2.csv', 
  'template3.csv',
  'template4.csv',
  'template5.csv'
];

const formatWithComma = (val) => {
  if (!val) return "";
  return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
};

// CSVãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°
function parseCSV(text, delimiter = '\t') {
  if (!text) return [];
  const rows = []; 
  let row = []; 
  let field = ''; 
  let inQuotes = false;
  
  for (let i = 0; i < text.length; i++) {
    const c = text[i], next = text[i+1];
    
    if (inQuotes) {
      if (c === '"' && next === '"') { 
        field += '"'; 
        i++; 
      } else if (c === '"') {
        inQuotes = false;
      } else {
        field += c;
      }
    } else {
      if (c === '"') {
        inQuotes = true;
      } else if (c === delimiter) { 
        row.push(field.trim()); 
        field = ''; 
      } else if (c === '\n' || c === '\r') {
        if (field || row.length) { 
          row.push(field.trim()); 
          rows.push(row); 
        }
        row = []; 
        field = ''; 
        if (c === '\r' && next === '\n') i++;
      } else {
        field += c;
      }
    }
  }
  
  if (field || row.length) { 
    row.push(field.trim()); 
    rows.push(row); 
  }
  
  return rows;
}

// ã‚¿ãƒ–åŒºåˆ‡ã‚ŠCSVã‚’ã‚¢ã‚¤ãƒ†ãƒ ã«å¤‰æ›
const parseTabCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
  if (!row || row.length < 2) return null;
  
  const now = Date.now();
  const createdAt = now - index;
  
  const thumbnail = row[0] || "";
  const name = row[1] || "åç§°ãªã—";
  let otherImages = [];
  
  if (row.length > 2 && row[2]) {
    const imagesText = row[2].replace(/"/g, '').trim();
    if (imagesText) {
      otherImages = imagesText.split(/\r?\n/).map(url => url.trim()).filter(url => url);
    }
  }
  
  return {
    id: genId(),
    group: selectedGroup,
    member: selectedMember,
    name: name,
    thumbnail: thumbnail,
    otherImages: otherImages,
    yori: 0, 
    chuu: 0, 
    hiki: 0,
    syori: 0,
    schuu: 0,
    shiki: 0,
    memo: "",
    price: "",
    source: "å…¥æ‰‹å…ˆ",
    isWish: false,
    createdAt,
    order: index
  };
};

// ã‚«ãƒ³ãƒåŒºåˆ‡ã‚ŠCSVç”¨ãƒ‘ãƒ¼ã‚µãƒ¼
const parseCommaCSVRowToItem = (row, selectedGroup, selectedMember, index = 0) => {
  if (!row || row.length < 2) return null;
  
  const now = Date.now();
  const createdAt = now - index;
  const isShortFormat = row.length < 10;
  
  if (isShortFormat) {
    return {
      id: genId(),
      group: selectedGroup,
      member: selectedMember,
      name: row[1] || "åç§°ãªã—",
      thumbnail: row[0] || "",
      otherImages: row[2] ? row[2].split(/[\n ]+/) : [],
      yori: 0, 
      chuu: 0, 
      hiki: 0,
      syori: 0,
      schuu: 0,
      shiki: 0,
      memo: "",
      price: "",
      source: "å…¥æ‰‹å…ˆ",
      isWish: false,
      createdAt,
      order: index
    };
  } else {
    return {
      id: genId(),
      group: row[0] || selectedGroup,
      member: row[1] || selectedMember,
      name: row[2] || "åç§°ãªã—",
      thumbnail: row[7] || "",
      otherImages: row[11] ? row[11].split("|") : [],
      yori: parseInt(row[3]) || 0, 
      chuu: parseInt(row[4]) || 0, 
      hiki: parseInt(row[5]) || 0,
      syori: parseInt(row[12]) || 0,
      schuu: parseInt(row[13]) || 0,
      shiki: parseInt(row[14]) || 0,
      memo: row[6] || "",
      price: (row[8] || "").slice(0, 9),
      source: row[9] || "å…¥æ‰‹å…ˆ",
      isWish: row[10] === "1",
      createdAt,
      order: index
    };
  }
};

function MiniChart({ percent, color, isDarkMode }) {
  const r = 18; const c = 2 * Math.PI * r;
  const p = isNaN(percent) ? 0 : percent;
  return (
    <svg width="40" height="40" viewBox="0 0 40 40">
      <circle cx="20" cy="20" r={r} stroke={isDarkMode ? "#333" : "#eee"} strokeWidth="4" fill="none" />
      <circle cx="20" cy="20" r={r} stroke={color} strokeWidth="4" fill="none"
        strokeDasharray={`${(p / 100) * c} ${c}`} transform="rotate(-90 20 20)" strokeLinecap="round" />
    </svg>
  );
}

const compressImage = (file, maxWidth = 500) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const scale = Math.min(maxWidth / img.width, 1);
        canvas.width = img.width * scale; canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.onerror = () => resolve("");
    };
  });
};

function App() {
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);
  const [availableTemplates, setAvailableTemplates] = useState([]);
  
  const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem("dark_mode") === "true");
  const quickBtnStyle = (isDark) => ({
    flex: 1,
    padding: '8px 0',
    fontSize: '11px',
    borderRadius: '6px',
    border: '1px solid ' + (isDark ? '#444' : '#ccc'),
    background: isDark ? '#333' : '#fff',
    color: isDark ? '#fff' : '#333',
    cursor: 'pointer'
  });
  const [appWidth, setAppWidth] = useState(() => localStorage.getItem("app_width") || "600px");
  
  const [groups, setGroups] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const p = JSON.parse(saved);
      return (Array.isArray(p.groups) && p.groups.length > 0) ? p.groups : DEFAULT_GROUPS;
    }
    return DEFAULT_GROUPS;
  });

  const [items, setItems] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const p = JSON.parse(saved);
      if (Array.isArray(p.items)) {
        return p.items.map((item, index) => ({
          ...item,
          order: item.order !== undefined ? item.order : index
        }));
      }
    }
    return [];
  });
  
  const [selectedGroup, setSelectedGroup] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const p = JSON.parse(saved);
      if (Array.isArray(p.groups) && p.groups.length > 0) return p.groups[0].name;
    }
    return "=Love";
  });
  
  const [selectedMember, setSelectedMember] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const p = JSON.parse(saved);
      if (Array.isArray(p.groups) && p.groups.length > 0 && p.groups[0].members.length > 0) return p.groups[0].members[0];
    }
    return "å¤§è°·æ˜ ç¾é‡Œ";
  });

  const [showOnlyWish, setShowOnlyWish] = useState(false);
  const [search, setSearch] = useState("");
  const [sortBy, setSortBy] = useState("new");
  const [activeModal, setActiveModal] = useState(null);
  
  const [editItemId, setEditItemId] = useState(null);
  const [editingNameId, setEditingNameId] = useState(null);
  const [targetName, setTargetName] = useState("");
  const [targetId, setTargetId] = useState(null); 
  const [errorMsg, setErrorMsg] = useState("");
  const [isManageMode, setIsManageMode] = useState(false);
  const [viewer, setViewer] = useState(null);
  const [tempImages, setTempImages] = useState([]);
  const [tempMainUrl, setTempMainUrl] = useState("");
  const [selectedItemIds, setSelectedItemIds] = useState([]);
  const [expandedSignItems, setExpandedSignItems] = useState([]);

  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã®çŠ¶æ…‹ï¼ˆæŒ¿å…¥æ©Ÿèƒ½å¯¾å¿œï¼‰
  const [draggedItemId, setDraggedItemId] = useState(null);
  const [dragOverItemId, setDragOverItemId] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [dropPosition, setDropPosition] = useState(null); // 'before' or 'after'
  const [dragInsertGuide, setDragInsertGuide] = useState(null); // æŒ¿å…¥ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ä½ç½®

  // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã®çŠ¶æ…‹
  const [scrollIntervalId, setScrollIntervalId] = useState(null);
  const [scrollDirection, setScrollDirection] = useState(0);
  
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã‚’å¯å¤‰åˆ¶å¾¡ã™ã‚‹è¿½åŠ ã®çŠ¶æ…‹
  const [scrollSpeedMultiplier, setScrollSpeedMultiplier] = useState(1);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†ç”¨ã®çŠ¶æ…‹
  const [messageTimeout, setMessageTimeout] = useState(null);
  
  // æœ€æ–°ã®ãƒã‚¦ã‚¹ä½ç½®ã‚’è¿½è·¡ã™ã‚‹ref
  const lastMousePosition = useRef({ x: 0, y: 0 });
  
  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®çŠ¶æ…‹ï¼ˆã‚¹ãƒãƒ›ï¼‰
  const [touchStartY, setTouchStartY] = useState(null);
  const [touchStartTime, setTouchStartTime] = useState(null);
  const [touchDraggedItemId, setTouchDraggedItemId] = useState(null);
  const [isTouchDragging, setIsTouchDragging] = useState(false);
  const [touchStartX, setTouchStartX] = useState(null);

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¡Œã†é–¢æ•°
  const checkTemplateFiles = useCallback(async () => {
    const existingTemplates = [];
    
    for (const fileName of AVAILABLE_TEMPLATES) {
      try {
        const response = await fetch(fileName, { method: 'HEAD' });
        if (response.ok) {
          existingTemplates.push(fileName);
        }
      } catch (error) {
        console.log(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã¯å­˜åœ¨ã—ã¾ã›ã‚“`);
      }
    }
    
    setAvailableTemplates(existingTemplates);
    console.log(`åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ${existingTemplates.length}ä»¶`, existingTemplates);
  }, []);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
  const showError = useCallback((msg) => {
    if (messageTimeout) {
      clearTimeout(messageTimeout);
      setMessageTimeout(null);
    }
    
    setErrorMsg(msg);
    
    const duration = msg.includes("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ") || 
                     msg.includes("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ") 
                     ? 2000 : 3000;
    
    const timeoutId = setTimeout(() => {
      setErrorMsg("");
      setMessageTimeout(null);
    }, duration);
    
    setMessageTimeout(timeoutId);
  }, [messageTimeout]);

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
  useEffect(() => {
    return () => {
      if (messageTimeout) {
        clearTimeout(messageTimeout);
      }
      if (scrollIntervalId) {
        clearInterval(scrollIntervalId);
      }
    };
  }, [messageTimeout, scrollIntervalId]);

  // ---------- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€é©åŒ–ï¼ˆé€Ÿåº¦èª¿æ•´æ¸ˆã¿ï¼‰ ----------
  const optimizedScroll = useCallback(() => {
    if (scrollDirection === 0) return;
    
    const baseSpeed = 15; // åŸºæœ¬é€Ÿåº¦ï¼ˆpx/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    const multiplier = scrollSpeedMultiplier;
    const direction = Math.sign(scrollDirection);
    const intensity = Math.min(Math.abs(scrollDirection), 3);
    
    let speed = baseSpeed * multiplier * intensity;
    
    // ãƒã‚¦ã‚¹ä½ç½®ã«åŸºã¥ããƒ–ãƒ¼ã‚¹ãƒˆ
    if (lastMousePosition.current) {
      const windowHeight = window.innerHeight;
      const mouseY = lastMousePosition.current.y;
      const aggressiveZone = 50;
      
      const distanceFromEdge = Math.min(mouseY, windowHeight - mouseY);
      if (distanceFromEdge < aggressiveZone) {
        const boost = 1 + (aggressiveZone - distanceFromEdge) / aggressiveZone;
        speed *= boost;
      }
    }
    
    const finalSpeed = direction * Math.min(speed, 200);
    
    window.scrollBy({
      top: finalSpeed,
      behavior: 'instant'
    });
  }, [scrollDirection, scrollSpeedMultiplier]);

  // requestAnimationFrameã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ—
  useEffect(() => {
    if (scrollDirection === 0) return;
    
    let animationFrameId;
    let lastTime = performance.now();
    
    const scrollLoop = (currentTime) => {
      const deltaTime = currentTime - lastTime;
      
      if (deltaTime >= 16) {
        optimizedScroll();
        lastTime = currentTime;
      }
      
      if (scrollDirection !== 0) {
        animationFrameId = requestAnimationFrame(scrollLoop);
      }
    };
    
    animationFrameId = requestAnimationFrame(scrollLoop);
    
    return () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    };
  }, [scrollDirection, optimizedScroll]);

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒã‚¦ã‚¹ç§»å‹•ç›£è¦–ï¼ˆPCã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰
  useEffect(() => {
    const handleGlobalDragOver = (e) => {
      if (!isDragging || !isManageMode || sortBy !== "manual") return;
      
      lastMousePosition.current = { x: e.clientX, y: e.clientY };
      
      const windowHeight = window.innerHeight;
      const scrollThreshold = 80;
      const aggressiveScrollThreshold = 30;
      
      if (e.clientY < aggressiveScrollThreshold) {
        setScrollDirection(-2);
      } else if (e.clientY < scrollThreshold) {
        setScrollDirection(-1);
      } else if (e.clientY > windowHeight - aggressiveScrollThreshold) {
        setScrollDirection(2);
      } else if (e.clientY > windowHeight - scrollThreshold) {
        setScrollDirection(1);
      } else {
        setScrollDirection(0);
      }
    };

    const handleGlobalDragEnd = () => {
      setScrollDirection(0);
      setIsDragging(false);
      setDraggedItemId(null);
      setDragOverItemId(null);
      setDropPosition(null);
      setDragInsertGuide(null);
      
      // é€æ˜åº¦ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.photo-card').forEach(card => {
        card.style.opacity = '1';
        card.style.transform = '';
      });
    };

    if (isDragging && isManageMode && sortBy === "manual") {
      document.addEventListener('dragover', handleGlobalDragOver);
      document.addEventListener('dragend', handleGlobalDragEnd);
      document.addEventListener('drop', handleGlobalDragEnd);
      
      document.body.style.overscrollBehavior = 'none';
      document.body.style.touchAction = 'none';
    }

    return () => {
      document.removeEventListener('dragover', handleGlobalDragOver);
      document.removeEventListener('dragend', handleGlobalDragEnd);
      document.removeEventListener('drop', handleGlobalDragEnd);
      
      document.body.style.overscrollBehavior = '';
      document.body.style.touchAction = '';
    };
  }, [isDragging, isManageMode, sortBy]);

  // ---------- ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒãƒ‰ãƒ©ãƒƒã‚° å®Œå…¨å¯¾å¿œ ----------
  const handleTouchStart = (e, itemId) => {
    if (!isManageMode || sortBy !== "manual") return;
    
    const touch = e.touches[0];
    setTouchStartY(touch.clientY);
    setTouchStartX(touch.clientX);
    setTouchStartTime(Date.now());
    setTouchDraggedItemId(itemId);
    
    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚åŠé€æ˜ã«ã™ã‚‹
    const elem = document.querySelector(`[data-item-id="${itemId}"]`);
    if (elem) elem.style.opacity = '0.5';
    
    // ã“ã“ã§ã¯ preventDefault ã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ï¼‰
  };

  const handleTouchMove = (e, itemId) => {
    if (!touchDraggedItemId) return;
    
    const touch = e.touches[0];
    const deltaY = Math.abs(touch.clientY - touchStartY);
    const deltaX = Math.abs(touch.clientX - touchStartX);
    const deltaTime = Date.now() - touchStartTime;
    
    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åˆ¤å®šï¼ˆé–¾å€¤ã‚’å°‘ã—ä¸‹ã’ã‚‹ï¼‰
    if (!isTouchDragging && deltaY > 5 && deltaX < 30 && deltaTime > 120) {
      setIsTouchDragging(true);
      setDraggedItemId(touchDraggedItemId);
      setIsDragging(true);
      e.preventDefault(); // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒ­ãƒƒã‚¯
    }
    
    if (isTouchDragging) {
      e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
      
      // ãƒã‚¦ã‚¹ä½ç½®æ›´æ–°ï¼ˆè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰
      lastMousePosition.current = { x: touch.clientX, y: touch.clientY };
      
      // ç”»é¢ç«¯ã§ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®š
      const windowHeight = window.innerHeight;
      const scrollThreshold = 90;
      if (touch.clientY < scrollThreshold) {
        setScrollDirection(-1);
      } else if (touch.clientY > windowHeight - scrollThreshold) {
        setScrollDirection(1);
      } else {
        setScrollDirection(0);
      }
      
      // ä»–ã®ã‚«ãƒ¼ãƒ‰ã®ä¸Šã«ã„ã‚‹å ´åˆã€ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’å‘¼ã³å‡ºã™
      if (itemId && itemId !== touchDraggedItemId) {
        // handleDragOver ã«ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¸¡ã™ï¼ˆclientY ã‚’ä½¿ã†ãŸã‚ï¼‰
        handleDragOver(e, itemId);
      }
    }
  };

  const handleTouchEnd = (e, itemId) => {
    if (isTouchDragging && touchDraggedItemId && itemId && itemId !== touchDraggedItemId) {
      handleDrop(e, itemId);
    } else {
      handleDragEnd(e); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    }
    
    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    setIsTouchDragging(false);
    setTouchDraggedItemId(null);
    setTouchStartY(null);
    setTouchStartTime(null);
    setTouchStartX(null);
    setScrollDirection(0);
    
    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®é€æ˜åº¦ã‚’æˆ»ã™
    if (touchDraggedItemId) {
      const elem = document.querySelector(`[data-item-id="${touchDraggedItemId}"]`);
      if (elem) elem.style.opacity = '1';
    }
    
    if (e.cancelable) e.preventDefault();
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ãƒƒãƒãƒªã‚¹ãƒŠãƒ¼ï¼ˆæŒ‡ãŒã‚«ãƒ¼ãƒ‰å¤–ã«å‡ºã¦ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ç¶™ç¶šï¼‰
  useEffect(() => {
    const globalTouchMove = (e) => {
      if (!isTouchDragging || !isManageMode || sortBy !== "manual") return;
      e.preventDefault(); // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒ­ãƒƒã‚¯
      
      const touch = e.touches[0];
      lastMousePosition.current = { x: touch.clientX, y: touch.clientY };
      
      const windowHeight = window.innerHeight;
      const scrollThreshold = 90;
      
      if (touch.clientY < scrollThreshold) {
        setScrollDirection(-1);
      } else if (touch.clientY > windowHeight - scrollThreshold) {
        setScrollDirection(1);
      } else {
        setScrollDirection(0);
      }
    };

    const globalTouchEnd = (e) => {
      if (!isTouchDragging) return;
      // å¼·åˆ¶çµ‚äº†ï¼ˆã‚«ãƒ¼ãƒ‰å¤–ã§æŒ‡ã‚’é›¢ã—ãŸå ´åˆï¼‰
      handleDragEnd(e);
      setIsTouchDragging(false);
      setTouchDraggedItemId(null);
      setScrollDirection(0);
    };

    if (isTouchDragging && isManageMode && sortBy === "manual") {
      document.addEventListener('touchmove', globalTouchMove, { passive: false });
      document.addEventListener('touchend', globalTouchEnd, { passive: false });
      document.addEventListener('touchcancel', globalTouchEnd, { passive: false });
    }

    return () => {
      document.removeEventListener('touchmove', globalTouchMove);
      document.removeEventListener('touchend', globalTouchEnd);
      document.removeEventListener('touchcancel', globalTouchEnd);
    };
  }, [isTouchDragging, isManageMode, sortBy]);

  // Firebaseãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
  useEffect(() => {
    if (!window.fb) {
      setIsAuthReady(true);
      return;
    }
    const unsubscribe = window.fb.onAuthStateChanged(window.fb.auth, async (currentUser) => {
      setUser(currentUser);
      setIsAuthReady(true);
      
      if (currentUser) {
        await loadFromFirestore(currentUser.uid);
      }
      
      checkTemplateFiles();
    });
    return () => unsubscribe();
  }, [checkTemplateFiles]);

  // Firestoreèª­ã¿è¾¼ã¿
  const loadFromFirestore = async (userId) => {
    try {
      setIsLoading(true);
      const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
      const docSnap = await window.fb.getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (Array.isArray(data.groups) && data.groups.length > 0) {
          setGroups(data.groups);
          setSelectedGroup(data.groups[0].name);
          if (data.groups[0].members.length > 0) setSelectedMember(data.groups[0].members[0]);
        }
        if (Array.isArray(data.items)) {
          setItems(data.items.map((item, index) => ({ ...item, order: item.order !== undefined ? item.order : index })));
        }
        showError("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        setLastSaved(new Date().toLocaleTimeString());
      } else {
        await saveToFirestore(userId);
      }
    } catch (error) {
      console.error("Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
      showError("ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      setIsLoading(false);
    }
  };

  // Firestoreä¿å­˜
  const saveToFirestore = async (userId) => {
    try {
      const docRef = window.fb.doc(window.fb.db, "users", userId, "data", "photocards");
      await window.fb.setDoc(docRef, { groups, items, lastUpdated: new Date().toISOString() }, { merge: true });
      showError("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ âœ“");
      setLastSaved(new Date().toLocaleTimeString());
    } catch (error) {
      console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
      showError(`ä¿å­˜å¤±æ•—: ${error.message}`);
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items }));
    }
  };

  // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
  useEffect(() => { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items })); 
    localStorage.setItem("dark_mode", isDarkMode);
    localStorage.setItem("app_width", appWidth);
  }, [groups, items, isDarkMode, appWidth]);

  // è‡ªå‹•Firestoreä¿å­˜
  useEffect(() => {
    if (!user) return;
    const timer = setTimeout(() => saveToFirestore(user.uid), 20000);
    return () => clearTimeout(timer);
  }, [groups, items, user]);

  // Googleãƒ­ã‚°ã‚¤ãƒ³
  const handleGoogleLogin = async () => {
    try {
      await window.fb.signInWithPopup(window.fb.auth, window.fb.provider);
    } catch (error) {
      showError("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  const handleLogout = async () => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ groups, items }));
      await window.fb.signOut(window.fb.auth);
    } catch (error) {
      showError("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  const handleManualSave = async () => {
    if (!user) { showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; }
    await saveToFirestore(user.uid);
  };

  const handleManualLoad = async () => {
    if (!user) { showError("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; }
    await loadFromFirestore(user.uid);
  };

  const updateItem = useCallback((id, key, val) => {
    setItems(p => p.map(i => i.id === id ? { ...i, [key]: val } : i));
  }, []);

  const toggleSelectItem = (id) => {
    if (!isManageMode) return;
    setSelectedItemIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  };

  const toggleSignCounters = (id) => {
    setExpandedSignItems(prev => prev.includes(id) ? prev.filter(itemId => itemId !== id) : [...prev, id]);
  };

  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆPCï¼‰
  const handleDragStart = (e, itemId) => {
    if (!isManageMode || sortBy !== "manual") return;
    e.dataTransfer.setData('text/plain', itemId);
    e.dataTransfer.effectAllowed = 'move';
    setDraggedItemId(itemId);
    setIsDragging(true);
    setTimeout(() => {
      const elem = document.querySelector(`[data-item-id="${itemId}"]`);
      if (elem) elem.style.opacity = '0.5';
    }, 0);
  };

  const calculateDropPosition = (e, element) => {
    const rect = element.getBoundingClientRect();
    let y;
    if (e.type.includes('touch')) {
      const touch = e.touches[0];
      y = touch.clientY;
    } else {
      y = e.clientY;
    }
    const threshold = rect.height / 3;
    if (y < rect.top + threshold) return { position: 'before', guideY: rect.top };
    if (y > rect.bottom - threshold) return { position: 'after', guideY: rect.bottom };
    return { position: 'middle', guideY: rect.top + rect.height / 2 };
  };

  const handleDragOver = (e, itemId) => {
    if (!isManageMode || sortBy !== "manual" || (!draggedItemId && !touchDraggedItemId)) return;
    e.preventDefault();
    if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
    
    const currentDraggedId = draggedItemId || touchDraggedItemId;
    if (currentDraggedId === itemId) return;
    
    const { position, guideY } = calculateDropPosition(e, e.currentTarget);
    setDragOverItemId(itemId);
    setDropPosition(position);
    setDragInsertGuide(guideY);
  };

  const handleDragLeave = (e) => {
    if (!isManageMode || sortBy !== "manual") return;
    setDragOverItemId(null);
    setDropPosition(null);
    setDragInsertGuide(null);
  };

  const handleDragEnd = (e) => {
    if (!isManageMode || sortBy !== "manual") return;
    setScrollDirection(0);
    
    document.querySelectorAll('.photo-card').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = '';
    });
    
    if (draggedItemId) {
      const elem = document.querySelector(`[data-item-id="${draggedItemId}"]`);
      if (elem) elem.style.opacity = '1';
    }
    if (touchDraggedItemId) {
      const elem = document.querySelector(`[data-item-id="${touchDraggedItemId}"]`);
      if (elem) elem.style.opacity = '1';
    }
    
    setIsDragging(false);
    setDraggedItemId(null);
    setTouchDraggedItemId(null);
    setDragOverItemId(null);
    setDropPosition(null);
    setDragInsertGuide(null);
  };

  const handleDrop = (e, targetItemId) => {
    if (!isManageMode || sortBy !== "manual") return;
    
    const currentDraggedId = draggedItemId || touchDraggedItemId;
    if (!currentDraggedId) return;
    
    e.preventDefault();
    e.stopPropagation();
    setScrollDirection(0);
    setDragInsertGuide(null);
    
    if (currentDraggedId === targetItemId) {
      document.querySelectorAll('.photo-card').forEach(card => {
        card.style.opacity = '1';
        card.style.transform = '';
      });
      return;
    }
    
    const draggedItem = items.find(item => item.id === currentDraggedId);
    const targetItem = items.find(item => item.id === targetItemId);
    if (!draggedItem || !targetItem) return;
    
    const currentFiltered = items.filter(i => 
      (selectedGroup === "ALL" || i.group === selectedGroup) && 
      (selectedMember === "ALL" || i.member === selectedMember)
    );
    const currentSorted = [...currentFiltered].sort((a, b) => (a.order || 0) - (b.order || 0));
    
    const draggedIndex = currentSorted.findIndex(item => item.id === currentDraggedId);
    const targetIndex = currentSorted.findIndex(item => item.id === targetItemId);
    if (draggedIndex === -1 || targetIndex === -1) return;
    
    const newOrderItems = [...currentSorted];
    newOrderItems.splice(draggedIndex, 1);
    
    let insertIndex;
    if (dropPosition === 'before') insertIndex = targetIndex;
    else if (dropPosition === 'after') insertIndex = targetIndex + 1;
    else insertIndex = targetIndex + 1;
    
    if (draggedIndex < insertIndex) insertIndex--;
    newOrderItems.splice(insertIndex, 0, draggedItem);
    
    const orderMap = new Map();
    newOrderItems.forEach((item, index) => orderMap.set(item.id, index));
    
    setItems(items.map(item => orderMap.has(item.id) ? { ...item, order: orderMap.get(item.id) } : item)
      .sort((a, b) => (a.order || 0) - (b.order || 0)));
    
    setDraggedItemId(null);
    setTouchDraggedItemId(null);
    setDragOverItemId(null);
    setDropPosition(null);
    
    showError(`ã€Œ${draggedItem.name}ã€ã‚’ç§»å‹•ã—ã¾ã—ãŸ`);
    
    document.querySelectorAll('.photo-card').forEach(card => {
      card.style.opacity = '1';
      card.style.transform = '';
    });
  };

  // ä¸¦ã³é †ãƒªã‚»ãƒƒãƒˆï¼ˆè¡¨ç¤ºä¸­ã®ã¿ï¼‰
  const resetOrder = () => {
    if (confirm('ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é †ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
      const currentItems = items.filter(i => 
        (selectedGroup === "ALL" || i.group === selectedGroup) && 
        (selectedMember === "ALL" || i.member === selectedMember)
      );
      const sortedByDate = [...currentItems].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      const orderMap = new Map();
      sortedByDate.forEach((item, index) => orderMap.set(item.id, index));
      setItems(items.map(item => orderMap.has(item.id) ? { ...item, order: orderMap.get(item.id) } : item)
        .sort((a, b) => (a.order || 0) - (b.order || 0)));
      showError('ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆæ–°ã—ã„é †ï¼‰');
    }
  };

  const resetAllOrder = () => {
    if (confirm('ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸¦ã³é †ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      const sortedAll = [...items].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      const updated = sortedAll.map((item, index) => ({ ...item, order: index }));
      setItems(updated);
      showError('ã™ã¹ã¦ã®ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }
  };

  // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  const handleImportCSV = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (selectedGroup === "ALL" || selectedMember === "ALL") { 
      showError("ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); 
      e.target.value = ""; 
      return; 
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const text = ev.target.result;
        const hasTabs = text.includes('\t');
        const delimiter = hasTabs ? '\t' : ',';
        const rows = parseCSV(text, delimiter);
        const newItems = rows.map((row, index) => {
          if (hasTabs) return parseTabCSVRowToItem(row, selectedGroup, selectedMember, items.length + index);
          else return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, items.length + index);
        }).filter(Boolean);
        setItems(p => [...p, ...newItems]);
        showError(`${newItems.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
      } catch(err) { showError("CSVå½¢å¼ã‚¨ãƒ©ãƒ¼: " + err.message); }
    };
    reader.readAsText(file, 'UTF-8');
    e.target.value = "";
  };

  const loadExternalTemplate = async (fileName) => {
    try {
      setIsLoading(true);
      const response = await fetch(fileName);
      if (!response.ok) throw new Error(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      const csvText = await response.text();
      const hasTabs = csvText.includes('\t');
      const delimiter = hasTabs ? '\t' : ',';
      const rows = parseCSV(csvText, delimiter);
      const newItems = rows.map((row, index) => {
        if (hasTabs) return parseTabCSVRowToItem(row, selectedGroup, selectedMember, items.length + index);
        else return parseCommaCSVRowToItem(row, selectedGroup, selectedMember, items.length + index);
      }).filter(Boolean);
      setItems(p => [...p, ...newItems]);
      showError(`${newItems.length}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      setActiveModal(null);
    } catch (err) {
      showError(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`);
      checkTemplateFiles();
    } finally {
      setIsLoading(false);
    }
  };

  const handleCSVExport = () => {
    const csvData = items.map(i => [
      i.group, i.member, i.name, i.yori, i.chuu, i.hiki, i.memo||"", i.thumbnail||"", i.price||"", i.source||"å…¥æ‰‹å…ˆ", i.isWish?"1":"0", (i.otherImages||[]).join("|"), i.syori||0, i.schuu||0, i.shiki||0, i.order||0
    ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csvData], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a"); 
    a.href = URL.createObjectURL(blob); 
    a.download="photo_data.csv"; 
    a.click();
  };

  const handleTSVExport = () => {
    const tsvData = items.map(i => {
      const thumbnail = i.thumbnail || "";
      const name = i.name || "";
      const otherImages = (i.otherImages || []).join("\n");
      return `${thumbnail}\t${name}\t"${otherImages}"`;
    }).join("\n");
    
    const blob = new Blob([tsvData], {type:"text/tab-separated-values;charset=utf-8;"});
    const a = document.createElement("a"); 
    a.href = URL.createObjectURL(blob); 
    a.download="photo_data.tsv"; 
    a.click();
  };

  const sortedItems = useMemo(() => {
    let filtered = items.filter(i => 
      (selectedGroup === "ALL" || i.group === selectedGroup) && 
      (selectedMember === "ALL" || i.member === selectedMember) && 
      (i.name && i.name.toLowerCase().includes(search.toLowerCase())) && 
      (!showOnlyWish || i.isWish)
    );
    
    return filtered.sort((a, b) => {
      if (sortBy === "manual") return (a.order || 0) - (b.order || 0);
      const aCount = (a.yori||0)+(a.chuu||0)+(a.hiki||0)+(a.syori||0)+(a.schuu||0)+(a.shiki||0);
      const bCount = (b.yori||0)+(b.chuu||0)+(b.hiki||0)+(b.syori||0)+(b.schuu||0)+(b.shiki||0);
      switch (sortBy) {
        case "name": return (a.name||"").localeCompare(b.name||"", 'ja');
        case "new": return (b.createdAt || 0) - (a.createdAt || 0);
        case "old": return (a.createdAt || 0) - (b.createdAt || 0);
        case "price_high": return (parseInt(b.price)||0) - (parseInt(a.price)||0);
        case "stock_high": return bCount - aCount;
        case "comp_first":
          const aComp = (a.yori>0||a.syori>0) && (a.chuu>0||a.schuu>0) && (a.hiki>0||a.shiki>0);
          const bComp = (b.yori>0||b.syori>0) && (b.chuu>0||b.schuu>0) && (b.hiki>0||b.shiki>0);
          return (bComp?1:0) - (aComp?1:0);
        default: return (b.createdAt || 0) - (a.createdAt || 0);
      }
    });
  }, [items, selectedGroup, selectedMember, search, showOnlyWish, sortBy]);

  const batchAction = (type) => {
    if (selectedItemIds.length === 0 || !isManageMode) return;
    if (type === 'delete') {
      setTargetName(`${selectedItemIds.length}ä»¶ã®é¸æŠé …ç›®`);
      setActiveModal('delete_batch');
    } else if (type === 'wish') {
      setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, isWish: true } : i));
      showError(`${selectedItemIds.length}ä»¶ã‚’â­ã«è¨­å®šã—ã¾ã—ãŸ`);
    } else if (type === 'stock') {
      setItems(p => p.map(i => selectedItemIds.includes(i.id) ? { ...i, yori: (i.yori||0)+1, chuu: (i.chuu||0)+1, hiki: (i.hiki||0)+1 } : i));
      showError(`${selectedItemIds.length}ä»¶ã®åœ¨åº«ã‚’+1ã—ã¾ã—ãŸ`);
    }
  };

  const stats = useMemo(() => {
    const filtered = items.filter(i => (selectedGroup === "ALL" || i.group === selectedGroup) && (selectedMember === "ALL" || i.member === selectedMember));
    const totalKinds = filtered.length;
    const totalCount = filtered.reduce((s,i) => s + (parseInt(i.yori)||0) + (parseInt(i.chuu)||0) + (parseInt(i.hiki)||0) + (parseInt(i.syori)||0) + (parseInt(i.schuu)||0) + (parseInt(i.shiki)||0), 0);
    const totalSlots = totalKinds * 3;
    let collectedSlots = 0;
    let completedKinds = 0;
    filtered.forEach(i => {
      const hasYori = (i.yori > 0 || i.syori > 0);
      const hasChuu = (i.chuu > 0 || i.schuu > 0);
      const hasHiki = (i.hiki > 0 || i.shiki > 0);
      if (hasYori) collectedSlots++;
      if (hasChuu) collectedSlots++;
      if (hasHiki) collectedSlots++;
      if (hasYori && hasChuu && hasHiki) completedKinds++;
    });
    return { totalKinds, totalCount, totalSlots, collectedSlots, completedKinds };
  }, [items, selectedGroup, selectedMember]);

  const openEditImgModal = (item) => {
    setEditItemId(item.id);
    setTempMainUrl(item.thumbnail || "");
    setTempImages(item.otherImages || []);
    setActiveModal('edit_img');
  };

  const saveImages = () => {
    setItems(p => p.map(it => it.id === editItemId ? { ...it, thumbnail: tempMainUrl, otherImages: tempImages } : it));
    setActiveModal(null);
  };

  const handleCacheClear = () => {
    if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆé™¤ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  };

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã‚²ãƒ¼ã‚¸ï¼ˆéè¡¨ç¤ºï¼‰
  const ScrollSpeedGauge = () => null;

  // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå·¦ä¸Šï¼‰
  const SpeedControl = () => (
    <div className="speed-control" style={{
      position: 'fixed', top: '80px', left: '10px', zIndex: 9996,
      display: 'flex', flexDirection: 'column', gap: '5px', alignItems: 'flex-start'
    }}>
      <div style={{
        fontSize: '10px', color: isDarkMode ? '#fff' : '#333', fontWeight: 'bold',
        background: isDarkMode ? 'rgba(0,0,0,0.7)' : 'rgba(255,255,255,0.9)',
        padding: '2px 6px', borderRadius: '8px', backdropFilter: 'blur(4px)', whiteSpace: 'nowrap'
      }}>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦</div>
      <div style={{
        display: 'flex', gap: '2px',
        background: isDarkMode ? 'rgba(0,0,0,0.7)' : 'rgba(255,255,255,0.9)',
        padding: '4px', borderRadius: '12px', backdropFilter: 'blur(4px)'
      }}>
        {[1, 2, 3].map(m => (
          <button key={m} onClick={() => setScrollSpeedMultiplier(m)} style={{
            padding: '3px 6px', fontSize: '9px',
            background: scrollSpeedMultiplier === m ? (m===1?'#2196f3':m===2?'#4caf50':'#ff9800') : 'transparent',
            color: scrollSpeedMultiplier === m ? 'white' : (isDarkMode?'#ccc':'#666'),
            border: '1px solid '+(isDarkMode?'#444':'#ddd'), borderRadius: '8px', cursor: 'pointer',
            fontWeight: 'bold', minWidth: '28px'
          }}>{m}x</button>
        ))}
      </div>
    </div>
  );

  // ãƒ­ã‚°ã‚¤ãƒ³å‰
  if (!isAuthReady) {
    return <div style={{display:'flex',justifyContent:'center',alignItems:'center',height:'100vh',background:'#1a1a1a',color:'#fff'}}>èª­ã¿è¾¼ã¿ä¸­...</div>;
  }

  if (!user) {
    return (
      <div style={{display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',height:'100vh',background:'#1a1a1a',gap:20}}>
        <h1 style={{color:'#fff',fontSize:24}}>ç”Ÿå†™çœŸç®¡ç†For=Love</h1>
        <p style={{color:'#aaa'}}>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
        <button onClick={handleGoogleLogin} style={{padding:'12px 32px',fontSize:16,background:'#4285f4',color:'#fff',border:'none',borderRadius:8,cursor:'pointer',display:'flex',alignItems:'center',gap:10}}>
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#fff" d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z"/><path fill="#fff" d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#fff" d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.002 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z"/></svg>
          Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </div>
    );
  }

  // ãƒ¡ã‚¤ãƒ³ç”»é¢
  return (
    <div className={isDarkMode ? "dark-mode" : ""} style={{ maxWidth: appWidth, margin: '0 auto', minHeight: '100vh', transition: 'max-width 0.3s' }}>
      {errorMsg && <div className="error-toast">âš ï¸ {errorMsg}</div>}
      {isLoading && <div className="loading-overlay"><div className="loading-spinner"></div><div className="loading-text">åŒæœŸä¸­...</div></div>}
      
      {dragInsertGuide !== null && <div className="drag-insert-guide" style={{ top: dragInsertGuide }} />}
      
      {scrollDirection !== 0 && (
        <div className={`scroll-indicator ${scrollDirection === -1 ? 'scroll-up' : 'scroll-down'} ${Math.abs(scrollDirection) >= 2 ? 'turbo' : ''}`}>
          {scrollDirection === -1 ? 'â†‘ ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â†‘' : 'â†“ ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â†“'}
        </div>
      )}
      
      {isDragging && <div className="drag-hint">ğŸ“ ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã®é–“ã«å…¥ã‚Œã¦æŒ¿å…¥ã§ãã¾ã™</div>}
      
      {isManageMode && sortBy === "manual" && (
        <>
          <SpeedControl />
          {scrollSpeedMultiplier > 1 && <div className="turbo-hint">ğŸš€ ã‚¿ãƒ¼ãƒœãƒ¢ãƒ¼ãƒ‰: {scrollSpeedMultiplier}x</div>}
          {scrollDirection !== 0 && (
            <div className={`speed-indicator ${Math.abs(scrollDirection) >= 2 ? 'turbo' : ''}`}>
              {Math.abs(scrollDirection) === 1 ? 'é€šå¸¸' : Math.abs(scrollDirection) === 2 ? 'é«˜é€Ÿ' : 'è¶…é«˜é€Ÿ'}ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­
            </div>
          )}
        </>
      )}
      
      <div className="top-bar">
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <h3 style={{margin:0,fontSize:'16px'}}>ç”Ÿå†™çœŸç®¡ç†For=Love</h3>
          {lastSaved && <span style={{fontSize:10,color:'#4caf50',background:'rgba(76,175,80,0.1)',padding:'2px 6px',borderRadius:4,fontWeight:'bold'}}>âœ“ {lastSaved}</span>}
        </div>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          {user && (
            <div style={{display:'flex',alignItems:'center',gap:6,fontSize:12,padding:'4px 8px',background:isDarkMode?'#2a2a2a':'#f5f5f5',borderRadius:'20px'}}>
              <img src={user.photoURL} alt="avatar" style={{width:24,height:24,borderRadius:'50%',border:isDarkMode?'1px solid #444':'1px solid #ddd'}} />
              <span style={{fontWeight:'bold',color:isDarkMode?'#fff':'#333',maxWidth:'100px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{user.displayName}</span>
            </div>
          )}
          <button onClick={()=>setActiveModal('app_settings')} style={{padding:'6px 12px',background:isDarkMode?'#2a2a2a':'#f5f5f5',border:isDarkMode?'1px solid #444':'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'14px',fontWeight:'bold',display:'flex',alignItems:'center',gap:'4px',color:isDarkMode?'#fff':'#333'}}>âš™ï¸</button>
          <button onClick={()=>setIsDarkMode(!isDarkMode)} style={{padding:'6px 8px',background:isDarkMode?'#2a2a2a':'#f5f5f5',border:isDarkMode?'1px solid #444':'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'16px'}}>{isDarkMode?"â˜€ï¸":"ğŸŒ™"}</button>
        </div>
      </div>

      <div className="main-layout">
        {isManageMode && sortBy === "manual" && (
          <div className="sort-helper">
            <span className="sort-hint">âœ¨ å†™çœŸã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è‡ªç”±ã«ä¸¦ã³æ›¿ãˆã‚‰ã‚Œã¾ã™<br /><small>ã‚¢ã‚¤ãƒ†ãƒ ã®é–“ã«å…¥ã‚Œã‚‹ã¨æŒ¿å…¥ã§ãã¾ã™</small></span>
            <button className="reset-order-btn" onClick={resetOrder}>ğŸ”„ ç¾åœ¨ã®ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        )}
        
        <div className="stats-card">
          <div className="stats-charts-grid">
            <div className="stats-box">
              <div className="stats-label">åé›†ç‡</div>
              <div className="progress-circle-container">
                <div className="progress-circle-bg"></div>
                <div className="progress-circle" style={{background:`conic-gradient(${isDarkMode?'var(--color-primary)':'var(--light-primary)'} 0% ${stats.totalSlots?Math.round((stats.collectedSlots/stats.totalSlots)*100):0}%, transparent ${stats.totalSlots?Math.round((stats.collectedSlots/stats.totalSlots)*100):0}% 100%)`}}></div>
                <div className="progress-circle-mask"><span className="progress-percentage">{stats.totalSlots?Math.round((stats.collectedSlots/stats.totalSlots)*100):0}%</span></div>
              </div>
              <div className="stats-fraction">{stats.collectedSlots} / {stats.totalSlots}</div>
            </div>
            <div className="stats-box">
              <div className="stats-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</div>
              <div className="progress-circle-container">
                <div className="progress-circle-bg"></div>
                <div className="progress-circle" style={{background:`conic-gradient(${isDarkMode?'var(--color-success)':'var(--light-success)'} 0% ${stats.totalKinds?Math.round((stats.completedKinds/stats.totalKinds)*100):0}%, transparent ${stats.totalKinds?Math.round((stats.completedKinds/stats.totalKinds)*100):0}% 100%)`}}></div>
                <div className="progress-circle-mask"><span className="progress-percentage">{stats.totalKinds?Math.round((stats.completedKinds/stats.totalKinds)*100):0}%</span></div>
              </div>
              <div className="stats-fraction">{stats.completedKinds} / {stats.totalKinds}</div>
            </div>
          </div>
          <div className="stats-summary">
            <div className="stat-item"><span className="stat-value">{stats.totalKinds}</span><span className="stat-label">ç·å†™çœŸæ•°</span></div>
            <div className="stat-item"><span className="stat-value">{stats.collectedSlots}</span><span className="stat-label">åé›†æ¸ˆã¿</span></div>
            <div className="stat-item"><span className="stat-value">{stats.completedKinds}</span><span className="stat-label">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ</span></div>
          </div>
        </div>

        <div className="control-panel">
          <div className="control-header">
            <div><strong>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</strong>{isManageMode && <span className="manage-mode-badge">ON</span>}</div>
            <button className="manage-toggle" onClick={()=>setIsManageMode(!isManageMode)} style={{color:isManageMode?'#ff5252':''}}>âœï¸</button>
          </div>
          <div className="filter-row">
            <input className="search-input" placeholder="æ¤œç´¢..." value={search} onChange={e=>setSearch(e.target.value)} />
            <button className={`wish-toggle-btn ${showOnlyWish?'active':''}`} onClick={()=>setShowOnlyWish(!showOnlyWish)}>â­ ã®ã¿</button>
            <select className="sort-select" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
              <option value="manual">æ‰‹å‹•ä¸¦ã³æ›¿ãˆ</option>
              <option value="new">æ–°ã—ã„é †</option>
              <option value="old">å¤ã„é †</option>
              <option value="name">åå‰é †</option>
              <option value="price_high">ä¾¡æ ¼ãŒé«˜ã„é †</option>
              <option value="stock_high">åœ¨åº«ãŒå¤šã„é †</option>
              <option value="comp_first">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå„ªå…ˆ</option>
            </select>
          </div>

          <div className="group-section">
            <div className="section-title"><strong>ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ</strong><button className="add-btn" onClick={()=>setActiveModal('add_group')}>+</button></div>
            <ul className="button-list">
              <li><button className={`btn-item ${selectedGroup==='ALL'?'active':''}`} onClick={()=>{setSelectedGroup('ALL');setSelectedMember('ALL');}}>ALL</button></li>
              {groups.map(g=>(
                <li key={g.name}>
                  <button className={`btn-item ${selectedGroup===g.name?'active':''}`} onClick={()=>{setSelectedGroup(g.name);setSelectedMember(g.members.length>0?g.members[0]:'ALL');}}>
                    {g.name}
                    {isManageMode && <button className="btn-delete-small" onClick={(e)=>{e.stopPropagation();setTargetName(g.name);setActiveModal('delete_group');}}>Ã—</button>}
                  </button>
                </li>
              ))}
            </ul>
          </div>

          <div className="member-section">
            <div className="section-title"><strong>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</strong>{selectedGroup!=='ALL'&&selectedGroup&&<button className="add-btn" onClick={()=>setActiveModal('add_member')}>+</button>}</div>
            <ul className="button-list">
              <li><button className={`btn-item ${selectedMember==='ALL'?'active':''}`} onClick={()=>setSelectedMember('ALL')}>ALL</button></li>
              {selectedGroup!=='ALL' && groups.find(g=>g.name===selectedGroup)?.members.map(m=>(
                <li key={m}>
                  <button className={`btn-item ${selectedMember===m?'active':''}`} onClick={()=>setSelectedMember(m)}>
                    {m}
                    {isManageMode && <button className="btn-delete-small" onClick={(e)=>{e.stopPropagation();setTargetName(m);setActiveModal('delete_member');}}>Ã—</button>}
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </div>

        {selectedGroup !== "ALL" && selectedMember !== "ALL" && (
          <button className="add-trigger-btn" onClick={()=>setActiveModal('add_photo')}>ï¼‹ ç”Ÿå†™çœŸã‚’è¿½åŠ </button>
        )}

        {sortedItems.map(i => {
          const comp = (i.yori>0||i.syori>0) && (i.chuu>0||i.schuu>0) && (i.hiki>0||i.shiki>0);
          const isSelected = selectedItemIds.includes(i.id);
          const isSignExpanded = expandedSignItems.includes(i.id);
          const isDragged = draggedItemId === i.id || touchDraggedItemId === i.id;
          const isDragOver = dragOverItemId === i.id;
          
          return (
            <div 
              key={i.id} 
              data-item-id={i.id}
              className={`photo-card ${comp ? 'is-complete' : ''} ${i.isWish ? 'is-wish' : ''} ${isDragged ? 'is-dragging' : ''} ${isDragOver ? 'drag-over' : ''} ${isDragOver && dropPosition ? `drop-${dropPosition}` : ''}`}
              style={{background: (isManageMode && isSelected) ? 'rgba(255, 82, 82, 0.1)' : ''}}
              draggable={isManageMode && sortBy === "manual"}
              onDragStart={(e) => handleDragStart(e, i.id)}
              onDragOver={(e) => handleDragOver(e, i.id)}
              onDragLeave={handleDragLeave}
              onDragEnd={handleDragEnd}
              onDrop={(e) => handleDrop(e, i.id)}
              // ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
              onTouchStart={(e) => handleTouchStart(e, i.id)}
              onTouchMove={(e) => handleTouchMove(e, i.id)}
              onTouchEnd={(e) => handleTouchEnd(e, i.id)}
              onTouchCancel={(e) => handleTouchEnd(e, i.id)}
            >
              {isManageMode && sortBy === "manual" && (
                <div className="drag-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ" onTouchStart={(e)=>{e.stopPropagation();handleTouchStart(e,i.id);}}>â‹®â‹®</div>
              )}
              
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:10}}>
                {isManageMode && <input type="checkbox" className="selection-checkbox" checked={isSelected} onChange={()=>toggleSelectItem(i.id)} />}
                <div className="img-container">
                  <div className="btn-img-add" onClick={()=>openEditImgModal(i)}>ï¼‹</div>
                  <div style={{width:65,cursor:'pointer'}} onClick={()=>{
                    const imgs = [i.thumbnail, ...(i.otherImages||[])].filter(Boolean);
                    if(imgs.length) setViewer({ images: imgs, index: 0, name: i.name });
                    else openEditImgModal(i);
                  }}>
                    {i.thumbnail ? <img src={i.thumbnail} style={{width:'100%',borderRadius:4}} /> : <div style={{background:'#eee',height:60,borderRadius:4,fontSize:8,textAlign:'center',display:'flex',alignItems:'center',justifyContent:'center',color:'#888'}}>ç”»åƒãªã—</div>}
                  </div>
                </div>
              </div>
              <div className="card-content">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div style={{flex:1,minWidth:0,display:'flex',alignItems:'center',gap:8}}>
                    <button className={`wish-toggle ${i.isWish?'active':''}`} onClick={()=>updateItem(i.id,'isWish',!i.isWish)}>â­</button>
                    {editingNameId===i.id ? (
                      <input className="edit-name-input" autoFocus value={i.name} onChange={e=>updateItem(i.id,'name',e.target.value)} onBlur={()=>setEditingNameId(null)} onKeyDown={e=>{if(e.key==='Enter')setEditingNameId(null);}} />
                    ) : (
                      <span className="name-display" onClick={()=>setEditingNameId(i.id)}>{i.name} {comp && "ğŸ‘ï¸"}</span>
                    )}
                  </div>
                  <button onClick={()=>{setTargetName(i.name);setTargetId(i.id);setActiveModal('delete_photo');}} style={{color:'#999',border:'none',background:'none',cursor:'pointer'}}>âœ•</button>
                </div>
                <div style={{display:'flex',gap:4,flexWrap:'wrap',marginBottom:8}}>
                  {[ {k:'yori',l:'å¯„'}, {k:'chuu',l:'ä¸­'}, {k:'hiki',l:'å¼•'} ].map(o => (
                    <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-stock' : ''}`}>
                      <span style={{fontSize:9,padding:'0 4px',fontWeight:'bold'}}>{o.l}</span>
                      <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                      <span className="qty-val">{i[o.k]||0}</span>
                      <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,(parseInt(i[o.k])||0)+1)}>+</button>
                    </div>
                  ))}
                </div>
                <div className="sign-counters-container">
                  <button className={`sign-counters-toggle ${isSignExpanded?'active':''}`} onClick={()=>toggleSignCounters(i.id)}>ã‚µã‚¤ãƒ³ä»˜ãã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</button>
                  <div className={`sign-counters-content ${isSignExpanded?'expanded':''}`}>
                    {[ {k:'syori',l:'ã‚µã‚¤ãƒ³å¯„'}, {k:'schuu',l:'ã‚µã‚¤ãƒ³ä¸­'}, {k:'shiki',l:'ã‚µã‚¤ãƒ³å¼•'} ].map(o => (
                      <div key={o.k} className={`counter-group ${i[o.k] > 0 ? 'has-sign' : ''}`}>
                        <span style={{fontSize:9,padding:'0 4px',fontWeight:'bold'}}>{o.l}</span>
                        <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,Math.max(0,(parseInt(i[o.k])||0)-1))}>-</button>
                        <span className="qty-val">{i[o.k]||0}</span>
                        <button className="btn-qty" onClick={()=>updateItem(i.id,o.k,(parseInt(i[o.k])||0)+1)}>+</button>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="row-inputs" style={{flexWrap:'wrap',gap:'8px',marginTop:'8px'}}>
                  <select className="source-select" value={i.source||"å…¥æ‰‹å…ˆ"} onChange={e=>updateItem(i.id,'source',e.target.value)} style={{height:'36px'}}>
                    {SOURCE_OPTIONS.map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                  <input className="details-input" style={{flex:'1 1 150px',height:'36px'}} placeholder="ãƒ¡ãƒ¢" value={i.memo||""} onChange={e=>updateItem(i.id,'memo',e.target.value)} />
                  <div className="price-wrapper">
                    <input className="details-input" style={{width:'100%'}} placeholder="ä¾¡æ ¼" value={formatWithComma(i.price)} onChange={e=>updateItem(i.id,'price',e.target.value.replace(/\D/g,'').slice(0,7))} />
                    <span className="currency-unit">å††</span>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {isManageMode && sortedItems.length > 0 && (
        <div className="selection-bar">
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <input type="checkbox" className="selection-checkbox" checked={selectedItemIds.length>0 && selectedItemIds.length===sortedItems.length} onChange={(e)=>{if(e.target.checked) setSelectedItemIds(sortedItems.map(it=>it.id)); else setSelectedItemIds([]);}} />
            <span style={{fontSize:12,fontWeight:'bold'}}>{selectedItemIds.length}ä»¶é¸æŠä¸­</span>
          </div>
          <div style={{display:'flex',gap:8}}>
            <button className="batch-btn" onClick={()=>batchAction('wish')}>ä¸€æ‹¬ãŠæ°—ã«å…¥ã‚Š</button>
            <button className="batch-btn" onClick={()=>batchAction('stock')}>ã™ã¹ã¦+1</button>
            <button className="batch-btn" style={{background:'#000'}} onClick={()=>batchAction('delete')}>å‰Šé™¤</button>
          </div>
        </div>
      )}

      {viewer && (
        <div className="lightbox" onClick={()=>setViewer(null)}>
          <div className="lightbox-close">Ã—</div>
          <img src={viewer.images[viewer.index]} onClick={(e)=>{e.stopPropagation();setViewer({...viewer,index:(viewer.index+1)%viewer.images.length});}} />
          <div className="lightbox-info"><strong>{viewer.name}</strong><br/>{viewer.index+1} / {viewer.images.length}</div>
        </div>
      )}

      {activeModal && (
        <div className="modal-overlay" onClick={()=>setActiveModal(null)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            {activeModal === 'app_settings' && (
              <div>
                <h3 style={{margin:'0 0 15px 0'}}>è¨­å®š</h3>
                {user && (
                  <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px',border:'1px solid '+(isDarkMode?'#444':'#eee')}}>
                    <div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'10px'}}>
                      <img src={user.photoURL} alt="avatar" style={{width:40,height:40,borderRadius:'50%'}} />
                      <div><div style={{fontWeight:'bold',fontSize:'14px'}}>{user.displayName}</div><div style={{fontSize:'11px',color:'#666'}}>{user.email}</div></div>
                    </div>
                    {lastSaved && <div style={{fontSize:'12px',color:'#4caf50',textAlign:'center'}}>âœ“ æœ€çµ‚ä¿å­˜: {lastSaved}</div>}
                  </div>
                )}
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px',border:'1px solid '+(isDarkMode?'#444':'#eee')}}>
                  <h4 style={{marginTop:0,marginBottom:'10px'}}>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h4>
                  <div style={{display:'flex',gap:'8px',marginBottom:'10px'}}>
                    <button onClick={handleManualSave} style={{flex:1,padding:'10px',background:'#4caf50',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'12px',fontWeight:'bold'}}>ğŸ’¾ æ‰‹å‹•ä¿å­˜</button>
                    <button onClick={handleManualLoad} style={{flex:1,padding:'10px',background:'#2196f3',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'12px',fontWeight:'bold'}}>ğŸ”„ æ‰‹å‹•èª­è¾¼</button>
                  </div>
                  <p style={{fontSize:'11px',color:'#666',margin:0}}>ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚åˆ¥ã®ç«¯æœ«ã§åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨åŒæœŸã•ã‚Œã¾ã™ã€‚</p>
                </div>
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px',border:'1px solid '+(isDarkMode?'#444':'#eee')}}>
                  <h4 style={{marginTop:0,marginBottom:'10px'}}>ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h4>
                  <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                    <button onClick={handleCSVExport} style={{padding:'10px',background:'#ff9800',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'12px',fontWeight:'bold'}}>ğŸ“¤ CSVå‡ºåŠ›ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</button>
                    <button onClick={handleTSVExport} style={{padding:'10px',background:'#9c27b0',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'12px',fontWeight:'bold'}}>ğŸ“¤ TSVå‡ºåŠ›ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰</button>
                    <label style={{padding:'10px',background:'#2196f3',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'12px',fontWeight:'bold',textAlign:'center'}}>
                      ğŸ“¥ CSV/TSVå–è¾¼<input type="file" accept=".csv,.tsv,.txt" style={{display:'none'}} onChange={handleImportCSV} />
                    </label>
                    {availableTemplates.length > 0 && (
                      <div style={{marginTop:'10px'}}>
                        <div style={{fontSize:'11px',color:'#666',marginBottom:'5px'}}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ ({availableTemplates.length}ä»¶):</div>
                        <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'5px'}}>
                          {availableTemplates.map(fileName=>(
                            <button key={fileName} onClick={()=>loadExternalTemplate(fileName)} style={{padding:'8px',background:'#9c27b0',color:'white',border:'none',borderRadius:'6px',cursor:'pointer',fontSize:'11px',fontWeight:'bold',textAlign:'center'}}>{fileName.replace('.csv','')}</button>
                          ))}
                        </div>
                      </div>
                    )}
                    {availableTemplates.length === 0 && (
                      <div style={{marginTop:'10px',padding:'10px',background:isDarkMode?'#333':'#f5f5f5',borderRadius:'8px',textAlign:'center'}}>
                        <p style={{fontSize:'11px',color:'#666',margin:0}}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
                      </div>
                    )}
                  </div>
                </div>
                <div style={{marginBottom:'15px',padding:'15px',background:isDarkMode?'#2a2a2a':'#f9f9f9',borderRadius:'12px',border:'1px solid '+(isDarkMode?'#444':'#eee')}}>
                  <h4 style={{marginTop:0,marginBottom:'10px'}}>è¡¨ç¤ºè¨­å®š</h4>
                  <label style={{fontSize:'12px',color:'#888',display:'flex',justifyContent:'space-between'}}><span>ã‚µã‚¤ãƒˆã®å¹…</span><b>{appWidth==='100%'?'ãƒ•ãƒ«ç”»é¢':appWidth}</b></label>
                  <input type="range" min="350" max="1200" step="10" value={appWidth==='100%'?1200:parseInt(appWidth)} onChange={e=>setAppWidth(`${e.target.value}px`)} style={{width:'100%',height:'30px',cursor:'pointer',accentColor:'#2196f3'}} />
                  <div style={{display:'flex',gap:'8px',marginTop:'12px'}}>
                    <button onClick={()=>setAppWidth('400px')} style={quickBtnStyle(isDarkMode)}>ã‚¹ãƒãƒ›</button>
                    <button onClick={()=>setAppWidth('600px')} style={quickBtnStyle(isDarkMode)}>æ¨™æº–</button>
                    <button onClick={()=>setAppWidth('900px')} style={quickBtnStyle(isDarkMode)}>ãƒ¯ã‚¤ãƒ‰</button>
                    <button onClick={()=>setAppWidth('100%')} style={quickBtnStyle(isDarkMode)}>ãƒ•ãƒ«</button>
                  </div>
                </div>
                <ul className="settings-list">
                  <li onClick={resetAllOrder} style={{color:'#ff9800',fontWeight:'bold'}}>ğŸ”„ ã™ã¹ã¦ã®ä¸¦ã³é †ã‚’ãƒªã‚»ãƒƒãƒˆ</li>
                  <li onClick={handleCacheClear}>ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰å‰Šé™¤</li>
                  <li onClick={()=>alert("è¦ç´„ï¼›ã“ã®ã‚µã‚¤ãƒˆã¯å€‹äººã®è‡ªå·±æº€è¶³ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã«ã¤ãã¾ã—ã¦ã¯ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚ã¾ãŸä»£ã€…æœ¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ§˜ã€ã¾ãŸ=Loveæ§˜ã®è¦æœ›ãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã®ã™ã¹ã¦ã®æ¨©åˆ©ãªã©ã‚’è­²æ¸¡ã—ã¾ã™ã€‚ã¾ãŸã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã«ç½®ãã¾ã—ã¦åˆ©ç›Šã‚’å¾—ã‚‹ã“ã¨ã¯ã„ãŸã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚")}>ğŸ“œ è¦ç´„</li>
                  <li onClick={()=>window.open("https://github.com/Meowx7","_blank")}>ğŸ± GitHub</li>
                  <li onClick={handleLogout} style={{color:'#ff5252',fontWeight:'bold'}}>ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
                  <li style={{color:'#888',cursor:'default',fontSize:'11px',justifyContent:'center'}}>Version 1.6.1</li>
                </ul>
                <button onClick={()=>setActiveModal(null)} style={{width:'100%',padding:12,background:'#eee',border:'none',borderRadius:8,fontWeight:'bold',cursor:'pointer'}}>é–‰ã˜ã‚‹</button>
              </div>
            )}
            {activeModal === 'add_photo' && (
              <div><h3>æ–°è¦è¿½åŠ </h3><input type="text" placeholder="ç”Ÿå†™çœŸã‚»ãƒƒãƒˆå" id="modal_name" autoFocus /><button onClick={()=>{const v=document.getElementById("modal_name").value;if(v){const newItem={id:genId(),group:selectedGroup,member:selectedMember,name:v,yori:0,chuu:0,hiki:0,syori:0,schuu:0,shiki:0,isWish:false,createdAt:Date.now(),memo:"",price:"",source:"å…¥æ‰‹å…ˆ",thumbnail:"",otherImages:[],order:items.length};setItems(p=>[...p,newItem]);setActiveModal(null);}}} style={{width:'100%',padding:12,background:'#2196f3',color:'#fff',border:'none',borderRadius:8,marginTop:10}}>è¿½åŠ </button></div>
            )}
            {activeModal === 'add_group' && (
              <div><h3>ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{if(e.key==='Enter'){const val=e.target.value.trim();if(!val)return showError("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");setGroups(p=>[...p,{name:val,members:[]}]);setActiveModal(null);}}}/></div>
            )}
            {activeModal === 'add_member' && (
              <div><h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3><input type="text" autoFocus onKeyDown={e=>{if(e.key==='Enter'){const val=e.target.value.trim();if(!val)return showError("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:[...g.members,val]}:g));setActiveModal(null);}}}/></div>
            )}
            {activeModal === 'edit_img' && (
              <div>
                <h3>ç”»åƒç®¡ç†</h3>
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8,marginBottom:10}}>
                  {tempMainUrl && <div style={{position:'relative'}}><img src={tempMainUrl} style={{width:'100%',height:60,objectFit:'cover',borderRadius:4}}/><button onClick={()=>setTempMainUrl("")} style={{position:'absolute',top:0,right:0,background:'red',color:'white',border:'none'}}>Ã—</button></div>}
                  {tempImages.map((u,idx)=><div key={idx} style={{position:'relative'}}><img src={u} style={{width:'100%',height:60,objectFit:'cover',borderRadius:4}}/><button onClick={()=>setTempImages(p=>p.filter((_,i)=>i!==idx))} style={{position:'absolute',top:0,right:0,background:'red',color:'white',border:'none'}}>Ã—</button></div>)}
                </div>
                <label style={{display:'block',padding:10,background:'#2196f3',color:'white',textAlign:'center',borderRadius:8,cursor:'pointer',marginBottom:10}}>
                  ç«¯æœ«ã‹ã‚‰é¸æŠ<input type="file" multiple style={{display:'none'}} onChange={async(e)=>{const files=Array.from(e.target.files);for(const f of files){const c=await compressImage(f);if(!tempMainUrl)setTempMainUrl(c);else setTempImages(p=>[...p,c]);}}}/>
                </label>
                <input type="text" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘ã¦Enter" onKeyDown={e=>{if(e.key==='Enter'&&e.target.value){const urls=e.target.value.split(/[, \n]+/).filter(Boolean);urls.forEach(u=>{if(!tempMainUrl)setTempMainUrl(u);else setTempImages(p=>[...p,u]);});e.target.value="";}}}/>
                <button onClick={saveImages} style={{width:'100%',padding:12,background:'#4caf50',color:'#fff',border:'none',borderRadius:8,marginTop:10}}>ä¿å­˜</button>
              </div>
            )}
            {activeModal === 'delete_group' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.group!==targetName));setGroups(p=>p.filter(g=>g.name!==targetName));if(selectedGroup===targetName){setSelectedGroup("ALL");setSelectedMember("ALL");}setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_member' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.member!==targetName));setGroups(p=>p.map(g=>g.name===selectedGroup?{...g,members:g.members.filter(m=>m!==targetName)}:g));if(selectedMember===targetName)setSelectedMember("ALL");setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_photo' && (
              <div><h3>ã€Œ{targetName}ã€ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>i.id!==targetId));setActiveModal(null);}} style={{width:'100%',padding:12,background:'#ff5252',color:'#fff',border:'none',borderRadius:8}}>å‰Šé™¤</button></div>
            )}
            {activeModal === 'delete_batch' && (
              <div><h3>{targetName}ã‚’å‰Šé™¤ï¼Ÿ</h3><button onClick={()=>{setItems(p=>p.filter(i=>!selectedItemIds.includes(i.id)));setSelectedItemIds([]);setActiveModal(null);}} style={{width:'100%',padding:12,background:'#000',color:'#fff',border:'none',borderRadius:8}}>ä¸€æ‹¬å‰Šé™¤ã‚’å®Ÿè¡Œ</button></div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
